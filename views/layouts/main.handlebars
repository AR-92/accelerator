<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <link rel="icon" type="image/svg+xml" href="/images/favcon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/output.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Hyperscript -->
    <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
     <script type="text/hyperscript">
         def updateThemeIcon()
           set isDark to document.documentElement.classList.contains('dark')
           set moonSvg to '{{{icon 'moon' size='16' class='h-4 w-4'}}}'
           set sunSvg to '{{{icon 'sun' size='16' class='h-4 w-4'}}}'
           set iconElement to document.querySelector('#theme-toggle-icon')
           if iconElement
             if isDark
               set iconElement.innerHTML to moonSvg
             else
               set iconElement.innerHTML to sunSvg
             end
           end
         end

            -- Load theme from localStorage on load and update icon
            on load from document
              initializeTheme()
              initializeSidebar()
              highlightSidebarLink()
              initFilterNavScroll()
              updateFilterNavActiveState()
            end

            -- Update sidebar highlight and filter nav after HTMX swaps
            on htmx:afterSwap from document
              highlightSidebarLink()
              initFilterNavScroll()
              updateFilterNavActiveState()
            end
     </script>
</head>
<body class="h-full">
     <!-- Auth loading screen -->
     <div id="auth-loading" class="fixed inset-0 bg-background z-50 flex items-center justify-center">
         <div class="text-center">
             <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
             <p class="text-muted-foreground">Checking authentication...</p>
             <p class="text-sm text-muted-foreground mt-2">If this takes too long, <button onclick="forceLogout()" class="underline hover:text-foreground">click here to logout</button></p>
         </div>
     </div>

     <!-- Main content (hidden initially) -->
     <div id="main-content" class="min-h-screen hidden flex flex-col">
         {{> nav}}
         {{> filter-nav}}
         <div class="flex flex-1 min-h-0">
             {{> sidebar}}
             <main class="flex-1 p-2 sm:p-4 overflow-y-auto">
                 {{{body}}}
             </main>
         </div>
     </div>

     <!-- Mobile sidebar overlay -->
     <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="closeMobileSidebar()"></div>

    <!-- JavaScript Section -->
    <script>
        // Toggle action menu dropdown - supports both old and new signatures
        function toggleActionMenu(entityNameOrButton, id) {
            let entity, button;

            if (typeof entityNameOrButton === 'string') {
                // Old signature: toggleActionMenu('entity', id)
                entity = entityNameOrButton;
                button = document.querySelector(`button[onclick="toggleActionMenu('${entity}', ${id})"]`);
            } else {
                // New signature: toggleActionMenu(button)
                button = entityNameOrButton;
                entity = button.getAttribute('data-entity');
                id = button.getAttribute('data-id');
            }

            if (!entity || !id || !button) {
                console.error('Invalid parameters for toggleActionMenu');
                return;
            }

            const menu = document.getElementById(`actionMenu-${entity}-${id}`);
            if (!menu) {
                console.error(`Dropdown not found: actionMenu-${entity}-${id}`);
                return;
            }

            const allMenus = document.querySelectorAll('[id^="actionMenu-"]');

            // Close all other menus
            allMenus.forEach(m => {
                if (m !== menu) {
                    m.style.display = 'none';
                }
            });

            // Toggle current menu
            if (menu.style.display === 'none' || menu.style.display === '') {
                // Show menu to get dimensions
                menu.style.display = 'block';
                menu.style.position = 'fixed';
                menu.style.zIndex = '9999';
                menu.style.visibility = 'hidden';

                // Force reflow to get accurate dimensions
                menu.offsetWidth;

                // Position the menu next to the button
                const rect = button.getBoundingClientRect();
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;

                // Position below the button, aligned to the right
                let top = rect.bottom + window.scrollY + 5;
                let left = rect.right + window.scrollX - menuWidth;

                // If it would go off-screen to the left, position to the right of button
                if (left < 0) {
                    left = rect.right + window.scrollX;
                }

                // If it would go off-screen to the bottom, position above button
                if (top + menuHeight > window.scrollY + window.innerHeight) {
                    top = rect.top + window.scrollY - menuHeight - 5;
                }

                // Apply final position
                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;
                menu.style.visibility = 'visible';
            } else {
                menu.style.display = 'none';
            }
        }

        // Toggle user menu dropdown
        function toggleUserMenu() {
            const menu = document.getElementById('admin-user-dropdown');
            const isHidden = menu.classList.contains('hidden');
            if (isHidden) {
                menu.classList.remove('hidden');
                setTimeout(() => menu.classList.remove('opacity-0', 'invisible'), 10);
            } else {
                menu.classList.add('opacity-0', 'invisible');
                setTimeout(() => menu.classList.add('hidden'), 200);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.relative') && !event.target.closest('#admin-user-menu') && !event.target.closest('[id^="actionMenu-"]') && !event.target.closest('button[onclick*="toggleActionMenu"]')) {
                // Close action menus
                document.querySelectorAll('[id^="actionMenu-"]').forEach(menu => {
                    menu.style.display = 'none';
                });
                // Close other dropdowns
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (!menu.id.startsWith('actionMenu-')) {
                        menu.classList.add('hidden');
                    }
                });
                const userMenu = document.getElementById('admin-user-dropdown');
                userMenu.classList.add('opacity-0', 'invisible');
                setTimeout(() => userMenu.classList.add('hidden'), 200);
            }
        });

        // Handle checkbox selection for bulk actions
        document.addEventListener('change', function (event) {
            if (event.target.classList.contains('todoCheckbox') || event.target.id === 'selectAll') {
                const checkboxes = document.querySelectorAll('.todoCheckbox');
                const selectedCheckboxes = document.querySelectorAll('.todoCheckbox:checked');
                const bulkActions = document.getElementById('bulkActions');
                const selectedCount = document.getElementById('selectedCount');

                if (event.target.id === 'selectAll') {
                    checkboxes.forEach(cb => cb.checked = event.target.checked);
                }

                const count = selectedCheckboxes.length;
                selectedCount.textContent = `${count} todo${count !== 1 ? 's' : ''} selected`;

                if (count > 0) {
                    bulkActions.style.display = 'block';
                } else {
                    bulkActions.style.display = 'none';
                }

                // Enable/disable bulk action buttons
                const bulkCompleteBtn = document.getElementById('bulkCompleteBtn');
                const bulkPendingBtn = document.getElementById('bulkPendingBtn');
                const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

                bulkCompleteBtn.disabled = count === 0;
                bulkPendingBtn.disabled = count === 0;
                bulkDeleteBtn.disabled = count === 0;
            }
        });

        // Bulk actions
        function bulkMarkComplete() {
            const selectedIds = Array.from(document.querySelectorAll('.todoCheckbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) return;

            selectedIds.forEach(id => {
                htmx.ajax('PUT', `/api/todos/${id}?completed=true`, {
                    target: `#todo-row-${id}`,
                    swap: 'outerHTML'
                });
            });
        }

        function bulkMarkPending() {
            const selectedIds = Array.from(document.querySelectorAll('.todoCheckbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) return;

            selectedIds.forEach(id => {
                htmx.ajax('PUT', `/api/todos/${id}?completed=false`, {
                    target: `#todo-row-${id}`,
                    swap: 'outerHTML'
                });
            });
        }

        function bulkDelete() {
            const selectedIds = Array.from(document.querySelectorAll('.todoCheckbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) return;

            if (confirm(`Are you sure you want to delete ${selectedIds.length} todo${selectedIds.length !== 1 ? 's' : ''}?`)) {
                selectedIds.forEach(id => {
                    htmx.ajax('DELETE', `/api/todos/${id}`, {
                        target: `#todo-row-${id}`,
                        swap: 'outerHTML'
                    });
                });
            }
        }

        // Individual actions
        function editTodo(id) {
            // This would open an edit modal or navigate to edit page
            window.location.href = `/todos/${id}/edit`;
        }

        function toggleStatus(id, status) {
            const completed = status === 'completed';
            htmx.ajax('PUT', `/api/todos/${id}?completed=${completed}`, {
                target: `#todo-row-${id}`,
                swap: 'outerHTML'
            });
        }

        function deleteTodo(id, title) {
            if (confirm(`Are you sure you want to delete "${title}"?`)) {
                htmx.ajax('DELETE', `/api/todos/${id}`, {
                    target: `#todo-row-${id}`,
                    swap: 'outerHTML'
                });
            }
        }

         // User actions
         function openCreateUserModal() {
             document.getElementById('createUserModal').classList.remove('hidden');
         }

         function editUser(id) {
             // Fetch user data and populate modal
             fetch(`/api/users/${id}`)
                 .then(response => response.json())
                 .then(user => {
                     document.getElementById('editUserId').value = user.id;
                     document.getElementById('editUserName').value = user.display_name || '';
                     document.getElementById('editUserEmail').value = user.username || '';
                     document.getElementById('editUserStatus').value = user.is_verified ? 'active' : 'inactive';
                     document.getElementById('editUserForm').setAttribute('hx-put', `/api/users/${id}`);
                     document.getElementById('editUserForm').setAttribute('hx-target', `#user-row-${id}`);
                     document.getElementById('editUserModal').classList.remove('hidden');
                 })
                 .catch(error => console.error('Error fetching user:', error));
         }

        function deleteUser(id, title) {
            if (confirm(`Are you sure you want to delete "${title}"?`)) {
                htmx.ajax('DELETE', `/api/users/${id}`, {
                    target: `#user-row-${id}`,
                    swap: 'outerHTML'
                });
            }
        }

         function toggleUserStatus(id, currentStatus) {
             const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
             htmx.ajax('PUT', `/api/users/${id}?status=${newStatus}`, {
                 target: `#user-row-${id}`,
                 swap: 'outerHTML'
             });
         }

          // Idea actions
          function openCreateIdeaModal() {
              fetch('/api/ideas/new')
                  .then(response => response.text())
                  .then(html => {
                      document.body.insertAdjacentHTML('beforeend', html);
                      const modal = document.querySelector('[data-modal-backdrop]');
                      if (modal) {
                          modal.classList.remove('hidden');
                          modal.setAttribute('aria-hidden', 'false');
                      }
                  })
                  .catch(error => console.error('Error loading create idea modal:', error));
          }

         function approveIdea(id) {
             htmx.ajax('PUT', `/api/ideas/${id}?status=approved`, {
                 target: `#idea-row-${id}`,
                 swap: 'outerHTML'
             });
         }

         function rejectIdea(id) {
             htmx.ajax('PUT', `/api/ideas/${id}?status=rejected`, {
                 target: `#idea-row-${id}`,
                 swap: 'outerHTML'
             });
         }


        // Create todo modal (placeholder)
        function openCreateTodoModal() {
            // This would open a modal for creating todos
        }

        // Export functionality (placeholder)
        function exportToCSV() {
            // Export to CSV functionality would be implemented here
        }

        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isCollapsed = sidebar.classList.contains('w-16');

            if (isCollapsed) {
                sidebar.classList.remove('w-16');
                sidebar.classList.add('w-56');
                document.querySelectorAll('.sidebar-text').forEach(el => el.style.display = 'flex');
                // Restore normal padding and margins for expanded state
                document.querySelectorAll('#sidebar a').forEach(link => {
                    link.classList.remove('px-1', 'justify-center');
                    link.classList.add('px-3');
                });
                document.querySelectorAll('#sidebar svg').forEach(icon => {
                    icon.classList.add('mr-3');
                });
            } else {
                sidebar.classList.remove('w-56');
                sidebar.classList.add('w-16');
                document.querySelectorAll('.sidebar-text').forEach(el => el.style.display = 'none');
                // Adjust padding for collapsed state and remove margins
                document.querySelectorAll('#sidebar a').forEach(link => {
                    link.classList.remove('px-3');
                    link.classList.add('px-1', 'justify-center');
                });
                document.querySelectorAll('#sidebar svg').forEach(icon => {
                    icon.classList.remove('mr-3');
                });
            }

            // Save state to localStorage
            localStorage.setItem('sidebarCollapsed', !isCollapsed);
        }

        // Initialize sidebar state on load
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

            if (isCollapsed) {
                sidebar.classList.remove('w-56');
                sidebar.classList.add('w-16');
                document.querySelectorAll('.sidebar-text').forEach(el => el.style.display = 'none');
                // Apply collapsed padding and remove margins
                document.querySelectorAll('#sidebar a').forEach(link => {
                    link.classList.remove('px-3');
                    link.classList.add('px-1', 'justify-center');
                });
                document.querySelectorAll('#sidebar svg').forEach(icon => {
                    icon.classList.remove('mr-3');
                });
            } else {
                document.querySelectorAll('.sidebar-text').forEach(el => el.style.display = 'flex');
            }
        }

        // Mobile sidebar functions
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-sidebar-overlay');

            if (!sidebar || !overlay) {
                console.error('Sidebar or overlay elements not found');
                return;
            }

            const isOpen = sidebar.classList.contains('translate-x-0') && sidebar.classList.contains('opacity-100');

            if (isOpen) {
                closeMobileSidebar();
            } else {
                sidebar.classList.remove('opacity-0');
                sidebar.classList.add('opacity-100');
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                sidebar.classList.remove('pointer-events-none');
                sidebar.classList.add('pointer-events-auto');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-sidebar-overlay');

            if (!sidebar || !overlay) {
                console.error('Sidebar or overlay elements not found');
                return;
            }

            sidebar.classList.remove('opacity-100');
            sidebar.classList.add('opacity-0');
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('pointer-events-auto');
            sidebar.classList.add('pointer-events-none');
            overlay.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scroll
        }

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            const themeIcon = document.getElementById('theme-icon');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                // Change to sun icon
                themeIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                    <circle cx="12" cy="12" r="4"/>
                    <path d="M12 4h.01"/>
                    <path d="M20 12h.01"/>
                    <path d="M12 20h.01"/>
                    <path d="M4 12h.01"/>
                    <path d="M17.657 6.343h.01"/>
                    <path d="M17.657 17.657h.01"/>
                    <path d="M6.343 17.657h.01"/>
                    <path d="M6.343 6.343h.01"/>
                </svg>`;
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                // Change to moon icon
                themeIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                    <path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/>
                </svg>`;
            }
        }

        // Initialize theme on load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('theme-icon');

            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                // Set moon icon
                themeIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                    <path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/>
                </svg>`;
            } else {
                // Set sun icon (default)
                themeIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                    <circle cx="12" cy="12" r="4"/>
                    <path d="M12 4h.01"/>
                    <path d="M20 12h.01"/>
                    <path d="M12 20h.01"/>
                    <path d="M4 12h.01"/>
                    <path d="M17.657 6.343h.01"/>
                    <path d="M17.657 17.657h.01"/>
                    <path d="M6.343 17.657h.01"/>
                    <path d="M6.343 6.343h.01"/>
                </svg>`;
            }
        }

        // Highlight current sidebar link
        function highlightSidebarLink() {
            const currentPath = window.location.pathname;
            const sidebarLinks = document.querySelectorAll('#sidebar a');
            sidebarLinks.forEach(link => {
                link.classList.remove('bg-accent', 'text-foreground', 'font-bold');
                link.classList.add('text-muted-foreground');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('bg-accent', 'text-foreground', 'font-bold');
                    link.classList.remove('text-muted-foreground');
                }
            });
        }

        // Filter nav scroll functionality
        function initFilterNavScroll() {
            // Settings filter scroll
            const settingsLeft = document.getElementById('settings-filter-scroll-left');
            const settingsRight = document.getElementById('settings-filter-scroll-right');
            const settingsContainer = document.getElementById('settings-filter-scroll-container');

            if (settingsLeft && settingsRight && settingsContainer) {
                settingsLeft.addEventListener('click', () => {
                    settingsContainer.scrollBy({ left: -200, behavior: 'smooth' });
                });
                settingsRight.addEventListener('click', () => {
                    settingsContainer.scrollBy({ left: 200, behavior: 'smooth' });
                });
            }

            // Table filter scroll
            const tableLeft = document.getElementById('table-filter-scroll-left');
            const tableRight = document.getElementById('table-filter-scroll-right');
            const tableContainer = document.getElementById('table-filter-scroll-container');

            if (tableLeft && tableRight && tableContainer) {
                tableLeft.addEventListener('click', () => {
                    tableContainer.scrollBy({ left: -200, behavior: 'smooth' });
                });
                tableRight.addEventListener('click', () => {
                    tableContainer.scrollBy({ left: 200, behavior: 'smooth' });
                });
            }

            // Overview filter scroll
            const overviewLeft = document.getElementById('overview-filter-scroll-left');
            const overviewRight = document.getElementById('overview-filter-scroll-right');
            const overviewContainer = document.getElementById('overview-filter-scroll-container');

            if (overviewLeft && overviewRight && overviewContainer) {
                overviewLeft.addEventListener('click', () => {
                    overviewContainer.scrollBy({ left: -200, behavior: 'smooth' });
                });
                overviewRight.addEventListener('click', () => {
                    overviewContainer.scrollBy({ left: 200, behavior: 'smooth' });
                });
            }
        }

        // Update filter nav active state
        function updateFilterNavActiveState() {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');

            // Update table filter active state
            const tableFilterButtons = document.querySelectorAll('#table-filter-scroll-container button');
            tableFilterButtons.forEach(button => {
                button.classList.remove('text-foreground', 'font-medium');
                button.classList.add('text-muted-foreground');
            });

            if (!status) {
                // "All" is active
                const allButton = document.getElementById('filter-link-all');
                if (allButton) {
                    allButton.classList.remove('text-muted-foreground');
                    allButton.classList.add('text-foreground', 'font-medium');
                }
            } else {
                // Find the button with matching status
                const activeButton = document.querySelector(`#table-filter-scroll-container button[id="filter-link-${status}"]`);
                if (activeButton) {
                    activeButton.classList.remove('text-muted-foreground');
                    activeButton.classList.add('text-foreground', 'font-medium');
                }
            }

            // Update border indicators
            const tableFilterDivs = document.querySelectorAll('#table-filter-scroll-container > div');
            tableFilterDivs.forEach(div => {
                const borderDiv = div.querySelector('div:first-child');
                if (borderDiv) {
                    borderDiv.classList.remove('opacity-100');
                    borderDiv.classList.add('opacity-0', 'group-hover:opacity-100');
                }
            });

            if (!status) {
                const allDiv = document.querySelector('#table-filter-scroll-container > div:first-child');
                if (allDiv) {
                    const borderDiv = allDiv.querySelector('div:first-child');
                    if (borderDiv) {
                        borderDiv.classList.remove('opacity-0', 'group-hover:opacity-100');
                        borderDiv.classList.add('opacity-100');
                    }
                }
            } else {
                const activeDiv = document.querySelector(`#table-filter-scroll-container button[id="filter-link-${status}"]`)?.closest('div');
                if (activeDiv) {
                    const borderDiv = activeDiv.querySelector('div:first-child');
                    if (borderDiv) {
                        borderDiv.classList.remove('opacity-0', 'group-hover:opacity-100');
                        borderDiv.classList.add('opacity-100');
                    }
                }
            }
        }

        // Force logout function for stuck authentication (global scope)
        async function forceLogout() {
            console.log('Force logout triggered');
            try {
                // Properly sign out from Supabase
                if (supabase) {
                    await supabase.auth.signOut();
                    console.log('Successfully signed out from Supabase');
                }
            } catch (error) {
                console.error('Error during force logout:', error);
            }

            // Clear any cached data as fallback
            if (typeof localStorage !== 'undefined') {
                localStorage.clear();
            }
            if (typeof sessionStorage !== 'undefined') {
                sessionStorage.clear();
            }

            // Redirect to login
            window.location.href = '/auth';
        }

    </script>

    <!-- Filter functionality -->
    <script src="/js/filters.js"></script>

    <!-- Supabase Auth -->
    <script>
        let supabase = null;

        function initSupabase() {
            if (window.supabase && !supabase) {
                try {
                    // Initialize Supabase client
                    const supabaseUrl = 'https://wgmuxgylmvrsttdxwarw.supabase.co';
                    const supabaseKey = 'sb_publishable_OvwrqcwJptCiC-Dz-_eSVg_hAVtpZJI';
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabase client initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize Supabase client:', error);
                }
            } else if (!window.supabase) {
                console.log('Supabase script not loaded yet');
            }
        }

        // Initialize Supabase when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initSupabase();
            // Also try to initialize after a short delay in case the script loads later
            setTimeout(initSupabase, 1000);
        });

        // Function to update user info in nav
        function updateUserInfo(user) {
            const userNameElement = document.getElementById('user-name');
            if (userNameElement) {
                if (user) {
                    const displayName = user.user_metadata?.firstName
                        ? `${user.user_metadata.firstName} ${user.user_metadata.lastName || ''}`.trim()
                        : user.email || 'User';
                    userNameElement.textContent = displayName;
                } else {
                    userNameElement.textContent = 'Not logged in';
                }
            }
        }

        // Check auth state on page load
        function setupAuthListeners() {
            if (!supabase) {
                initSupabase();
            }

            if (supabase) {
                supabase.auth.onAuthStateChange((event, session) => {
                    console.log('Auth state changed:', event, session ? 'session exists' : 'no session', session?.user ? 'with user' : 'no user');
                    updateUserInfo(session?.user);
                    if (event === 'SIGNED_OUT') {
                        console.log('User signed out, redirecting to login');
                        showToast('You have been logged out', 'info');
                        window.location.href = '/auth';
                    } else if (!session || !session.user) {
                        // User is not authenticated
                        if (window.location.pathname.startsWith('/admin')) {
                            console.log('No session found, redirecting to login');
                            window.location.href = '/auth';
                        }
                    }
                });

                // Check current session immediately
                supabase.auth.getSession().then(({ data: { session } }) => {
                    console.log('Initial session check:', session ? 'session exists' : 'no session', session?.user ? 'with user' : 'no user');
                    updateUserInfo(session?.user);
                    if (!session || !session.user) {
                        if (window.location.pathname.startsWith('/admin')) {
                            console.log('No session found, redirecting to login');
                            setTimeout(() => window.location.href = '/auth', 100);
                        }
                    }
                }).catch(error => {
                    console.error('Session check error:', error);
                    if (window.location.pathname.startsWith('/admin')) {
                        setTimeout(() => window.location.href = '/auth', 100);
                    }
                });
            }
        }

        // Logout function
        async function handleLogout() {
            try {
                showToast('Logging out...', 'info');

                if (supabase) {
                    // Sign out from Supabase
                    let { error } = await supabase.auth.signOut();
                    if (error) {
                        console.error('Logout error:', error);
                        showToast('Logout error: ' + error.message, 'error');
                    } else {
                        console.log('Successfully signed out from Supabase');
                        showToast('Logged out successfully', 'success');
                    }
                }

                // Clear any cached data
                if (typeof localStorage !== 'undefined') {
                    localStorage.clear();
                }
                if (typeof sessionStorage !== 'undefined') {
                    sessionStorage.clear();
                }

                // Redirect to login page immediately
                window.location.href = '/auth';
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Logout failed', 'error');
                // Still redirect even if there's an error
                window.location.href = '/auth';
            }
        }

        // Check auth and show content with retry logic
        async function checkAuthAndShowContent(retryCount = 0) {
            const authLoading = document.getElementById('auth-loading');
            const mainContent = document.getElementById('main-content');
            const maxRetries = 10;

            if (window.location.pathname.startsWith('/admin')) {
                // For admin pages, check authentication
                if (supabase) {
                    try {
                        console.log('Checking authentication session...');
                        const { data: { session }, error } = await supabase.auth.getSession();

                        if (error) {
                            console.error('Auth check error:', error);
                            // Check if it's a network error
                            if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('Failed to fetch') || !navigator.onLine) {
                                showToast('Network connection issue. Please check your internet connection and try again.', 'error');
                                // Show retry option
                                setTimeout(() => {
                                    if (confirm('Network error detected. Would you like to retry?')) {
                                        window.location.reload();
                                    } else {
                                        window.location.href = '/auth';
                                    }
                                }, 2000);
                            } else {
                                console.log('Auth error, redirecting to login');
                                window.location.href = '/auth';
                            }
                            return;
                        }

                        if (!session || !session.user) {
                            console.log('No session found, redirecting to login');
                            window.location.href = '/auth';
                            return;
                        }

                        // User is authenticated, show content
                        console.log('User authenticated, showing admin content');
                        authLoading.classList.add('hidden');
                        mainContent.classList.remove('hidden');

                        // Setup auth listeners for ongoing monitoring
                        setupAuthListeners();
                    } catch (error) {
                        console.error('Auth check failed:', error);
                        // Check if it's a network error
                        if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('Failed to fetch') || !navigator.onLine) {
                            showToast('Network connection issue. Please check your internet connection and try again.', 'error');
                            // Show retry option
                            setTimeout(() => {
                                if (confirm('Network error detected. Would you like to retry?')) {
                                    window.location.reload();
                                } else {
                                    window.location.href = '/auth';
                                }
                            }, 2000);
                        } else {
                            console.log('Auth check exception, redirecting to login');
                            window.location.href = '/auth';
                        }
                    }
                } else {
                    // Supabase not loaded yet, retry
                    if (retryCount < maxRetries) {
                        console.log(`Supabase not ready, retrying... (${retryCount + 1}/${maxRetries})`);
                        setTimeout(() => checkAuthAndShowContent(retryCount + 1), 500);
                    } else {
                        console.log('Supabase failed to load after max retries, redirecting');
                        showToast('Authentication service failed to load. Please refresh the page.', 'error');
                        setTimeout(() => window.location.href = '/auth', 2000);
                    }
                }
            } else {
                // For non-admin pages, show content immediately
                authLoading.classList.add('hidden');
                mainContent.classList.remove('hidden');
                setupAuthListeners();
            }
        }

        // Session timeout configuration
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds
        let lastActivity = Date.now();

        // Function to update last activity
        function updateActivity() {
            lastActivity = Date.now();
        }

        // Function to check for session timeout
        function checkSessionTimeout() {
            const now = Date.now();
            if (now - lastActivity > SESSION_TIMEOUT) {
                console.log('Session timeout reached, logging out');
                showToast('Your session has expired due to inactivity. Please log in again.', 'info');
                handleLogout();
            }
        }

        // Set up activity listeners
        function setupActivityListeners() {
            // List of events that indicate user activity
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

            events.forEach(event => {
                document.addEventListener(event, updateActivity, true);
            });

            // Check for timeout every minute
            setInterval(checkSessionTimeout, 60 * 1000);
        }

        // Check auth on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkAuthAndShowContent, 100); // Small delay for Supabase to load
            setupActivityListeners(); // Set up activity tracking
            initFilterNavScroll(); // Initialize filter nav scroll
            updateFilterNavActiveState(); // Update filter nav active state
        });

        // Handle browser back/forward navigation for table filters
        window.addEventListener('popstate', function () {
            updateFilterNavActiveState();
        });
    </script>

    <!-- Toast notifications -->
    {{> toast}}
</body>
</html>
