<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <link rel="icon" type="image/svg+xml" href="/images/favcon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/output.css">
    <!-- Supabase configuration -->
    {{#if supabaseUrl}}
    <meta name="supabase-url" content="{{supabaseUrl}}">
    {{/if}}
    {{#if supabaseKey}}
    <meta name="supabase-key" content="{{supabaseKey}}">
    {{/if}}
     <!-- HTMX -->
     <script src="https://unpkg.com/htmx.org@1.9.10"></script>
     <!-- Hyperscript -->
     <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
      <!-- Supabase -->
      <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
      <script src="/js/supabase-cookie-storage.js"></script>
     <!-- Animate.css -->
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
     <script type="text/hyperscript">
         def updateThemeIcon()
           set isDark to document.documentElement.classList.contains('dark')
           set moonSvg to '{{{icon "moon" size="16" class="h-4 w-4"}}}'
           set sunSvg to '{{{icon "sun" size="16" class="h-4 w-4"}}}'
           set iconElement to document.querySelector('#theme-toggle-icon')
           if iconElement
             if isDark
               set iconElement.innerHTML to moonSvg
             else
               set iconElement.innerHTML to sunSvg
             end
           end
         end

            -- Load theme from localStorage on load and update icon
            on load from document
              initializeTheme()
              initializeSidebar()
              highlightSidebarLink()
              initFilterNavScroll()
              updateFilterNavActiveState()
            end

            -- Update sidebar highlight and filter nav after HTMX swaps
            on htmx:afterSwap from document
              highlightSidebarLink()
              initFilterNavScroll()
              updateFilterNavActiveState()
            end
     </script>
</head>
<body class="h-full overflow-hidden">
     <!-- Auth loading screen -->
     <div id="auth-loading" class="fixed inset-0 bg-background z-50 flex items-center justify-center">
         <div class="text-center">
             <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
             <p class="text-muted-foreground">Checking authentication...</p>
             <p class="text-sm text-muted-foreground mt-2">If this takes too long, <button onclick="forceLogout()" class="underline hover:text-foreground">click here to logout</button></p>
         </div>
     </div>

      <!-- Main content (hidden initially) -->
      <div id="main-content" class="h-screen hidden flex flex-col">
         {{> nav}}
         {{> filter-nav}}
         <div class="flex flex-1 min-h-0">
             {{> sidebar}}
             <main class="flex-1 p-2 sm:p-4 overflow-y-auto">
                  {{{body}}}
             </main>
         </div>
     </div>

     <!-- Mobile sidebar overlay -->
     <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="closeMobileSidebar()"></div>

    <!-- JavaScript Section -->
    <script>
        // Toggle action menu dropdown - consistent signature using button element
        function toggleActionMenu(button) {
            const entity = button.getAttribute('data-entity');
            const id = button.getAttribute('data-id');

            if (!entity || !id || !button) {
                console.error('Invalid parameters for toggleActionMenu');
                return;
            }

            const menu = document.getElementById(`actionMenu-${entity}-${id}`);
            if (!menu) {
                console.error(`Dropdown not found: actionMenu-${entity}-${id}`);
                return;
            }

            const allMenus = document.querySelectorAll('[id^="actionMenu-"]');

            // Close all other menus
            allMenus.forEach(m => {
                if (m !== menu) {
                    m.style.display = 'none';
                }
            });

            // Toggle current menu
            if (menu.style.display === 'none' || menu.style.display === '') {
                // Show menu to get dimensions
                menu.style.display = 'block';
                menu.style.position = 'fixed';
                menu.style.zIndex = '9999';
                menu.style.visibility = 'hidden';

                // Force reflow to get accurate dimensions
                menu.offsetWidth;

                // Position the menu next to the button
                const rect = button.getBoundingClientRect();
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;

                // Position below the button, aligned to the right
                let top = rect.bottom + window.scrollY + 5;
                let left = rect.right + window.scrollX - menuWidth;

                // If it would go off-screen to the left, position to the right of button
                if (left < 0) {
                    left = rect.right + window.scrollX;
                }

                // If it would go off-screen to the bottom, position above button
                if (top + menuHeight > window.scrollY + window.innerHeight) {
                    top = rect.top + window.scrollY - menuHeight - 5;
                }

                // Apply final position
                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;
                menu.style.visibility = 'visible';
            } else {
                menu.style.display = 'none';
            }
        }

        // Toggle user menu dropdown
        function toggleUserMenu() {
            const menu = document.getElementById('admin-user-dropdown');
            const isHidden = menu.classList.contains('hidden');
            if (isHidden) {
                menu.classList.remove('hidden');
                setTimeout(() => menu.classList.remove('opacity-0', 'invisible'), 10);
            } else {
                menu.classList.add('opacity-0', 'invisible');
                setTimeout(() => menu.classList.add('hidden'), 200);
            }
        }

        // Toggle grid menu dropdown
        function toggleGridMenu() {
            const menu = document.getElementById('grid-dropdown');
            const isHidden = menu.classList.contains('hidden');
            if (isHidden) {
                menu.classList.remove('hidden');
                setTimeout(() => menu.classList.remove('opacity-0', 'invisible'), 10);
            } else {
                menu.classList.add('opacity-0', 'invisible');
                setTimeout(() => menu.classList.add('hidden'), 200);
            }
        }

        // Toggle footer dropdown
        function toggleFooterDropdown() {
            const menu = document.getElementById('footer-dropdown-menu');
            const isHidden = menu.classList.contains('hidden');
            if (isHidden) {
                menu.classList.remove('hidden');
                setTimeout(() => menu.classList.remove('opacity-0', 'invisible'), 10);
            } else {
                menu.classList.add('opacity-0', 'invisible');
                setTimeout(() => menu.classList.add('hidden'), 200);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.relative') && !event.target.closest('#admin-user-menu') && !event.target.closest('#grid-menu') && !event.target.closest('[id^="actionMenu-"]') && !event.target.closest('button[onclick*="toggleActionMenu"]') && !event.target.closest('#footer-dropdown-trigger') && !event.target.closest('#footer-dropdown-menu')) {
                // Close action menus
                document.querySelectorAll('[id^="actionMenu-"]').forEach(menu => {
                    menu.style.display = 'none';
                });
                // Close other dropdowns
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (!menu.id.startsWith('actionMenu-')) {
                        menu.classList.add('hidden');
                    }
                });
                const userMenu = document.getElementById('admin-user-dropdown');
                userMenu.classList.add('opacity-0', 'invisible');
                setTimeout(() => userMenu.classList.add('hidden'), 200);
                const gridMenu = document.getElementById('grid-dropdown');
                gridMenu.classList.add('opacity-0', 'invisible');
                setTimeout(() => gridMenu.classList.add('hidden'), 200);
                // Close footer dropdown
                const footerMenu = document.getElementById('footer-dropdown-menu');
                footerMenu.classList.add('opacity-0', 'invisible');
                setTimeout(() => footerMenu.classList.add('hidden'), 200);
            }
        });

        // Handle checkbox selection for bulk actions
        document.addEventListener('change', function (event) {
            if (event.target.classList.contains('todoCheckbox') || event.target.id === 'selectAll') {
                const checkboxes = document.querySelectorAll('.todoCheckbox');
                const selectedCheckboxes = document.querySelectorAll('.todoCheckbox:checked');
                const bulkActions = document.getElementById('bulkActions');
                const selectedCount = document.getElementById('selectedCount');

                if (event.target.id === 'selectAll') {
                    checkboxes.forEach(cb => cb.checked = event.target.checked);
                }

                const count = selectedCheckboxes.length;
                selectedCount.textContent = `${count} todo${count !== 1 ? 's' : ''} selected`;

                if (count > 0) {
                    bulkActions.style.display = 'block';
                } else {
                    bulkActions.style.display = 'none';
                }

                // Enable/disable bulk action buttons
                const bulkCompleteBtn = document.getElementById('bulkCompleteBtn');
                const bulkPendingBtn = document.getElementById('bulkPendingBtn');
                const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

                bulkCompleteBtn.disabled = count === 0;
                bulkPendingBtn.disabled = count === 0;
                bulkDeleteBtn.disabled = count === 0;
            }
        });

        // Bulk actions
        function bulkMarkComplete() {
            const selectedIds = Array.from(document.querySelectorAll('.todoCheckbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) return;

            selectedIds.forEach(id => {
                htmx.ajax('PUT', `/api/todos/${id}?completed=true`, {
                    target: `#todo-row-${id}`,
                    swap: 'outerHTML'
                });
            });
        }

        function bulkMarkPending() {
            const selectedIds = Array.from(document.querySelectorAll('.todoCheckbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) return;

            selectedIds.forEach(id => {
                htmx.ajax('PUT', `/api/todos/${id}?completed=false`, {
                    target: `#todo-row-${id}`,
                    swap: 'outerHTML'
                });
            });
        }

        function bulkDelete() {
            const selectedIds = Array.from(document.querySelectorAll('.todoCheckbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) return;

            if (confirm(`Are you sure you want to delete ${selectedIds.length} todo${selectedIds.length !== 1 ? 's' : ''}?`)) {
                selectedIds.forEach(id => {
                    htmx.ajax('DELETE', `/api/todos/${id}`, {
                        target: `#todo-row-${id}`,
                        swap: 'outerHTML'
                    });
                });
            }
        }

        // Individual actions
        function editTodo(id) {
            // This would open an edit modal or navigate to edit page
            window.location.href = `/todos/${id}/edit`;
        }

        function toggleStatus(id, status) {
            const completed = status === 'completed';
            htmx.ajax('PUT', `/api/todos/${id}?completed=${completed}`, {
                target: `#todo-row-${id}`,
                swap: 'outerHTML'
            });
        }

        function deleteTodo(id, title) {
            if (confirm(`Are you sure you want to delete "${title}"?`)) {
                htmx.ajax('DELETE', `/api/todos/${id}`, {
                    target: `#todo-row-${id}`,
                    swap: 'outerHTML'
                });
            }
        }

         // Create todo modal (placeholder)
        function openCreateTodoModal() {
            // This would open a modal for creating todos
        }

        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            const collapsedFooter = document.getElementById('sidebar-footer-collapsed');
            const isCollapsed = collapsedFooter && collapsedFooter.style.display !== 'none';

             if (isCollapsed) {
                 sidebar.style.width = '224px';
                 document.querySelectorAll('.sidebar-text').forEach(el => el.style.display = 'flex');
                  // Restore normal padding and margins for expanded state
                  document.querySelectorAll('#sidebar nav a').forEach(link => {
                      link.classList.remove('px-1', 'justify-center');
                      link.classList.add('px-3');
                  });
                  document.querySelectorAll('#sidebar nav svg').forEach(icon => {
                      icon.classList.add('mr-3');
                  });
                // Show expanded footer, hide collapsed footer
                const expandedFooter = document.getElementById('sidebar-footer-expanded');
                const expandedButton = document.getElementById('sidebar-footer-expanded-button');
                const collapsedFooter = document.getElementById('sidebar-footer-collapsed');
                if (expandedFooter) {
                    expandedFooter.style.display = 'flex';
                }
                if (expandedButton) {
                    expandedButton.style.display = 'block';
                }
                if (collapsedFooter) {
                    collapsedFooter.style.display = 'none';
                }
            } else {
                sidebar.style.width = '66px';
                document.querySelectorAll('.sidebar-text').forEach(el => el.style.display = 'none');
                 // Adjust padding for collapsed state and remove margins
                 document.querySelectorAll('#sidebar nav a').forEach(link => {
                     link.classList.remove('px-3');
                     link.classList.add('px-1', 'justify-center');
                 });
                 document.querySelectorAll('#sidebar nav svg').forEach(icon => {
                     icon.classList.remove('mr-3');
                 });
                // Show collapsed footer, hide expanded footer
                const expandedFooter = document.getElementById('sidebar-footer-expanded');
                const expandedButton = document.getElementById('sidebar-footer-expanded-button');
                const collapsedFooter = document.getElementById('sidebar-footer-collapsed');
                if (expandedFooter) expandedFooter.style.display = 'none';
                if (expandedButton) expandedButton.style.display = 'none';
                if (collapsedFooter) collapsedFooter.style.display = 'flex';
            }

            // Save state to localStorage
            localStorage.setItem('sidebarCollapsed', !isCollapsed);
        }

        // Initialize sidebar state on load
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

            if (isCollapsed) {
                sidebar.style.width = '66px';
                document.querySelectorAll('.sidebar-text').forEach(el => el.style.display = 'none');
                 // Apply collapsed padding and remove margins
                 document.querySelectorAll('#sidebar nav a').forEach(link => {
                     link.classList.remove('px-3');
                     link.classList.add('px-1', 'justify-center');
                 });
                 document.querySelectorAll('#sidebar nav svg').forEach(icon => {
                     icon.classList.remove('mr-3');
                 });
                // Show collapsed footer, hide expanded footer
                const expandedFooter = document.getElementById('sidebar-footer-expanded');
                const expandedButton = document.getElementById('sidebar-footer-expanded-button');
                const collapsedFooter = document.getElementById('sidebar-footer-collapsed');
                if (expandedFooter) expandedFooter.style.display = 'none';
                if (expandedButton) expandedButton.style.display = 'none';
                if (collapsedFooter) collapsedFooter.style.display = 'flex';
            } else {
                sidebar.style.width = '224px';
                document.querySelectorAll('.sidebar-text').forEach(el => el.style.display = 'flex');
                // Show expanded footer, hide collapsed footer
                const expandedFooter = document.getElementById('sidebar-footer-expanded');
                const expandedButton = document.getElementById('sidebar-footer-expanded-button');
                const collapsedFooter = document.getElementById('sidebar-footer-collapsed');
                if (expandedFooter) expandedFooter.style.display = 'flex';
                if (expandedButton) expandedButton.style.display = 'block';
                if (collapsedFooter) collapsedFooter.style.display = 'none';
            }
        }

        // Sidebar toggle for both desktop and mobile
        function toggleSidebarOrMobile() {
            if (window.innerWidth < 768) {
                toggleMobileSidebar();
            } else {
                toggleSidebar();
            }
        }

        // Mobile sidebar functions
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-sidebar-overlay');

            if (!sidebar || !overlay) {
                console.error('Sidebar or overlay elements not found');
                return;
            }

            const isOpen = sidebar.classList.contains('translate-x-0') && sidebar.classList.contains('opacity-100');

            if (isOpen) {
                closeMobileSidebar();
            } else {
                sidebar.classList.remove('opacity-0');
                sidebar.classList.add('opacity-100');
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                sidebar.classList.remove('pointer-events-none');
                sidebar.classList.add('pointer-events-auto');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-sidebar-overlay');

            if (!sidebar || !overlay) {
                console.error('Sidebar or overlay elements not found');
                return;
            }

            sidebar.classList.remove('opacity-100');
            sidebar.classList.add('opacity-0');
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('pointer-events-auto');
            sidebar.classList.add('pointer-events-none');
            overlay.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scroll
        }

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            const themeIcon = document.getElementById('theme-icon');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                // Update icon using server-rendered content
                if (themeIcon) {
                    // The icon is already rendered server-side, so just toggle classes if needed
                    // This function will work properly after initial render
                }
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                // Update icon using server-rendered content
                if (themeIcon) {
                    // The icon is already rendered server-side
                }
            }
        }

        // Initialize theme on load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');

            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // Highlight current sidebar link
        function highlightSidebarLink() {
            const currentPath = window.location.pathname;
            const sidebarLinks = document.querySelectorAll('#sidebar a');
            sidebarLinks.forEach(link => {
                link.classList.remove('bg-accent', 'text-foreground', 'font-bold');
                link.classList.add('text-muted-foreground');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('bg-accent', 'text-foreground', 'font-bold');
                    link.classList.remove('text-muted-foreground');
                }
            });
        }

         // Filter nav scroll functionality
         function initFilterNavScroll() {
             // Function to check and update chevron visibility
             function updateChevronVisibility(leftBtn, rightBtn, container) {
                 if (!leftBtn || !rightBtn || !container) return;

                 const hasOverflow = container.scrollWidth > container.clientWidth;
                 const isAtStart = container.scrollLeft <= 0;
                 const isAtEnd = container.scrollLeft >= container.scrollWidth - container.clientWidth - 1;

                 leftBtn.style.display = hasOverflow && !isAtStart ? 'flex' : 'none';
                 rightBtn.style.display = hasOverflow && !isAtEnd ? 'flex' : 'none';
             }

             // Settings filter scroll
             const settingsLeft = document.getElementById('settings-filter-scroll-left');
             const settingsRight = document.getElementById('settings-filter-scroll-right');
             const settingsContainer = document.getElementById('settings-filter-scroll-container');

             if (settingsLeft && settingsRight && settingsContainer) {
                 settingsLeft.addEventListener('click', () => {
                     settingsContainer.scrollBy({ left: -200, behavior: 'smooth' });
                     setTimeout(() => updateChevronVisibility(settingsLeft, settingsRight, settingsContainer), 300);
                 });
                 settingsRight.addEventListener('click', () => {
                     settingsContainer.scrollBy({ left: 200, behavior: 'smooth' });
                     setTimeout(() => updateChevronVisibility(settingsLeft, settingsRight, settingsContainer), 300);
                 });

                 // Initial visibility check
                 updateChevronVisibility(settingsLeft, settingsRight, settingsContainer);

                 // Update on resize
                 window.addEventListener('resize', () => updateChevronVisibility(settingsLeft, settingsRight, settingsContainer));
             }

             // Overview filter scroll
             const overviewLeft = document.getElementById('overview-filter-scroll-left');
             const overviewRight = document.getElementById('overview-filter-scroll-right');
             const overviewContainer = document.getElementById('overview-filter-scroll-container');

             if (overviewLeft && overviewRight && overviewContainer) {
                 overviewLeft.addEventListener('click', () => {
                     overviewContainer.scrollBy({ left: -200, behavior: 'smooth' });
                     setTimeout(() => updateChevronVisibility(overviewLeft, overviewRight, overviewContainer), 300);
                 });
                 overviewRight.addEventListener('click', () => {
                     overviewContainer.scrollBy({ left: 200, behavior: 'smooth' });
                     setTimeout(() => updateChevronVisibility(overviewLeft, overviewRight, overviewContainer), 300);
                 });

                 // Initial visibility check
                 updateChevronVisibility(overviewLeft, overviewRight, overviewContainer);

                 // Update on resize
                 window.addEventListener('resize', () => updateChevronVisibility(overviewLeft, overviewRight, overviewContainer));
             }
         }

        // Update filter nav active state
        function updateFilterNavActiveState() {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');


        }

        // Force logout function for stuck authentication (global scope)
        function forceLogout() {
            // Clear any cached data as fallback but preserve theme
            if (typeof localStorage !== 'undefined') {
                const savedTheme = localStorage.getItem('theme');
                const sidebarCollapsed = localStorage.getItem('sidebarCollapsed');
                localStorage.clear();
                if (savedTheme) localStorage.setItem('theme', savedTheme);
                if (sidebarCollapsed) localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
            }
            if (typeof sessionStorage !== 'undefined') {
                sessionStorage.clear();
            }

            // Redirect to login
            window.location.href = '/auth';
        }

     </script>

     <!-- Client-side auth check for UI - server handles actual route protection -->
     <script>
        // Initialize Supabase client
        let supabase = null;
        function initSupabase() {
            if (window.supabase && !supabase) {
                // Extract Supabase config from environment variables or meta tags
                const supabaseUrl = document.querySelector('meta[name="supabase-url"]')?.content || '{{{supabaseUrl}}}';
                const supabaseKey = document.querySelector('meta[name="supabase-key"]')?.content || '{{{supabaseKey}}}';

                console.log('Dashboard: Initializing Supabase with URL:', supabaseUrl, 'Key exists:', !!supabaseKey);

                if (supabaseUrl && supabaseKey) {
                    try {
                        // Use cookie storage for SSR compatibility
                        const cookieStorage = new window.CookieStorage();
                        supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
                            auth: {
                                storage: cookieStorage,
                                autoRefreshToken: true,
                                persistSession: true
                            }
                        });
                        console.log('Dashboard: Supabase client created successfully');
                    } catch (error) {
                        console.error('Dashboard: Failed to create Supabase client:', error);
                    }
                } else {
                    console.error('Dashboard: Missing Supabase configuration');
                }
            }
        }

        // Check auth state and display appropriate UI
        document.addEventListener('DOMContentLoaded', async () => {
            const authLoading = document.getElementById('auth-loading');
            const mainContent = document.getElementById('main-content');

            try {
                // Check auth state with retry logic (similar to login page)
                let authCheckAttempts = 0;
                const maxAuthCheckAttempts = 5;
                let redirecting = false; // Prevent multiple redirects

                const checkAuthStatus = async () => {
                    authCheckAttempts++;
                    console.log(`Dashboard auth check attempt ${authCheckAttempts}/${maxAuthCheckAttempts}`);

                    // Ensure Supabase is initialized
                    if (window.supabase && !supabase) {
                        initSupabase();
                        console.log('Dashboard: Supabase initialized');
                    }

                    // First try server-side session check (works with server-side login)
                    try {
                        console.log('Dashboard: Checking server session...');
                        const serverResponse = await fetch('/auth/session', {
                            method: 'GET',
                            credentials: 'include'  // Include cookies for session validation
                        });

                        const serverResult = await serverResponse.json();
                        console.log('Dashboard: Server session result:', serverResult);

                        if (serverResult.authenticated) {
                            // Server says we're authenticated, continue
                            console.log('Dashboard: Authenticated via server session');
                            return;
                        }
                    } catch (e) {
                        console.log('Dashboard: Server session check failed:', e);
                    }

                    // Server says not authenticated, check Supabase client-side
                    if (window.supabase && supabase) {
                        try {
                            console.log('Dashboard: Checking Supabase session...');
                            // Try to get current session
                            const { data: { session }, error } = await supabase.auth.getSession();
                            console.log('Dashboard: Supabase session result:', { session: !!session, error: error?.message });

                            if (!error && session && session.user) {
                                // Session found, continue
                                console.log('Dashboard: Authenticated via Supabase session');
                                return;
                            }
                        } catch (e) {
                            console.log('Dashboard: Supabase getSession error:', e);
                        }
                    } else {
                        console.log('Dashboard: Supabase not available or not initialized');
                    }

                    // If we get here, not authenticated
                    if (authCheckAttempts < maxAuthCheckAttempts) {
                        // Try again after a longer delay
                        console.log(`Dashboard: Retrying in 500ms...`);
                        setTimeout(checkAuthStatus, 500);
                    } else {
                        // Max attempts reached, redirect to auth
                        if (!redirecting) {
                            console.log('Dashboard: Max attempts reached, redirecting to auth');
                            redirecting = true;
                            window.location.href = '/auth';
                        }
                    }
                };

                // Start the auth check with longer initial delay
                console.log('Dashboard: Starting auth check in 1000ms...');
                setTimeout(checkAuthStatus, 1000);

                // Fallback: show main content after 10 seconds if auth check doesn't complete
                setTimeout(() => {
                    if (authLoading && mainContent && !mainContent.classList.contains('hidden')) {
                        console.log('Dashboard: Auth check timeout, showing main content');
                        authLoading.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                    }
                }, 10000);

                // We have a valid session, continue to load main content
                authLoading.classList.add('hidden');
                mainContent.classList.remove('hidden');
            } catch (error) {
                console.error('Auth check error:', error);
                // If auth check fails, redirect to login as fallback
                window.location.href = '/auth';
                return;
            }

            // Simple activity tracking
            let lastActivity = Date.now();
            const ACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes

            // Update last activity
            function updateActivity() {
                lastActivity = Date.now();
            }

            // Set up activity listeners
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            events.forEach(event => {
                document.addEventListener(event, updateActivity, true);
            });

            // Check for session timeout (disabled for now)
            /*
            setInterval(() => {
                const now = Date.now();
                if (now - lastActivity > ACTIVITY_TIMEOUT) {
                    // Show timeout message and redirect to login
                    if (typeof showToast !== 'undefined') {
                        showToast('Your session has expired due to inactivity. Please log in again.', 'info');
                    }
                    window.location.href = '/auth';
                }
            }, 60 * 1000); // Check every minute
            */

            // Initialize UI components
            initFilterNavScroll(); // Initialize filter nav scroll
            updateFilterNavActiveState(); // Update filter nav active state
        });

        // Logout function - performs both client and server logout
        async function handleLogout() {
            try {
                // First, try to logout from Supabase client-side
                if (window.supabase && supabase) {
                    await supabase.auth.signOut();
                }

                // Then call the server-side logout endpoint
                await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('input[name="_csrf"]')?.value || ''
                    },
                    credentials: 'include'
                });

                // Finally redirect to auth page
                window.location.href = '/auth';
            } catch (error) {
                console.error('Logout error:', error);
                // Even if logout fails, redirect to auth page
                window.location.href = '/auth';
            }
        }

        // Force logout function
        function forceLogout() {
            window.location.href = '/auth';
        }
    </script>

    <!-- Toast notifications -->
    {{> toast}}
</body>
</html>
