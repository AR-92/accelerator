{{!-- Generic Table Partial --}}
<div id="{{tableId}}TableContainer" class="overflow-auto flex-1 rounded-xl">
  <table class="min-w-full table-auto bg-card rounded-md">
    <!-- Table Header -->
    <thead class="bg-card border-b border-border rounded-t-xl">
      <tr>
    {{#if showCheckbox}}
     <th class="px-6 py-4 text-left font-semibold text-card-foreground uppercase text-xs tracking-wider bg-muted">
      <input type="checkbox" id="selectAll-{{tableId}}" class="rounded border-input text-primary
        aria-label="Select all {{entityName}}">
    </th>
    {{/if}}
    {{#each columns}}
     <th class="px-6 py-4 text-left font-semibold text-card-foreground uppercase text-xs tracking-wider{{#if hidden}} hidden {{responsive}} {{/if}} bg-muted">{{label}}</th>
    {{/each}}
    {{#if actions}}
     <th class="px-6 py-4 text-left font-semibold text-card-foreground uppercase text-xs tracking-wider bg-muted">Actions</th>
    {{/if}}
      </tr>
    </thead>
    <!-- Table Body -->
    <tbody class="text-sm text-card-foreground">
      {{#each data}}
        <tr id="{{../entityName}}-row-{{id}}" class="h-16 border-b border-border hover:bg-muted/50 even:bg-muted/30 transition-colors duration-150">
        {{#if ../showCheckbox}}
        <td class="px-6 py-4">
          <input type="checkbox" class="{{../entityName}}Checkbox rounded border-input text-primary 
            value="{{id}}" data-{{../entityName}}-id="{{id}}" aria-label="Select {{../entityName}} {{title}}">
        </td>
        {{/if}}
        {{#each ../columns}}
        <td class="px-6 py-4{{#if hidden}} hidden {{responsive}} {{/if}}">
           {{#if (eq type 'status')}}
             <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {{statusClass (lookup ../this key)}}">{{lookup ../this key}}</span>
           {{else if (eq type 'date')}}
             <div class="text-sm text-card-foreground">{{formatDate (lookup ../this key)}}</div>
           {{else if (eq type 'title')}}
             <div>
               <div class="text-sm font-medium text-card-foreground">{{lookup ../this key}}</div>
               {{#if descriptionKey}}
               <div class="text-sm text-muted-foreground">{{lookup ../this descriptionKey}}</div>
               {{/if}}
             </div>
            {{else}}
              <div class="text-sm text-card-foreground truncate max-w-xs" title="{{lookup ../this key}}">{{lookup ../this key}}</div>
            {{/if}}
        </td>
        {{/each}}
         {{#if ../actions}}
         <td class="px-6 py-4">
           <div class="relative">
              <button onclick="toggleActionMenu(this)"
                class="p-2 rounded-full hover:bg-accent text-muted-foreground hover:text-accent-foreground transition-colors"
                aria-label="Actions menu for {{../entityName}} {{id}}"
                data-entity="{{../entityName}}"
                data-id="{{id}}">
                {{{icon 'ellipsis-vertical' size='16' class='w-4 h-4'}}}
              </button>
           </div>
         </td>
         {{/if}}
      </tr>
       {{else}}
        <tr class="h-16">
          <td colspan="{{colspan}}" class="px-6 py-8 text-center text-muted-foreground">
            <div class="flex flex-col items-center justify-center py-12">
              {{{icon 'clipboard-list' size='64' class='w-16 h-16 text-muted-foreground/50 mb-4'}}}
              <p class="text-lg font-medium text-muted-foreground mb-2">No {{entityName}} found</p>
              <p class="text-sm text-muted-foreground/70">Get started by creating your first {{entityName}}.</p>
            </div>
          </td>
        </tr>
       {{/each}}
    </tbody>
     <!-- Table Footer -->
     <tfoot>
       <tr>
         <td colspan="{{colspan}}" class="bg-card border-t border-border px-4 py-3">
           <div class="max-w-7xl mx-auto flex items-center justify-between">
             <div class="text-xs text-muted-foreground">
               {{pagination.start}}-{{pagination.end}} of {{pagination.total}}
             </div>

             <div class="flex items-center gap-3">
               <select id="rowsPerPage-{{tableId}}" name="limit"
                 class="border border-input rounded px-2 py-1 text-xs bg-background focus:outline-none focus:border-ring transition-colors"
                 hx-get="{{currentUrl}}" hx-target="#{{tableId}}TableContainer"
                 hx-vals="js:{limit: document.getElementById('rowsPerPage-{{tableId}}').value}">
                 <option value="10"{{#if (eq pagination.limit 10)}} selected{{/if}}>10</option>
                 <option value="20"{{#if (eq pagination.limit 20)}} selected{{/if}}>20</option>
                 <option value="50"{{#if (eq pagination.limit 50)}} selected{{/if}}>50</option>
                 <option value="100"{{#if (eq pagination.limit 100)}} selected{{/if}}>100</option>
               </select>

               <!-- Pagination Controls -->
               <nav class="flex items-center gap-1">
                    {{#if pagination.hasPrev}}
                     <button hx-get="{{currentUrl}}?page={{pagination.prevPage}}"
                       hx-target="#{{tableId}}TableContainer"
                       class="inline-flex items-center justify-center w-8 h-8 rounded border border-input bg-background text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"
                       title="Previous page">
                      {{{icon 'chevron-left' size='14' class='w-3.5 h-3.5'}}}
                    </button>
                   {{/if}}
                   {{#each pagination.pages}}
                    <button hx-get="{{../currentUrl}}?page={{this}}"
                      hx-target="#{{../tableId}}TableContainer"
                      class="inline-flex items-center justify-center px-2 py-1 rounded{{#if (eq this ../pagination.currentPage)}} bg-muted text-foreground{{else}} text-muted-foreground hover:text-foreground{{/if}} transition-colors text-xs font-medium focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50">{{this}}</button>
                   {{/each}}
                   {{#if pagination.hasNext}}
                     <button hx-get="{{currentUrl}}?page={{pagination.nextPage}}"
                       hx-target="#{{tableId}}TableContainer"
                       class="inline-flex items-center justify-center w-8 h-8 rounded border border-input bg-background text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"
                       title="Next page">
                      {{{icon 'chevron-right' size='14' class='w-3.5 h-3.5'}}}
                    </button>
                   {{/if}}
               </nav>
             </div>
           </div>
         </td>
       </tr>
     </tfoot>
   </table>

   <!-- Action Dropdowns (moved outside table to prevent overflow clipping) -->
    {{#each data}}
    <div id="actionMenu-{{../entityName}}-{{id}}"
      class="dropdown-menu fixed w-48 bg-popover rounded-md shadow-lg border border-border"
      style="display: none;">
     <div class="py-1">
       {{#each ../actions}}
        {{#if (eq type 'link')}}
        <a href="{{url}}/{{../id}}"
          class="flex items-center px-4 py-2 text-sm text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors">
          {{{icon}}}
          {{label}}
        </a>
        {{else if (eq type 'button')}}
        <button {{#if hxGet}}hx-get="{{hxGet}}/{{../id}}"{{/if}} {{#if hxTarget}}hx-target="{{hxTarget}}"{{/if}} {{#if hxSwap}}hx-swap="{{hxSwap}}"{{/if}} {{#if onclick}}onclick="{{onclick}}({{../id}})"{{/if}}
          class="flex items-center w-full px-4 py-2 text-sm text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors">
          {{{icon}}}
          {{label}}
        </button>
        {{else if (eq type 'delete')}}
        <button {{#if hxDelete}}hx-delete="{{hxDelete}}/{{../id}}"{{/if}} {{#if hxConfirm}}hx-confirm="{{hxConfirm}}"{{/if}} {{#if hxTarget}}hx-target="{{hxTarget}}"{{/if}} {{#if hxSwap}}hx-swap="{{hxSwap}}"{{/if}} {{#if onclick}}onclick="{{onclick}}({{../id}}, '{{../title}}')"{{/if}}
          class="flex items-center w-full px-4 py-2 text-sm text-destructive hover:bg-destructive/10 transition-colors">
          {{{icon}}}
          {{label}}
        </button>
        {{else if (eq type 'approve')}}
        <button {{#if hxPut}}hx-put="{{hxPut}}/{{../id}}/approve"{{/if}} {{#if hxTarget}}hx-target="{{hxTarget}}"{{/if}} {{#if hxSwap}}hx-swap="{{hxSwap}}"{{/if}}
          class="flex items-center w-full px-4 py-2 text-sm text-green-600 hover:bg-green-50 transition-colors">
          {{{icon}}}
          {{label}}
        </button>
        {{else if (eq type 'reject')}}
        <button {{#if hxPut}}hx-put="{{hxPut}}/{{../id}}/reject"{{/if}} {{#if hxTarget}}hx-target="{{hxTarget}}"{{/if}} {{#if hxSwap}}hx-swap="{{hxSwap}}"{{/if}}
          class="flex items-center w-full px-4 py-2 text-sm text-yellow-600 hover:bg-yellow-50 transition-colors">
          {{{icon}}}
          {{label}}
        </button>
        {{else}}
       <div class="px-4 py-2 text-sm text-muted-foreground">No actions available</div>
       {{/if}}
       {{/each}}
       {{#unless ../actions}}
       <div class="px-4 py-2 text-sm text-muted-foreground">No actions configured</div>
       {{/unless}}
     </div>
   </div>
   {{/each}}

  </div>

  {{#if showBulkActions}}
<!-- Bulk Actions Panel -->
<div id="bulkActions-{{tableId}}"
  class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-primary text-primary-foreground px-6 py-3 rounded-full z-30"
  style="display: none;">
  <div class="flex items-center gap-4">
    <span id="selectedCount-{{tableId}}">0 {{entityName}} selected</span>
    <div class="flex gap-2">
      {{#each bulkActions}}
      <button onclick="{{onclick}}" id="{{buttonId}}-{{../tableId}}"
        class="bg-primary-foreground/20 hover:bg-primary-foreground/30 text-primary-foreground px-3 py-1 rounded text-sm" disabled="">
        {{label}}
      </button>
      {{/each}}
    </div>
  </div>
</div>
{{/if}}

<script>
function toggleActionMenu(button) {
  const entity = button.getAttribute('data-entity');
  const id = button.getAttribute('data-id');

  if (!entity || !id) {
    console.error('Button missing data-entity or data-id attributes');
    return;
  }

  const menu = document.getElementById(`actionMenu-${entity}-${id}`);

  if (!menu) {
    console.error(`Dropdown not found: actionMenu-${entity}-${id}`);
    return;
  }

  const allMenus = document.querySelectorAll('[id^="actionMenu-"]');

  // Close all other menus
  allMenus.forEach((m) => {
    if (m !== menu) {
      m.style.display = 'none';
    }
  });

  // Toggle current menu
  if (menu.style.display === 'none' || menu.style.display === '') {
    // Position the menu next to the button first
    const rect = button.getBoundingClientRect();

    // Set position and make visible temporarily to get dimensions
    menu.style.position = 'fixed';
    menu.style.zIndex = '9999';
    menu.style.display = 'block';
    menu.style.visibility = 'hidden';
    menu.style.top = '0px';
    menu.style.left = '0px';

    // Get dimensions after it's in the DOM
    const menuWidth = menu.offsetWidth;
    const menuHeight = menu.offsetHeight;

    // Calculate position: prefer below and to the right of button
    let top = rect.bottom + window.scrollY + 5;
    let left = rect.right + window.scrollX - menuWidth;

    // If it would go off-screen to the left, position to the right of button
    if (left < 0) {
      left = rect.right + window.scrollX;
    }

    // If it would go off-screen to the bottom, position above button
    if (top + menuHeight > window.scrollY + window.innerHeight) {
      top = rect.top + window.scrollY - menuHeight - 5;
    }

    // If it would still go off-screen to the top, position below
    if (top < 0) {
      top = rect.bottom + window.scrollY + 5;
    }

    // Apply final position
    menu.style.top = `${top}px`;
    menu.style.left = `${left}px`;
    menu.style.visibility = 'visible';
  } else {
    menu.style.display = 'none';
  }
}
</script>