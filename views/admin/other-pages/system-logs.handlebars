<!-- System Logs Content -->
<div class="max-w-7xl mx-auto rounded-xl overflow-hidden flex flex-col mx-4 my-4">

    <!-- Page Header -->
    {{> page-header title="System Logs Analytics Dashboard" description="Comprehensive monitoring and analytics of system logs, error patterns, and performance insights" border=true}}

    <div class="p-6 space-y-8">
       <!-- Critical Status Overview -->
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Total Logs -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Total Logs</p>
                   <p class="text-2xl font-bold text-blue-600">{{systemLogAnalytics.totalLogs}}</p>
                   <p class="text-xs text-muted-foreground">{{systemLogAnalytics.avgLogsPerHour}}/hour avg</p>
                </div>
                 <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                    {{{icon 'file-text' size='24' class='text-blue-600 dark:text-blue-400'}}}
                 </div>
             </div>
          </div>

          <!-- Error Rate -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Error Rate</p>
                   <p class="text-2xl font-bold text-red-600">{{systemLogAnalytics.errorRate}}%</p>
                   <p class="text-xs text-muted-foreground">{{systemLogAnalytics.errorCount}} errors</p>
                </div>
                 <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
                    {{{icon 'alert-triangle' size='24' class='text-red-600 dark:text-red-400'}}}
                 </div>
             </div>
          </div>

          <!-- System Health -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">System Health</p>
                   <p class="text-2xl font-bold text-green-600">{{systemLogAnalytics.systemHealth}}</p>
                   <p class="text-xs text-muted-foreground">Based on logs</p>
                </div>
                 <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                    {{{icon 'shield-check' size='24' class='text-green-600 dark:text-green-400'}}}
                 </div>
             </div>
          </div>

          <!-- Response Time -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Avg Response</p>
                   <p class="text-2xl font-bold text-purple-600">{{systemLogAnalytics.performanceInsights.responseTime}}</p>
                   <p class="text-xs text-muted-foreground">System average</p>
                </div>
                 <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                    {{{icon 'zap' size='24' class='text-purple-600 dark:text-purple-400'}}}
                 </div>
             </div>
          </div>
       </div>
      {{#if error}}
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
         <div class="flex">
            <div class="flex-shrink-0">
               {{{icon 'alert-triangle' size='20' class='text-red-400'}}}
            </div>
            <div class="ml-3">
               <h3 class="text-sm font-medium text-red-800">Logs Error</h3>
               <div class="mt-2 text-sm text-red-700">
                  <p>{{error}}</p>
               </div>
            </div>
         </div>
       </div>
       {{/if}}

       <!-- Log Analytics & Performance -->
       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Log Levels Overview -->
          <div class="bg-card rounded-lg border border-border">
             <div class="p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                   {{{icon 'bar-chart-3' size='20' class='mr-2'}}}
                   Log Levels
                </h3>
             </div>
             <div class="p-6 space-y-3">
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Errors</span>
                   <span class="text-sm text-muted-foreground">{{systemLogAnalytics.errorCount}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Warnings</span>
                   <span class="text-sm text-muted-foreground">{{systemLogAnalytics.warningCount}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Info</span>
                   <span class="text-sm text-muted-foreground">{{systemLogAnalytics.infoCount}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Debug</span>
                   <span class="text-sm text-muted-foreground">{{systemLogAnalytics.debugCount}}</span>
                </div>
             </div>
          </div>

          <!-- Performance Insights -->
          <div class="bg-card rounded-lg border border-border">
             <div class="p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                   {{{icon 'trending-up' size='20' class='mr-2'}}}
                   Performance Insights
                </h3>
             </div>
             <div class="p-6 space-y-3">
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Throughput</span>
                   <span class="text-sm text-muted-foreground">{{systemLogAnalytics.performanceInsights.throughput}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Error Recovery</span>
                   <span class="text-sm text-muted-foreground">{{systemLogAnalytics.performanceInsights.errorRecovery}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Most Active Hour</span>
                   <span class="text-sm text-muted-foreground">{{systemLogAnalytics.mostActiveHour}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Health Status</span>
                   <span class="text-sm text-muted-foreground">{{systemLogAnalytics.systemHealth}}</span>
                </div>
             </div>
          </div>

          <!-- Critical Patterns -->
          <div class="bg-card rounded-lg border border-border">
             <div class="p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                   {{{icon 'alert-triangle' size='20' class='mr-2'}}}
                   Critical Patterns
                </h3>
             </div>
             <div class="p-6 space-y-3">
                {{#each systemLogAnalytics.criticalPatterns}}
                <div class="flex items-center">
                   <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                   <span class="text-sm text-card-foreground">{{this}}</span>
                </div>
                {{/each}}
             </div>
          </div>
       </div>

       <!-- Log Trends -->
       <div class="bg-card rounded-lg border border-border">
          <div class="p-6 border-b border-border">
             <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                {{{icon 'trending-up' size='20' class='mr-2'}}}
                Log Trends & Analytics
             </h3>
             <p class="text-sm text-muted-foreground mt-1">Log volume and error patterns over the last 24 hours</p>
          </div>
          <div class="p-6">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Log Volume Trend -->
                <div>
                   <h4 class="text-sm font-medium text-card-foreground mb-3 flex items-center">
                      {{{icon 'file-text' size='16' class='mr-2 text-blue-600'}}}
                      Log Volume (24h)
                   </h4>
                    <div class="h-48">
                       <canvas id="logVolumeChart" width="400" height="200"></canvas>
                    </div>
                   <div class="mt-2 text-center">
                      <span class="text-xs text-muted-foreground">Peak: </span>
                      <span class="text-xs font-medium text-blue-600">{{math (max logAnalytics.volumeHistory.data) }}</span>
                   </div>
                </div>

                <!-- Error Rate Trend -->
                <div>
                   <h4 class="text-sm font-medium text-card-foreground mb-3 flex items-center">
                      {{{icon 'alert-triangle' size='16' class='mr-2 text-red-600'}}}
                      Error Rate (%)
                   </h4>
                    <div class="h-48">
                       <canvas id="logErrorChart" width="400" height="200"></canvas>
                    </div>
                   <div class="mt-2 text-center">
                      <span class="text-xs text-muted-foreground">Current: </span>
                      <span class="text-xs font-medium text-red-600">{{math (last logAnalytics.errorTrends.data) }}%</span>
                   </div>
                </div>
             </div>
          </div>
       </div>

       <!-- Log Level Distribution -->
       <div class="bg-card rounded-lg border border-border">
          <div class="p-6 border-b border-border">
             <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                {{{icon 'pie-chart' size='20' class='mr-2'}}}
                Log Level Distribution
             </h3>
             <p class="text-sm text-muted-foreground mt-1">Breakdown of log entries by severity level</p>
          </div>
          <div class="p-6">
             <div class="h-64">
                <canvas id="logLevelChart" width="400" height="200"></canvas>
             </div>
          </div>
       </div>

       <!-- Filters -->
      <div class="bg-card rounded-lg border border-border p-6">
         <form method="GET" class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-0">
               <label class="block text-sm font-medium text-card-foreground mb-2">Search Logs</label>
               <input type="text" name="search" value="{{filters.search}}"
                      placeholder="Search log messages..."
                      class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="w-48">
               <label class="block text-sm font-medium text-card-foreground mb-2">Log Level</label>
               <select name="level" class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="all" {{#eq filters.level 'all'}}selected{{/eq}}>All Levels</option>
                  <option value="error" {{#eq filters.level 'error'}}selected{{/eq}}>Errors</option>
                  <option value="warn" {{#eq filters.level 'warn'}}selected{{/eq}}>Warnings</option>
                  <option value="info" {{#eq filters.level 'info'}}selected{{/eq}}>Info</option>
                  <option value="debug" {{#eq filters.level 'debug'}}selected{{/eq}}>Debug</option>
               </select>
            </div>
            <div class="w-48">
               <label class="block text-sm font-medium text-card-foreground mb-2">Date</label>
               <select name="date" class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">All Dates</option>
                  {{#each availableDates}}
                  <option value="{{this}}" {{#eq ../filters.date this}}selected{{/eq}}>{{this}}</option>
                  {{/each}}
               </select>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                   {{{icon 'search' size='16' class='mr-2'}}}
                   Filter
                </button>
                <a href="/admin/other-pages/system-logs" class="px-4 py-2 bg-card text-foreground rounded-lg hover:bg-muted transition-colors border border-border">
                   {{{icon 'x' size='16' class='mr-2'}}}
                   Clear
                </a>
            </div>
         </form>
      </div>

      <!-- Logs Display -->
      {{#if hasLogs}}
      <div class="bg-card rounded-lg border border-border">
         <div class="p-6 border-b border-border flex items-center justify-between">
            <div>
               <h3 class="text-lg font-semibold text-card-foreground">Log Entries</h3>
               <p class="text-sm text-muted-foreground mt-1">
                  Showing {{logs.length}} of {{totalLogs}} log entries
                  {{#if filters.search}} matching "{{filters.search}}"{{/if}}
               </p>
            </div>
             <button id="export-logs-btn" class="px-4 py-2 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-100 dark:hover:bg-green-800 transition-colors border border-green-200 dark:border-green-700">
                {{{icon 'download' size='16' class='mr-2'}}}
                Export Logs
             </button>
         </div>

         <div class="divide-y divide-border">
            {{#each logs}}
            <div class="p-4 hover:bg-muted/50 transition-colors">
               <div class="flex items-start justify-between">
                  <div class="flex-1 min-w-0">
                     <div class="flex items-center gap-3 mb-2">
                         <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                           {{#eq level 'error'}}bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-400{{/eq}}
                           {{#eq level 'warn'}}bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-400{{/eq}}
                           {{#eq level 'info'}}bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400{{/eq}}
                           {{#eq level 'debug'}}bg-muted text-muted-foreground{{/eq}}">
                          {{{icon 'circle' size='8' class='mr-1'}}}
                          {{level}}
                        </span>
                        <span class="text-sm text-muted-foreground font-mono">{{timestamp}}</span>
                        <span class="text-sm text-muted-foreground">{{source}}</span>
                     </div>
                     <p class="text-sm text-card-foreground break-words">{{message}}</p>
                  </div>
               </div>
            </div>
            {{/each}}
         </div>

         <!-- Pagination -->
         {{#if (gt totalPages 1)}}
         <div class="px-6 py-4 border-t border-border flex items-center justify-between">
            <div class="text-sm text-muted-foreground">
               Page {{currentPage}} of {{totalPages}}
            </div>
            <div class="flex gap-2">
               {{#if (gt currentPage 1)}}
                <a href="?page={{subtract currentPage 1}}&level={{filters.level}}&date={{filters.date}}&search={{filters.search}}"
                   class="px-3 py-1 bg-card text-foreground rounded hover:bg-muted border border-border">
                   Previous
                </a>
               {{/if}}

               {{#if (lt currentPage totalPages)}}
                <a href="?page={{add currentPage 1}}&level={{filters.level}}&date={{filters.date}}&search={{filters.search}}"
                   class="px-3 py-1 bg-card text-foreground rounded hover:bg-muted border border-border">
                   Next
                </a>
               {{/if}}
            </div>
         </div>
         {{/if}}
      </div>
      {{else}}
      <div class="bg-card rounded-lg border border-border p-12">
         <div class="text-center">
            <div class="w-16 h-16 bg-muted rounded-full flex items-center justify-center mx-auto mb-4">
               {{{icon 'file-text' size='32' class='text-muted-foreground'}}}
            </div>
            <h3 class="text-lg font-medium text-card-foreground mb-2">No Logs Found</h3>
            <p class="text-muted-foreground">
               {{#if filters.search}}
               No log entries match your search criteria.
               {{else}}
               No log files were found or logs are not available.
               {{/if}}
            </p>
            {{#if filters.search}}
            <a href="/admin/other-pages/system-logs" class="text-blue-600 hover:text-blue-800 mt-4 inline-block">
               Clear filters
            </a>
            {{/if}}
         </div>
      </div>
      {{/if}}
   </div>
 </div>

 <!-- Chart.js Script -->
 <script src="/js/chart.umd.js"></script>
 <script>
    document.addEventListener('DOMContentLoaded', function() {
       console.log('System Logs Analytics page loaded, initializing charts...');

       // Check if Chart.js is loaded
       if (typeof Chart === 'undefined') {
          console.error('Chart.js not loaded, charts will not display');
          return;
       }

       const logAnalytics = {{{json logAnalytics}};
       console.log('Log analytics loaded:', logAnalytics);

       // Log Volume Chart
       try {
          const volumeCanvas = document.getElementById('logVolumeChart');
          if (!volumeCanvas) {
             console.error('Log volume chart canvas element not found');
             return;
          }

          const volumeCtx = volumeCanvas.getContext('2d');
          if (!volumeCtx) {
             console.error('Could not get 2D context for log volume chart');
             return;
          }

          new Chart(volumeCtx, {
          type: 'line',
          data: {
             labels: logAnalytics.volumeHistory.labels,
             datasets: [{
                label: 'Log Volume',
                data: logAnalytics.volumeHistory.data,
                 borderColor: 'rgb(59, 130, 246)',
                 backgroundColor: 'rgba(59, 130, 246, 0.1)',
                 tension: 0.4,
                 fill: true,
                 pointBackgroundColor: 'rgb(59, 130, 246)',
                 pointBorderColor: '#fff',
                 pointBorderWidth: 2,
              }]
           },
           options: {
              responsive: true,
              maintainAspectRatio: false,
              aspectRatio: 2,
              plugins: {
                legend: {
                   display: false
                }
             },
             scales: {
                y: {
                   beginAtZero: true,
                   grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                   }
                },
                x: {
                   grid: {
                      display: false
                   },
                   ticks: {
                      maxTicksLimit: 6
                   }
                }
             },
             elements: {
                point: {
                   radius: 3,
                   hoverRadius: 5
                }
             },
             interaction: {
                intersect: false,
                mode: 'index'
             }
          }
          });
          console.log('Log volume chart created successfully');
       } catch (error) {
          console.error('Failed to create log volume chart:', error);
       }

       // Error Rate Chart
       try {
          const errorCanvas = document.getElementById('logErrorChart');
          if (!errorCanvas) {
             console.error('Log error chart canvas element not found');
             return;
          }

          const errorCtx = errorCanvas.getContext('2d');
          if (!errorCtx) {
             console.error('Could not get 2D context for log error chart');
             return;
          }

          new Chart(errorCtx, {
          type: 'line',
          data: {
             labels: logAnalytics.errorTrends.labels,
             datasets: [{
                label: 'Error Rate (%)',
                data: logAnalytics.errorTrends.data,
                 borderColor: 'rgb(239, 68, 68)',
                 backgroundColor: 'rgba(239, 68, 68, 0.1)',
                 tension: 0.4,
                 fill: true,
                 pointBackgroundColor: 'rgb(239, 68, 68)',
                 pointBorderColor: '#fff',
                 pointBorderWidth: 2,
              }]
           },
           options: {
              responsive: true,
              maintainAspectRatio: false,
              aspectRatio: 2,
              plugins: {
                legend: {
                   display: false
                }
             },
             scales: {
                y: {
                   beginAtZero: true,
                   max: 15,
                   grid: {
                      color: 'rgba(0, 0, 0, 0.1)'
                   },
                   ticks: {
                      callback: function(value) {
                         return value + '%';
                      }
                   }
                },
                x: {
                   grid: {
                      display: false
                   },
                   ticks: {
                      maxTicksLimit: 6
                   }
                }
             },
             elements: {
                point: {
                   radius: 3,
                   hoverRadius: 5
                }
             },
             interaction: {
                intersect: false,
                mode: 'index'
             }
          }
          });
          console.log('Log error chart created successfully');
       } catch (error) {
          console.error('Failed to create log error chart:', error);
       }

       // Log Level Distribution Chart
       try {
          const levelCanvas = document.getElementById('logLevelChart');
          if (!levelCanvas) {
             console.error('Log level chart canvas element not found');
             return;
          }

          const levelCtx = levelCanvas.getContext('2d');
          if (!levelCtx) {
             console.error('Could not get 2D context for log level chart');
             return;
          }

          const levelColors = {
             'error': 'rgb(239, 68, 68)',
             'warn': 'rgb(245, 158, 11)',
             'info': 'rgb(59, 130, 246)',
             'debug': 'rgb(107, 114, 128)'
          };

          const backgroundColors = logAnalytics.levelDistribution.labels.map(level =>
             levelColors[level] || 'rgb(156, 163, 175)'
          );

          new Chart(levelCtx, {
          type: 'doughnut',
          data: {
             labels: logAnalytics.levelDistribution.labels,
             datasets: [{
                data: logAnalytics.levelDistribution.data,
                backgroundColor: backgroundColors,
                borderWidth: 2,
                borderColor: '#fff',
             }]
          },
          options: {
             responsive: true,
             maintainAspectRatio: false,
             plugins: {
                legend: {
                   position: 'bottom',
                   labels: {
                      padding: 20,
                      usePointStyle: true,
                   }
                }
             },
             elements: {
                arc: {
                   borderWidth: 2,
                }
             }
          }
          });
          console.log('Log level chart created successfully');
       } catch (error) {
          console.error('Failed to create log level chart:', error);
    }
 });
 </script>

 <!-- Last Updated Info -->
 <div class="text-center text-xs text-muted-foreground mt-6">
    Last updated: <span id="lastUpdated">{{lastUpdated}}</span> |
    Auto-refresh: <span class="text-green-600">Enabled</span> (5min interval)
 </div>

 <script>
document.addEventListener('DOMContentLoaded', function() {
   // Export logs functionality
   const exportBtn = document.getElementById('export-logs-btn');
   if (exportBtn) {
      exportBtn.addEventListener('click', function() {
         // Create a simple text export of visible logs
         const logs = document.querySelectorAll('.divide-y > div');
         let logText = 'System Logs Export\n';
         logText += '=' .repeat(50) + '\n\n';

         logs.forEach(log => {
            const level = log.querySelector('.rounded-full')?.textContent.trim() || '';
            const timestamp = log.querySelector('.font-mono')?.textContent.trim() || '';
            const message = log.querySelector('p:last-child')?.textContent.trim() || '';

            logText += `[${timestamp}] ${level.toUpperCase()}: ${message}\n`;
         });

         // Download as text file
         const blob = new Blob([logText], { type: 'text/plain' });
         const url = window.URL.createObjectURL(blob);
         const a = document.createElement('a');
         a.href = url;
         a.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
         document.body.appendChild(a);
         a.click();
         window.URL.revokeObjectURL(url);
         document.body.removeChild(a);
      });
   }
});
</script>