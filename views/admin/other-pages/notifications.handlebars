<!-- Notifications Management Content -->
<div class="max-w-7xl mx-auto rounded-xl overflow-hidden flex flex-col mx-4 my-4">

    <!-- Page Header -->
    {{> page-header title="Notifications Management Dashboard" description="Comprehensive monitoring and analytics of system notifications, user engagement, and delivery metrics" border=true}}

    <div class="p-6 space-y-8">
       <!-- Critical Status Overview -->
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Total Notifications -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Total Notifications</p>
                   <p class="text-2xl font-bold text-blue-600">{{notificationAnalytics.totalNotifications}}</p>
                   <p class="text-xs text-muted-foreground">{{notificationStats.unread}} unread</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                   {{{icon 'bell' size='24' class='text-blue-600'}}}
                </div>
             </div>
          </div>

          <!-- Read Rate -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Read Rate</p>
                   <p class="text-2xl font-bold text-green-600">{{notificationAnalytics.readRate}}%</p>
                   <p class="text-xs text-muted-foreground">{{notificationStats.thisWeek}} this week</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                   {{{icon 'check-circle' size='24' class='text-green-600'}}}
                </div>
             </div>
          </div>

          <!-- Urgent Notifications -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Urgent Alerts</p>
                   <p class="text-2xl font-bold text-red-600">{{notificationAnalytics.urgentCount}}</p>
                   <p class="text-xs text-muted-foreground">High priority</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                   {{{icon 'alert-triangle' size='24' class='text-red-600'}}}
                </div>
             </div>
          </div>

          <!-- Delivery Success -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Delivery Success</p>
                   <p class="text-2xl font-bold text-purple-600">{{notificationAnalytics.deliverySuccess}}</p>
                   <p class="text-xs text-muted-foreground">System uptime</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                   {{{icon 'send' size='24' class='text-purple-600'}}}
                </div>
             </div>
          </div>
       </div>

       <!-- Notification Analytics & Performance -->
       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Notification Types Overview -->
          <div class="bg-card rounded-lg border border-border">
             <div class="p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                   {{{icon 'pie-chart' size='20' class='mr-2'}}}
                   Notification Types
                </h3>
             </div>
             <div class="p-6 space-y-3">
                {{#each notificationTrends.typeDistribution.labels}}
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground capitalize">{{this}}</span>
                   <span class="text-sm text-muted-foreground">{{lookup ../notificationTrends.typeDistribution.data @index}}</span>
                </div>
                {{/each}}
             </div>
          </div>

          <!-- User Engagement Metrics -->
          <div class="bg-card rounded-lg border border-border">
             <div class="p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                   {{{icon 'users' size='20' class='mr-2'}}}
                   User Engagement
                </h3>
             </div>
             <div class="p-6 space-y-3">
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Open Rate</span>
                   <span class="text-sm text-muted-foreground">{{notificationAnalytics.userEngagement.openRate}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Action Rate</span>
                   <span class="text-sm text-muted-foreground">{{notificationAnalytics.userEngagement.actionRate}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Unsubscribe Rate</span>
                   <span class="text-sm text-muted-foreground">{{notificationAnalytics.userEngagement.unsubscribeRate}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Avg Response</span>
                   <span class="text-sm text-muted-foreground">{{notificationAnalytics.avgResponseTime}}</span>
                </div>
             </div>
          </div>

          <!-- Delivery Health -->
          <div class="bg-card rounded-lg border border-border">
             <div class="p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                   {{{icon 'shield-check' size='20' class='mr-2'}}}
                   Delivery Health
                </h3>
             </div>
             <div class="p-6 space-y-3">
                <div class="flex items-center justify-between">
                   <span class="text-sm font-medium text-card-foreground">Delivery Status</span>
                   <div class="flex items-center">
                      <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
                      <span class="text-sm text-green-600 font-medium">Healthy</span>
                   </div>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Success Rate</span>
                   <span class="text-sm text-muted-foreground">{{notificationAnalytics.deliverySuccess}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Queue Status</span>
                   <span class="text-sm text-muted-foreground">Normal</span>
                </div>
             </div>
          </div>
       </div>

       <!-- Notification Trends -->
       <div class="bg-card rounded-lg border border-border">
          <div class="p-6 border-b border-border">
             <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                {{{icon 'trending-up' size='20' class='mr-2'}}}
                Notification Trends
             </h3>
             <p class="text-sm text-muted-foreground mt-1">Notification volume and engagement rates over the last 24 hours</p>
          </div>
          <div class="p-6">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Notification Volume Trend -->
                <div>
                   <h4 class="text-sm font-medium text-card-foreground mb-3 flex items-center">
                      {{{icon 'bell' size='16' class='mr-2 text-blue-600'}}}
                      Notification Volume (24h)
                   </h4>
                    <div class="h-48">
                       <canvas id="notificationVolumeChart" width="400" height="200"></canvas>
                    </div>
                   <div class="mt-2 text-center">
                      <span class="text-xs text-muted-foreground">Peak: </span>
                      <span class="text-xs font-medium text-blue-600">{{math (max notificationTrends.volumeHistory.data) }}</span>
                   </div>
                </div>

                <!-- Read Rate Trend -->
                <div>
                   <h4 class="text-sm font-medium text-card-foreground mb-3 flex items-center">
                      {{{icon 'check-circle' size='16' class='mr-2 text-green-600'}}}
                      Read Rate (%)
                   </h4>
                    <div class="h-48">
                       <canvas id="readRateChart" width="400" height="200"></canvas>
                    </div>
                   <div class="mt-2 text-center">
                      <span class="text-xs text-muted-foreground">Current: </span>
                      <span class="text-xs font-medium text-green-600">{{math (last notificationTrends.readRateHistory.data) }}%</span>
      </div>

      <!-- Chart.js Script -->
      <script src="/js/chart.umd.js"></script>
      <script>
         document.addEventListener('DOMContentLoaded', function() {
            console.log('Notifications Management page loaded, initializing charts...');

            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
               console.error('Chart.js not loaded, charts will not display');
               return;
            }

            const notificationTrends = {{{json notificationTrends}}};
            console.log('Notification trends loaded:', notificationTrends);

            // Notification Volume Chart
            try {
               const volumeCanvas = document.getElementById('notificationVolumeChart');
               if (!volumeCanvas) {
                  console.error('Notification volume chart canvas element not found');
                  return;
               }

               const volumeCtx = volumeCanvas.getContext('2d');
               if (!volumeCtx) {
                  console.error('Could not get 2D context for notification volume chart');
                  return;
               }

               new Chart(volumeCtx, {
               type: 'line',
               data: {
                  labels: notificationTrends.volumeHistory.labels,
                  datasets: [{
                     label: 'Notification Volume',
                     data: notificationTrends.volumeHistory.data,
                      borderColor: 'rgb(59, 130, 246)',
                      backgroundColor: 'rgba(59, 130, 246, 0.1)',
                      tension: 0.4,
                      fill: true,
                      pointBackgroundColor: 'rgb(59, 130, 246)',
                      pointBorderColor: '#fff',
                      pointBorderWidth: 2,
                   }]
                },
                options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   aspectRatio: 2,
                   plugins: {
                     legend: {
                        display: false
                     }
                  },
                  scales: {
                     y: {
                        beginAtZero: true,
                        grid: {
                           color: 'rgba(0, 0, 0, 0.1)'
                        }
                     },
                     x: {
                        grid: {
                           display: false
                        },
                        ticks: {
                           maxTicksLimit: 6
                        }
                     }
                  },
                  elements: {
                     point: {
                        radius: 3,
                        hoverRadius: 5
                     }
                  },
                  interaction: {
                     intersect: false,
                     mode: 'index'
                  }
               }
               });
               console.log('Notification volume chart created successfully');
            } catch (error) {
               console.error('Failed to create notification volume chart:', error);
            }

            // Read Rate Chart
            try {
               const readCanvas = document.getElementById('readRateChart');
               if (!readCanvas) {
                  console.error('Read rate chart canvas element not found');
                  return;
               }

               const readCtx = readCanvas.getContext('2d');
               if (!readCtx) {
                  console.error('Could not get 2D context for read rate chart');
                  return;
               }

               new Chart(readCtx, {
               type: 'line',
               data: {
                  labels: notificationTrends.readRateHistory.labels,
                  datasets: [{
                     label: 'Read Rate (%)',
                     data: notificationTrends.readRateHistory.data,
                      borderColor: 'rgb(16, 185, 129)',
                      backgroundColor: 'rgba(16, 185, 129, 0.1)',
                      tension: 0.4,
                      fill: true,
                      pointBackgroundColor: 'rgb(16, 185, 129)',
                      pointBorderColor: '#fff',
                      pointBorderWidth: 2,
                   }]
                },
                options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   aspectRatio: 2,
                   plugins: {
                     legend: {
                        display: false
                     }
                  },
                  scales: {
                     y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                           color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                           callback: function(value) {
                              return value + '%';
                           }
                        }
                     },
                     x: {
                        grid: {
                           display: false
                        },
                        ticks: {
                           maxTicksLimit: 6
                        }
                     }
                  },
                  elements: {
                     point: {
                        radius: 3,
                        hoverRadius: 5
                     }
                  },
                  interaction: {
                     intersect: false,
                     mode: 'index'
                  }
               }
               });
               console.log('Read rate chart created successfully');
            } catch (error) {
               console.error('Failed to create read rate chart:', error);
            }

            // Notification Type Distribution Chart
            try {
               const typeCanvas = document.getElementById('notificationTypeChart');
               if (!typeCanvas) {
                  console.error('Notification type chart canvas element not found');
                  return;
               }

               const typeCtx = typeCanvas.getContext('2d');
               if (!typeCtx) {
                  console.error('Could not get 2D context for notification type chart');
                  return;
               }

               // Ensure we have data, use fallback if empty
               const labels = notificationTrends.typeDistribution.labels.length > 0
                  ? notificationTrends.typeDistribution.labels
                  : ['No Data'];
               const data = notificationTrends.typeDistribution.data.length > 0
                  ? notificationTrends.typeDistribution.data
                  : [1];

               const colors = [
                  'rgb(59, 130, 246)',   // blue
                  'rgb(239, 68, 68)',    // red
                  'rgb(245, 158, 11)',   // amber
                  'rgb(16, 185, 129)',   // green
                  'rgb(139, 92, 246)',   // violet
               ];

               new Chart(typeCtx, {
               type: 'doughnut',
               data: {
                  labels: labels,
                  datasets: [{
                     data: data,
                     backgroundColor: colors.slice(0, labels.length),
                     borderWidth: 2,
                     borderColor: '#fff',
                  }]
               },
               options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                     legend: {
                        position: 'bottom',
                        labels: {
                           padding: 20,
                           usePointStyle: true,
                        }
                     }
                  },
                  elements: {
                     arc: {
                        borderWidth: 2,
                     }
                  }
               }
               });
               console.log('Notification type chart created successfully');
            } catch (error) {
               console.error('Failed to create notification type chart:', error);
            }
         });
      </script>

       <!-- Last Updated Info -->
       <div class="text-center text-xs text-muted-foreground mt-6">
          Last updated: <span id="lastUpdated">{{lastUpdated}}</span> |
          Auto-refresh: <span class="text-green-600">Enabled</span> (5min interval)
       </div>

       <!-- Notification Type Distribution -->
       <div class="bg-card rounded-lg border border-border">
          <div class="p-6 border-b border-border">
             <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                {{{icon 'pie-chart' size='20' class='mr-2'}}}
                Notification Type Distribution
             </h3>
             <p class="text-sm text-muted-foreground mt-1">Breakdown of notification types by category</p>
          </div>
          <div class="p-6">
             <div class="h-64">
                <canvas id="notificationTypeChart" width="400" height="200"></canvas>
             </div>
          </div>
       </div>
     </div>
  </div>

      <!-- Notification Filters -->
     <div class="bg-card rounded-lg border border-border">
       <div class="p-6 border-b border-border">
         <div class="flex items-center justify-between">
           <h3 class="text-lg font-semibold text-card-foreground">Notifications</h3>
           <div class="flex items-center space-x-4">
             <select class="px-3 py-2 border border-input rounded-md focus:outline-none   focus:border-transparent">
               <option value="all">All Types</option>
               <option value="system">System</option>
               <option value="user">User Activity</option>
               <option value="security">Security</option>
             </select>
             <select class="px-3 py-2 border border-input rounded-md focus:outline-none   focus:border-transparent">
               <option value="all">All Status</option>
               <option value="unread">Unread</option>
               <option value="read">Read</option>
             </select>
           </div>
         </div>
       </div>

       <!-- Notification List -->
       <div class="divide-y divide-gray-200">
         {{#each notifications}}
         <div class="p-6 hover:bg-accent transition-colors {{#unless is_read}}bg-blue-50{{/unless}}">
           <div class="flex items-start space-x-4">
             <div class="flex-shrink-0">
               {{#if is_read}}
               <div class="w-2 h-2 bg-muted rounded-full"></div>
               {{else}}
               <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
               {{/if}}
             </div>
             <div class="flex-1 min-w-0">
               <div class="flex items-center justify-between">
                 <p class="text-sm font-medium text-card-foreground">{{title}}</p>
                 <p class="text-sm text-muted-foreground">{{created_at}}</p>
               </div>
               <p class="text-sm text-muted-foreground mt-1">{{message}}</p>
               <div class="flex items-center mt-2 space-x-4">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{#eq type "system"}}bg-destructive/10 text-destructive{{else if eq type "user"}}bg-primary/10 text-primary{{else if eq type "security"}}bg-warning/10 text-warning{{else}}bg-muted/50 text-muted-foreground{{/eq}}">
                   {{type}}
                 </span>
                 {{#if (eq priority "high")}}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-destructive/10 text-destructive">
                   High Priority
                 </span>
                 {{/if}}
               </div>
             </div>
             <div class="flex items-center space-x-2">
               {{#unless is_read}}
               <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                 Mark as Read
               </button>
               {{/unless}}
                <button class="text-muted-foreground hover:text-muted-foreground">
                  {{{icon 'more-vertical' size='16'}}}
                </button>
             </div>
           </div>
         </div>
         {{/each}}
       </div>

       {{#if (gt notifications.length 0)}}
       <!-- Pagination -->
       <div class="px-6 py-4 border-t border-border">
         <div class="flex items-center justify-between">
           <div class="text-sm text-card-foreground">
             Showing {{pagination.start}} to {{pagination.end}} of {{pagination.total}} notifications
           </div>
           <div class="flex items-center space-x-2">
             {{#if pagination.hasPrev}}
             <a href="?page={{pagination.prevPage}}" class="px-3 py-2 text-sm font-medium text-muted-foreground bg-card border border-input rounded-md hover:bg-accent">
               Previous
             </a>
             {{/if}}
             {{#each pagination.pages}}
             <a href="?page={{this}}" class="px-3 py-2 text-sm font-medium {{#if (eq this ../pagination.currentPage)}}text-primary bg-accent border-primary{{else}}text-muted-foreground bg-card border-input{{/if}} border rounded-md hover:bg-accent">
               {{this}}
             </a>
             {{/each}}
             {{#if pagination.hasNext}}
             <a href="?page={{pagination.nextPage}}" class="px-3 py-2 text-sm font-medium text-muted-foreground bg-card border border-input rounded-md hover:bg-accent">
               Next
             </a>
             {{/if}}
           </div>
         </div>
       </div>
       {{else}}
       <!-- Empty State -->
       <div class="px-6 py-12 text-center">
{{{icon 'bell' size='48' class='mx-auto text-muted-foreground'}}}
         <h3 class="mt-2 text-sm font-medium text-card-foreground">No notifications</h3>
         <p class="mt-1 text-sm text-muted-foreground">You're all caught up! Check back later for new notifications.</p>
       </div>
       {{/if}}
     </div>

     <!-- Bulk Actions -->
     {{#if notifications.length}}
     <div class="bg-card rounded-lg border border-border p-6">
       <div class="flex items-center justify-between">
         <div>
           <h3 class="text-lg font-semibold text-card-foreground">Bulk Actions</h3>
           <p class="text-sm text-muted-foreground">Perform actions on multiple notifications</p>
         </div>
         <div class="flex items-center space-x-4">
           <button class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
             Mark Selected as Read
           </button>
           <button class="px-4 py-2 bg-destructive text-destructive-foreground rounded-lg hover:bg-destructive/90 transition-colors">
             Delete Selected
           </button>
         </div>
       </div>
     </div>
     {{/if}}
   </div>
</div>