<!-- Activity Management Content -->
<div id="activity-content" class="max-w-7xl mx-auto rounded-xl overflow-hidden flex flex-col mx-4 my-4">

    <!-- Page Header -->
    {{> page-header title="Activity Management Dashboard" description="Comprehensive monitoring and analytics of system activity, user engagement, and performance metrics" border=true}}

    <div class="p-6 space-y-8">
       <!-- Critical Status Overview -->
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Total Activities -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Total Activities</p>
                   <p class="text-2xl font-bold text-blue-600">{{activityAnalytics.totalActivities}}</p>
                   <p class="text-xs text-muted-foreground">{{activityStats.today}} today</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                   {{{icon 'bar-chart-3' size='24' class='text-blue-600'}}}
                </div>
             </div>
          </div>

          <!-- Success Rate -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Success Rate</p>
                   <p class="text-2xl font-bold text-green-600">{{activityAnalytics.successRate}}%</p>
                   <p class="text-xs text-muted-foreground">{{activityStats.failed}} failed</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                   {{{icon 'check-circle' size='24' class='text-green-600'}}}
                </div>
             </div>
          </div>

          <!-- Active Users -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Active Users</p>
                   <p class="text-2xl font-bold text-purple-600">{{activityAnalytics.uniqueUsers}}</p>
                   <p class="text-xs text-muted-foreground">This session</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                   {{{icon 'users' size='24' class='text-purple-600'}}}
                </div>
             </div>
          </div>

          <!-- Response Time -->
          <div class="bg-card rounded-lg border border-border p-6">
             <div class="flex items-center justify-between">
                <div>
                   <p class="text-sm font-medium text-muted-foreground">Avg Response Time</p>
                   <p class="text-2xl font-bold text-orange-600">{{activityAnalytics.avgResponseTime}}</p>
                   <p class="text-xs text-muted-foreground">System average</p>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                   {{{icon 'zap' size='24' class='text-orange-600'}}}
                </div>
             </div>
          </div>
       </div>

       <!-- Activity Analytics & Performance -->
       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Activity Types Overview -->
          <div class="bg-card rounded-lg border border-border">
             <div class="p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                   {{{icon 'pie-chart' size='20' class='mr-2'}}}
                   Activity Types
                </h3>
             </div>
             <div class="p-6 space-y-3">
                {{#each activityAnalytics.topActivityTypes}}
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground capitalize">{{type}}</span>
                   <span class="text-sm text-muted-foreground">{{count}}</span>
                </div>
                {{/each}}
             </div>
          </div>

          <!-- Performance Metrics -->
          <div class="bg-card rounded-lg border border-border">
             <div class="p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                   {{{icon 'trending-up' size='20' class='mr-2'}}}
                   Performance Metrics
                </h3>
             </div>
             <div class="p-6 space-y-3">
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Success Rate</span>
                   <span class="text-sm text-muted-foreground">{{activityAnalytics.successRate}}%</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Active Users</span>
                   <span class="text-sm text-muted-foreground">{{activityAnalytics.uniqueUsers}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Avg Response</span>
                   <span class="text-sm text-muted-foreground">{{activityAnalytics.avgResponseTime}}</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Peak Hours</span>
                   <span class="text-sm text-muted-foreground">{{activityAnalytics.peakHours.length}} hours</span>
                </div>
             </div>
          </div>

          <!-- System Health -->
          <div class="bg-card rounded-lg border border-border">
             <div class="p-6 border-b border-border">
                <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                   {{{icon 'shield-check' size='20' class='mr-2'}}}
                   System Health
                </h3>
             </div>
             <div class="p-6 space-y-3">
                <div class="flex items-center justify-between">
                   <span class="text-sm font-medium text-card-foreground">Activity Status</span>
                   <div class="flex items-center">
                      <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-2"></div>
                      <span class="text-sm text-green-600 font-medium">Healthy</span>
                   </div>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Error Rate</span>
                   <span class="text-sm text-muted-foreground">{{#if activityStats.failed}}{{math activityStats.failed '/' activityStats.total '*' 100}}{{else}}0{{/if}}%</span>
                </div>
                <div class="flex justify-between">
                   <span class="text-sm font-medium text-card-foreground">Load Status</span>
                   <span class="text-sm text-muted-foreground">Normal</span>
                </div>
             </div>
          </div>
       </div>

       <!-- Activity Trends -->
       <div class="bg-card rounded-lg border border-border">
          <div class="p-6 border-b border-border">
             <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                {{{icon 'trending-up' size='20' class='mr-2'}}}
                Activity Trends
             </h3>
             <p class="text-sm text-muted-foreground mt-1">Activity volume and error rates over the last 24 hours</p>
          </div>
          <div class="p-6">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Activity Volume Trend -->
                <div>
                   <h4 class="text-sm font-medium text-card-foreground mb-3 flex items-center">
                      {{{icon 'bar-chart-3' size='16' class='mr-2 text-blue-600'}}}
                      Activity Volume (24h)
                   </h4>
                    <div class="h-48">
                       <canvas id="activityVolumeChart" width="400" height="200"></canvas>
                    </div>
                   <div class="mt-2 text-center">
                      <span class="text-xs text-muted-foreground">Peak: </span>
                      <span class="text-xs font-medium text-blue-600">{{math (max activityTrends.volumeHistory.data) }}</span>
                   </div>
                </div>

                <!-- Error Rate Trend -->
                <div>
                   <h4 class="text-sm font-medium text-card-foreground mb-3 flex items-center">
                      {{{icon 'alert-triangle' size='16' class='mr-2 text-red-600'}}}
                      Error Rate (%)
                   </h4>
                    <div class="h-48">
                       <canvas id="errorRateChart" width="400" height="200"></canvas>
                    </div>
                   <div class="mt-2 text-center">
                      <span class="text-xs text-muted-foreground">Current: </span>
                      <span class="text-xs font-medium text-red-600">{{math (last activityTrends.errorRateHistory.data) }}%</span>
      </div>

      <!-- Chart.js Script -->
      <script src="/js/chart.umd.js"></script>
      <script>
         document.addEventListener('DOMContentLoaded', function() {
            console.log('Activity Management page loaded, initializing charts...');

            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
               console.error('Chart.js not loaded, charts will not display');
               return;
            }

            const activityTrends = {{{json activityTrends}}} || {};
            console.log('Activity trends loaded:', activityTrends);
            console.log('Activity trends keys:', Object.keys(activityTrends));

            // Activity Volume Chart
            try {
               const volumeCanvas = document.getElementById('activityVolumeChart');
               if (!volumeCanvas) {
                  console.error('Activity volume chart canvas element not found');
                  return;
               }

               const volumeCtx = volumeCanvas.getContext('2d');
               if (!volumeCtx) {
                  console.error('Could not get 2D context for activity volume chart');
                  return;
               }

               new Chart(volumeCtx, {
               type: 'line',
               data: {
                  labels: activityTrends.volumeHistory.labels,
                  datasets: [{
                     label: 'Activity Volume',
                     data: activityTrends.volumeHistory.data,
                      borderColor: 'rgb(59, 130, 246)',
                      backgroundColor: 'rgba(59, 130, 246, 0.1)',
                      tension: 0.4,
                      fill: true,
                      pointBackgroundColor: 'rgb(59, 130, 246)',
                      pointBorderColor: '#fff',
                      pointBorderWidth: 2,
                   }]
                },
                options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   aspectRatio: 2,
                   plugins: {
                     legend: {
                        display: false
                     }
                  },
                  scales: {
                     y: {
                        beginAtZero: true,
                        grid: {
                           color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                           callback: function(value) {
                              return value;
                           }
                        }
                     },
                     x: {
                        grid: {
                           display: false
                        },
                        ticks: {
                           maxTicksLimit: 6
                        }
                     }
                  },
                  elements: {
                     point: {
                        radius: 3,
                        hoverRadius: 5
                     }
                  },
                  interaction: {
                     intersect: false,
                     mode: 'index'
                  }
               }
               });
               console.log('Activity volume chart created successfully');
            } catch (error) {
               console.error('Failed to create activity volume chart:', error);
            }

            // Error Rate Chart
            try {
               const errorCanvas = document.getElementById('errorRateChart');
               if (!errorCanvas) {
                  console.error('Error rate chart canvas element not found');
                  return;
               }

               const errorCtx = errorCanvas.getContext('2d');
               if (!errorCtx) {
                  console.error('Could not get 2D context for error rate chart');
                  return;
               }

               new Chart(errorCtx, {
               type: 'line',
               data: {
                  labels: activityTrends.errorRateHistory.labels,
                  datasets: [{
                     label: 'Error Rate (%)',
                     data: activityTrends.errorRateHistory.data,
                      borderColor: 'rgb(239, 68, 68)',
                      backgroundColor: 'rgba(239, 68, 68, 0.1)',
                      tension: 0.4,
                      fill: true,
                      pointBackgroundColor: 'rgb(239, 68, 68)',
                      pointBorderColor: '#fff',
                      pointBorderWidth: 2,
                   }]
                },
                options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   aspectRatio: 2,
                   plugins: {
                     legend: {
                        display: false
                     }
                  },
                  scales: {
                     y: {
                        beginAtZero: true,
                        max: 10,
                        grid: {
                           color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                           callback: function(value) {
                              return value + '%';
                           }
                        }
                     },
                     x: {
                        grid: {
                           display: false
                        },
                        ticks: {
                           maxTicksLimit: 6
                        }
                     }
                  },
                  elements: {
                     point: {
                        radius: 3,
                        hoverRadius: 5
                     }
                  },
                  interaction: {
                     intersect: false,
                     mode: 'index'
                  }
               }
               });
               console.log('Error rate chart created successfully');
            } catch (error) {
               console.error('Failed to create error rate chart:', error);
            }

            // Activity Type Distribution Chart
            try {
               const typeCanvas = document.getElementById('activityTypeChart');
               if (!typeCanvas) {
                  console.error('Activity type chart canvas element not found');
                  return;
               }

               const typeCtx = typeCanvas.getContext('2d');
               if (!typeCtx) {
                  console.error('Could not get 2D context for activity type chart');
                  return;
               }

               // Ensure we have data, use fallback if empty
               const labels = activityTrends.typeDistribution.labels.length > 0
                  ? activityTrends.typeDistribution.labels
                  : ['No Data'];
               const data = activityTrends.typeDistribution.data.length > 0
                  ? activityTrends.typeDistribution.data
                  : [1];

               const colors = [
                  'rgb(59, 130, 246)',   // blue
                  'rgb(16, 185, 129)',   // green
                  'rgb(245, 158, 11)',   // amber
                  'rgb(239, 68, 68)',    // red
                  'rgb(139, 92, 246)',   // violet
                  'rgb(236, 72, 153)',   // pink
               ];

               new Chart(typeCtx, {
               type: 'doughnut',
               data: {
                  labels: labels,
                  datasets: [{
                     data: data,
                     backgroundColor: colors.slice(0, labels.length),
                     borderWidth: 2,
                     borderColor: '#fff',
                  }]
               },
               options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                     legend: {
                        position: 'bottom',
                        labels: {
                           padding: 20,
                           usePointStyle: true,
                        }
                     }
                  },
                  elements: {
                     arc: {
                        borderWidth: 2,
                     }
                  }
               }
               });
               console.log('Activity type chart created successfully');
            } catch (error) {
               console.error('Failed to create activity type chart:', error);
            }
         });
      </script>

      <!-- Debug Info -->
      <div style="display: none;">
         Activity Trends: {{{json activityTrends}}}
         Activity Analytics: {{{json activityAnalytics}}}
         Test Math: {{math 2 '+' 2}}
         Test Max: {{max (array 1 2 3 4 5)}}
         Test Last: {{last (array 1 2 3 4 5)}}
      </div>

       <!-- Last Updated Info -->
       <div class="text-center text-xs text-muted-foreground mt-6">
          Last updated: <span id="lastUpdated">{{lastUpdated}}</span> |
          Auto-refresh: <span class="text-green-600">Enabled</span> (5min interval)
       </div>

       <!-- Activity Type Distribution -->
       <div class="bg-card rounded-lg border border-border">
          <div class="p-6 border-b border-border">
             <h3 class="text-lg font-semibold text-card-foreground flex items-center">
                {{{icon 'pie-chart' size='20' class='mr-2'}}}
                Activity Type Distribution
             </h3>
             <p class="text-sm text-muted-foreground mt-1">Breakdown of activity types in the current session</p>
          </div>
          <div class="p-6">
             <div class="h-64">
                <canvas id="activityTypeChart" width="400" height="200"></canvas>
             </div>
          </div>
       </div>
     </div>
  </div>

        <!-- Activity Filters and Search -->
      <div class="bg-card rounded-lg border border-border">
        <div class="p-6 border-b border-border">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-card-foreground">Activity Log</h3>
            <div class="flex items-center space-x-4">
              <div class="relative">
                <input type="text"
                       name="search"
                       value="{{query.search}}"
                       placeholder="Search activities..."
                       class="w-64 pl-4 pr-4 py-2 border border-input rounded-md focus:outline-none focus:border-transparent"
                       hx-get="/admin/other-pages/activity"
                       hx-target="#activity-content"
                       hx-trigger="input changed delay:300ms, keyup[key=='Enter']"
                       hx-vals='{"category": "{{query.category}}", "status": "{{query.status}}"}'>
                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                   {{{icon 'search' size='20' class='text-muted-foreground'}}}
                 </div>
              </div>
              <select name="category"
                      class="px-3 py-2 border border-input rounded-md focus:outline-none focus:border-transparent"
                      hx-get="/admin/other-pages/activity"
                      hx-target="#activity-content"
                      hx-vals='{"search": "{{query.search}}", "status": "{{query.status}}"}'>
                <option value="all" {{#eq query.category "all"}}selected{{/eq}}>All Types</option>
                <option value="login" {{#eq query.category "login"}}selected{{/eq}}>Login</option>
                <option value="user" {{#eq query.category "user"}}selected{{/eq}}>User Management</option>
                <option value="system" {{#eq query.category "system"}}selected{{/eq}}>System</option>
                <option value="security" {{#eq query.category "security"}}selected{{/eq}}>Security</option>
                <option value="api" {{#eq query.category "api"}}selected{{/eq}}>API</option>
                <option value="database" {{#eq query.category "database"}}selected{{/eq}}>Database</option>
              </select>
              <select name="status"
                      class="px-3 py-2 border border-input rounded-md focus:outline-none focus:border-transparent"
                      hx-get="/admin/other-pages/activity"
                      hx-target="#activity-content"
                      hx-vals='{"search": "{{query.search}}", "category": "{{query.category}}"}'>
                <option value="all" {{#eq query.status "all"}}selected{{/eq}}>All Status</option>
                <option value="success" {{#eq query.status "success"}}selected{{/eq}}>Success</option>
                <option value="failed" {{#eq query.status "failed"}}selected{{/eq}}>Failed</option>
                <option value="warning" {{#eq query.status "warning"}}selected{{/eq}}>Warning</option>
                <option value="error" {{#eq query.status "error"}}selected{{/eq}}>Error</option>
              </select>
            </div>
          </div>
        </div>

       <!-- Activity Timeline -->
       <div class="p-6">
         <div class="flow-root">
           <ul role="list" class="-mb-8">
             {{#each activities}}
             <li>
               <div class="relative pb-8">
                 {{#unless @first}}
                 <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-muted" aria-hidden="true"></span>
                 {{/unless}}
                 <div class="relative flex space-x-3">
                   <div>
                      <span class="h-8 w-8 rounded-full flex items-center justify-center ring-8 ring-background {{#eq status "success"}}bg-success{{else if eq status "failed"}}bg-destructive{{else if eq status "warning"}}bg-warning{{else}}bg-primary{{/eq}}">
                        {{#eq activity_type "login"}}
                        {{{icon 'log-in' size='20' class='text-white'}}}
                        {{else if eq activity_type "user"}}
                        {{{icon 'user' size='20' class='text-white'}}}
                        {{else if eq activity_type "system"}}
                        {{{icon 'server' size='20' class='text-white'}}}
                        {{else}}
                        {{{icon 'lock' size='20' class='text-white'}}}
                        {{/eq}}
                     </span>
                   </div>
                   <div class="min-w-0 flex-1 pt-1.5">
                     <div class="flex items-center justify-between">
                       <p class="text-sm font-medium text-card-foreground">{{action}}</p>
                       <p class="text-sm text-muted-foreground">{{created_at}}</p>
                     </div>
                     <p class="text-sm text-muted-foreground mt-1">{{description}}</p>
                     <div class="flex items-center mt-2 space-x-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{#eq activity_type "login"}}bg-primary/10 text-primary{{else if eq activity_type "user"}}bg-success/10 text-success{{else if eq activity_type "system"}}bg-secondary/10 text-secondary{{else if eq activity_type "security"}}bg-destructive/10 text-destructive{{else}}bg-muted/50 text-muted-foreground{{/eq}}">
                         {{activity_type}}
                       </span>
                       {{#if user_id}}
                       <span class="text-sm text-muted-foreground">User ID: {{user_id}}</span>
                       {{/if}}
                       {{#if ip_address}}
                       <span class="text-sm text-muted-foreground">{{ip_address}}</span>
                       {{/if}}
                       {{#if browser}}
                       <span class="text-sm text-muted-foreground">{{browser}}</span>
      {{/if}}
    </div>
 </div>
</div>
                 </div>
               </div>
             </li>
             {{/each}}
           </ul>
         </div>

         {{#if (eq activities.length 0)}}
         <!-- Empty State -->
         <div class="text-center py-12">
{{{icon 'clipboard-list' size='48' class='mx-auto text-muted-foreground'}}}
           <h3 class="mt-2 text-sm font-medium text-card-foreground">No activity found</h3>
           <p class="mt-1 text-sm text-muted-foreground">No activity has been logged yet.</p>
         </div>
         {{/if}}
       </div>

        {{#if activities.length}}
        <!-- Pagination -->
        <div class="px-6 py-4 border-t border-border">
          <div class="flex items-center justify-between">
            <div class="text-sm text-card-foreground">
              Showing {{pagination.start}} to {{pagination.end}} of {{pagination.total}} activities
            </div>
            <div class="flex items-center space-x-2">
              {{#if pagination.hasPrev}}
              <a href="?page={{pagination.prevPage}}&search={{query.search}}&category={{query.category}}&status={{query.status}}"
                 class="px-3 py-2 text-sm font-medium text-muted-foreground bg-card border border-input rounded-md hover:bg-accent">
                Previous
              </a>
              {{/if}}
              {{#each pagination.pages}}
              <a href="?page={{this}}&search={{query.search}}&category={{query.category}}&status={{query.status}}"
                 class="px-3 py-2 text-sm font-medium {{#if (eq this ../pagination.currentPage)}}text-primary bg-accent border-primary{{else}}text-muted-foreground bg-card border-input{{/if}} border rounded-md hover:bg-accent">
                {{this}}
              </a>
              {{/each}}
              {{#if pagination.hasNext}}
              <a href="?page={{pagination.nextPage}}&search={{query.search}}&category={{query.category}}&status={{query.status}}"
                 class="px-3 py-2 text-sm font-medium text-muted-foreground bg-card border border-input rounded-md hover:bg-accent">
                Next
              </a>
              {{/if}}
            </div>
          </div>
        </div>
        {{/if}}
     </div>

     <!-- Export Options -->
     {{#if activities.length}}
     <div class="bg-card rounded-lg border border-border p-6">
       <div class="flex items-center justify-between">
         <div>
           <h3 class="text-lg font-semibold text-card-foreground">Export Activity Log</h3>
           <p class="text-sm text-muted-foreground">Download activity logs for auditing and compliance</p>
         </div>
          <div class="flex items-center space-x-4">
             <a href="/admin/other-pages/activity/export/csv?search={{query.search}}&category={{query.category}}&status={{query.status}}"
                class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors inline-flex items-center">
               {{{icon 'download' size='16' class='mr-2'}}}
               Export CSV
             </a>
             <a href="/admin/other-pages/activity/export/json?search={{query.search}}&category={{query.category}}&status={{query.status}}"
                class="px-4 py-2 bg-success text-success-foreground rounded-lg hover:bg-success/90 transition-colors inline-flex items-center">
               {{{icon 'file-text' size='16' class='mr-2'}}}
               Export JSON
             </a>
          </div>
       </div>
     </div>
     {{/if}}
   </div>
</div>