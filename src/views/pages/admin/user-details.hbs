<div class='flex flex-col gap-4 lg:gap-6'>
  <!-- Header -->
  <div class='flex items-center justify-between'>
    <div class='grid gap-1'>
      <h1 class='font-heading text-2xl font-semibold text-foreground dark:text-white'>User Details</h1>
      <p class='text-base text-muted-foreground'>{{user.firstName}} {{user.lastName}} ({{user.email}})</p>
    </div>
    <div class='flex gap-2'>
      <button onclick="window.history.back()" class='inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2'>
        ‚Üê Back to Users
      </button>
    </div>
  </div>

  <!-- User Info Cards -->
  <div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'>
    <!-- Basic Information -->
    <div class='rounded-md bg-card text-card-foreground shadow-sm p-6' style='box-shadow: rgba(0, 0, 0, 0.15) 0px 1px 2px 0px;'>
      <h3 class='text-lg font-medium text-foreground mb-4'>Basic Information</h3>
      <div class='space-y-3'>
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Full Name</label>
          <p class='text-sm text-foreground'>{{user.firstName}} {{user.lastName}}</p>
        </div>
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Email</label>
          <p class='text-sm text-foreground'>{{user.email}}</p>
        </div>
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Role</label>
          <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800'>
            {{user.role}}
          </span>
        </div>
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Status</label>
          <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{#if (eq user.status 'active')}}bg-green-100 text-green-800{{else}}bg-red-100 text-red-800{{/if}}'>
            {{user.status}}
          </span>
        </div>
        {{#if user.banned}}
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Banned</label>
          <span class='inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800'>
            Yes {{#if user.bannedReason}}- {{user.bannedReason}}{{/if}}
          </span>
        </div>
        {{/if}}
      </div>
    </div>

    <!-- Account Details -->
    <div class='rounded-md bg-card text-card-foreground shadow-sm p-6' style='box-shadow: rgba(0, 0, 0, 0.15) 0px 1px 2px 0px;'>
      <h3 class='text-lg font-medium text-foreground mb-4'>Account Details</h3>
      <div class='space-y-3'>
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Credits</label>
          <p class='text-lg font-semibold text-foreground'>{{user.credits}}</p>
        </div>
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Theme</label>
          <p class='text-sm text-foreground'>{{user.theme}}</p>
        </div>
        {{#if user.bio}}
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Bio</label>
          <p class='text-sm text-foreground'>{{user.bio}}</p>
        </div>
        {{/if}}
      </div>
    </div>

    <!-- Timestamps -->
    <div class='rounded-md bg-card text-card-foreground shadow-sm p-6' style='box-shadow: rgba(0, 0, 0, 0.15) 0px 1px 2px 0px;'>
      <h3 class='text-lg font-medium text-foreground mb-4'>Timestamps</h3>
      <div class='space-y-3'>
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Created</label>
          <p class='text-sm text-foreground' id="createdAt">{{user.createdAt}}</p>
        </div>
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Last Updated</label>
          <p class='text-sm text-foreground' id="updatedAt">{{user.updatedAt}}</p>
        </div>
        {{#if user.bannedAt}}
        <div>
          <label class='block text-sm font-medium text-muted-foreground'>Banned At</label>
          <p class='text-sm text-foreground' id="bannedAt">{{user.bannedAt}}</p>
        </div>
        {{/if}}
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class='rounded-md bg-card text-card-foreground shadow-sm p-6' style='box-shadow: rgba(0, 0, 0, 0.15) 0px 1px 2px 0px;'>
    <h3 class='text-lg font-medium text-foreground mb-4'>Quick Actions</h3>
    <div class='flex flex-wrap gap-2'>
      <button onclick="editUserRole({{user.id}})" class='inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2'>
        Edit Role
      </button>
      <button onclick="manageCredits({{user.id}}, '{{user.fullName}}', {{user.credits}})" class='inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2'>
        Manage Credits
      </button>
      <button onclick="resetPassword({{user.id}}, '{{user.fullName}}')" class='inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-orange-600 text-white shadow hover:bg-orange-700 h-9 px-4 py-2'>
        Reset Password
      </button>
      <button onclick="toggleStatus({{user.id}}, '{{user.status}}')" class='inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2'>
        {{#if (eq user.status 'active')}}Deactivate{{else}}Activate{{/if}}
      </button>
      {{#unless (eq user.role 'admin')}}
      <button onclick="toggleBan({{user.id}}, {{user.banned}}, '{{user.fullName}}')" class='inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 {{#if user.banned}}bg-green-600 hover:bg-green-700{{else}}bg-orange-600 hover:bg-orange-700{{/if}} text-white shadow h-9 px-4 py-2'>
        {{#if user.banned}}Unban{{else}}Ban{{/if}}
      </button>
      <button onclick="deleteUser({{user.id}}, '{{user.fullName}}')" class='inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground shadow hover:bg-destructive/90 h-9 px-4 py-2'>
        Delete User
      </button>
      {{/unless}}
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Edit User Role</h3>
      <form id="editUserForm">
        <input type="hidden" id="editUserId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Role</label>
          <select id="editUserRole" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Manage Credits Modal -->
<div id="creditsModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Manage Credits</h3>
      <p id="creditsUserName" class="text-sm text-muted-foreground mb-4"></p>
      <form id="creditsForm">
        <input type="hidden" id="creditsUserId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Current Credits</label>
          <p id="currentCredits" class="text-lg font-semibold text-foreground"></p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">New Credits Amount</label>
          <input type="number" id="newCredits" min="0" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeCreditsModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update Credits</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Ban User Modal -->
<div id="banModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4" id="banModalTitle">Ban User</h3>
      <p id="banUserName" class="text-sm text-muted-foreground mb-4"></p>
      <form id="banForm">
        <input type="hidden" id="banUserId">
        <input type="hidden" id="banAction">
        <div class="mb-4" id="banReasonDiv">
          <label class="block text-sm font-medium text-foreground mb-2">Reason for ban</label>
          <textarea id="banReason" rows="3" class="flex min-h-[80px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="Enter reason for banning this user..."></textarea>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBanModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" id="banSubmitBtn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground shadow hover:bg-destructive/90 h-9 px-4 py-2">Ban User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Reset Password</h3>
      <p id="resetPasswordUserName" class="text-sm text-muted-foreground mb-4"></p>
      <div class="mb-4">
        <label class="block text-sm font-medium text-foreground mb-2">New Temporary Password</label>
        <div class="flex gap-2">
          <input type="text" id="tempPassword" readonly class="flex h-9 w-full rounded-md border border-input bg-muted px-3 py-1 text-sm shadow-sm">
          <button onclick="copyPassword()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-3 py-2">Copy</button>
        </div>
        <p class="text-xs text-muted-foreground mt-1">Please provide this password to the user. They should change it immediately after logging in.</p>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeResetPasswordModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// Helper functions for date formatting
function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Format dates on page load
document.addEventListener('DOMContentLoaded', function() {
  const createdAtEl = document.getElementById('createdAt');
  const updatedAtEl = document.getElementById('updatedAt');
  const bannedAtEl = document.getElementById('bannedAt');

  if (createdAtEl && createdAtEl.textContent) {
    createdAtEl.textContent = formatDate(createdAtEl.textContent.trim());
  }
  if (updatedAtEl && updatedAtEl.textContent) {
    updatedAtEl.textContent = formatDate(updatedAtEl.textContent.trim());
  }
  if (bannedAtEl && bannedAtEl.textContent) {
    bannedAtEl.textContent = formatDate(bannedAtEl.textContent.trim());
  }
});

// Modal functions
function editUserRole(userId) {
  // Fetch user data and populate modal
  fetch(`/admin/api/users/${userId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('editUserId').value = data.user.id;
        document.getElementById('editUserRole').value = data.user.role;
        document.getElementById('editUserModal').classList.remove('hidden');
      }
    });
}

function closeEditModal() {
  document.getElementById('editUserModal').classList.add('hidden');
}

function manageCredits(userId, userName, currentCredits) {
  document.getElementById('creditsUserId').value = userId;
  document.getElementById('creditsUserName').textContent = `User: ${userName}`;
  document.getElementById('currentCredits').textContent = currentCredits;
  document.getElementById('newCredits').value = currentCredits;
  document.getElementById('creditsModal').classList.remove('hidden');
}

function closeCreditsModal() {
  document.getElementById('creditsModal').classList.add('hidden');
}

 function toggleStatus(userId, currentStatus) {
   const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
   const action = newStatus === 'active' ? 'activate' : 'deactivate';

   Toast.warning(`Are you sure you want to ${action} this user?`);
   fetch(`/admin/api/users/${userId}/status`, {
     method: 'PUT',
     headers: {
       'Content-Type': 'application/json',
     },
     body: JSON.stringify({ status: newStatus }),
   })
   .then(response => response.json())
   .then(data => {
     if (data.success) {
       location.reload();
     } else {
       Toast.error('Error updating user status: ' + data.error);
     }
   });
 }

function toggleBan(userId, currentlyBanned, userName) {
  document.getElementById('banUserId').value = userId;
  document.getElementById('banUserName').textContent = `User: ${userName}`;
  document.getElementById('banAction').value = currentlyBanned ? 'unban' : 'ban';

  if (currentlyBanned) {
    document.getElementById('banModalTitle').textContent = 'Unban User';
    document.getElementById('banReasonDiv').style.display = 'none';
    document.getElementById('banSubmitBtn').textContent = 'Unban User';
    document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-destructive', 'bg-green-600').replace('hover:bg-destructive/90', 'hover:bg-green-700');
  } else {
    document.getElementById('banModalTitle').textContent = 'Ban User';
    document.getElementById('banReasonDiv').style.display = 'block';
    document.getElementById('banSubmitBtn').textContent = 'Ban User';
    document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-green-600', 'bg-destructive').replace('hover:bg-green-700', 'hover:bg-destructive/90');
  }

  document.getElementById('banModal').classList.remove('hidden');
}

function closeBanModal() {
  document.getElementById('banModal').classList.add('hidden');
}

function resetPassword(userId, userName) {
  Toast.warning(`Are you sure you want to reset the password for ${userName}? A temporary password will be generated.`);
  fetch(`/admin/api/users/${userId}/reset-password`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById('resetPasswordUserName').textContent = `User: ${userName}`;
      document.getElementById('tempPassword').value = data.result.tempPassword;
      document.getElementById('resetPasswordModal').classList.remove('hidden');
    } else {
      Toast.error('Error resetting password: ' + data.error);
    }
  });
}

function closeResetPasswordModal() {
  document.getElementById('resetPasswordModal').classList.add('hidden');
}

function copyPassword() {
  const passwordField = document.getElementById('tempPassword');
  passwordField.select();
  document.execCommand('copy');
  // Optional: Show a brief success message
  const copyBtn = passwordField.nextElementSibling;
  const originalText = copyBtn.textContent;
  copyBtn.textContent = 'Copied!';
  setTimeout(() => {
    copyBtn.textContent = originalText;
  }, 2000);
}

function deleteUser(userId, userName) {
  Toast.warning(`Are you sure you want to delete user ${userName}? This action cannot be undone.`);
  fetch(`/admin/api/users/${userId}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.href = '/admin/users';
    } else {
      Toast.error('Error deleting user: ' + data.error);
    }
  });
}

// Form handlers
document.getElementById('editUserForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const userId = document.getElementById('editUserId').value;
  const role = document.getElementById('editUserRole').value;

  fetch(`/admin/api/users/${userId}/role`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ role }),
  })
  .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeEditModal();
        location.reload();
      } else {
        Toast.error('Error updating user: ' + data.error);
      }
    });
});

document.getElementById('creditsForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const userId = document.getElementById('creditsUserId').value;
  const credits = document.getElementById('newCredits').value;

  fetch(`/admin/api/users/${userId}/credits`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ credits: parseInt(credits) }),
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeCreditsModal();
      location.reload();
    } else {
      Toast.error('Error updating credits: ' + data.error);
    }
  });
});

document.getElementById('banForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const userId = document.getElementById('banUserId').value;
  const action = document.getElementById('banAction').value;
  const reason = document.getElementById('banReason').value;

  const banned = action === 'ban';

  fetch(`/admin/api/users/${userId}/banned`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ banned, reason }),
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeBanModal();
      location.reload();
    } else {
      Toast.error('Error updating ban status: ' + data.error);
    }
  });
});
</script>