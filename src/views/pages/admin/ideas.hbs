{{> ui/_data-table
  title="Ideas Management"
  description="Manage and oversee all ideas in the system"
  headers=(array
    (hash key="title" label="Title")
    (hash key="type" label="Type")
    (hash key="rating" label="Rating")
    (hash key="isFavorite" label="Favorite")
    (hash key="createdAt" label="Created" class="hidden md:table-cell")
  )
  rows=ideas
  showCheckbox=true
  showActions=true
  actions=ideaActions
  filterBar=(hash
    searchPlaceholder="Search ideas..."
    searchValue=filters.search
    actions=(array
      (hash onclick="exportToCSV()" icon="Download" title="Export CSV")
      (hash onclick="location.reload()" icon="RefreshCw" title="Refresh")
    )
  )
  bulkActions=(array
    (hash text="Delete Selected" onclick="bulkDelete()" buttonId="bulkDeleteBtn")
  )
  pagination=pagination
  queryParams=(concat "?search=" filters.search)
}}

<!-- Include modal templates -->
{{> modals/_edit-idea-modal}}

<script>
  // Modal functions
  function editIdea(ideaId) {
    // Fetch idea data and populate modal
    fetch(`/admin/api/ideas/${ideaId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('editIdeaId').value = data.idea.id;
          document.getElementById('editIdeaTitle').value = data.idea.title;
          document.getElementById('editIdeaType').value = data.idea.type;
          document.getElementById('editIdeaRating').value = data.idea.rating;
          document.getElementById('editIdeaDescription').value = data.idea.description;
          document.getElementById('editIdeaModal').classList.remove('hidden');
        }
      });
  }

  function closeEditModal() {
    document.getElementById('editIdeaModal').classList.add('hidden');
  }

  function deleteIdea(ideaId, ideaTitle) {
    Toast.warning(`Are you sure you want to delete the idea "${ideaTitle}"? This action cannot be undone.`);
    fetch(`/admin/api/ideas/${ideaId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        Toast.error('Error deleting idea: ' + data.error);
      }
    });
  }

  function bulkDelete() {
    const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
    const count = checkboxes.length;

    Toast.warning(`Are you sure you want to delete ${count} idea${count > 1 ? 's' : ''}? This action cannot be undone.`);
    const ideaIds = Array.from(checkboxes).map(cb => cb.value);

    // Delete ideas one by one
    Promise.all(ideaIds.map(ideaId =>
      fetch(`/admin/api/ideas/${ideaId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(response => response.json())
    )).then(results => {
      const successCount = results.filter(r => r.success).length;
      Toast.success(`Successfully deleted ${successCount} out of ${count} ideas`);
      location.reload();
    });
  }

  // Form handlers
  document.getElementById('editIdeaForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const ideaId = document.getElementById('editIdeaId').value;
    const title = document.getElementById('editIdeaTitle').value;
    const type = document.getElementById('editIdeaType').value;
    const rating = parseInt(document.getElementById('editIdeaRating').value);
    const description = document.getElementById('editIdeaDescription').value;

    fetch(`/admin/api/ideas/${ideaId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ title, type, rating, description }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeEditModal();
        location.reload();
      } else {
        Toast.error('Error updating idea: ' + data.error);
      }
    });
  });
</script>