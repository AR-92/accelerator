 <div class="-m-4 lg:-m-6">
    <!-- Sub Navigation -->
    <div class="border-b border-gray-200 dark:border-gray-700 bg-background px-6">
      <div class="max-w-7xl mx-auto">
        <div class='flex w-full items-center gap-[16px] overflow-x-auto lg:gap-[48px]'>
          <a
            class='p-[10px] text-[16px] font-[500] {{#if (eq activeTab 'all')}}border-b border-primary text-black dark:text-white dark:border-white{{else}}text-gray-500 dark:text-gray-400{{/if}}'
            href='/admin/users?tab=all'
          >All Users</a>
          <a
            class='p-[10px] text-[16px] font-[500] {{#if (eq activeTab 'active')}}border-b border-primary text-black dark:text-white dark:border-white{{else}}text-gray-500 dark:text-gray-400{{/if}}'
            href='/admin/users?tab=active'
          >Active</a>
          <a
            class='p-[10px] text-[16px] font-[500] {{#if (eq activeTab 'banned')}}border-b border-primary text-black dark:text-white dark:border-white{{else}}text-gray-500 dark:text-gray-400{{/if}}'
            href='/admin/users?tab=banned'
          >Banned</a>
          <a
            class='p-[10px] text-[16px] font-[500] {{#if (eq activeTab 'admins')}}border-b border-primary text-black dark:text-white dark:border-white{{else}}text-gray-500 dark:text-gray-400{{/if}}'
            href='/admin/users?tab=admins'
          >Admins</a>
        </div>
      </div>
    </div>

    <div class='flex flex-col gap-4 lg:gap-6 p-4 lg:p-6'>

    <!-- Bootstrap Table Container -->
    <div class="bootstrap-table bootstrap3">
      <div class="fixed-table-toolbar">
        <div class="bs-bars pull-left">
          <div class="toolbar">
            <button onclick="openCreateUserModal()" class="btn btn-default">{{lucide 'Plus' 'w-4 h-4 mr-2'}}Create User</button>
            <button onclick="exportToCSV()" class="btn btn-default">{{lucide 'Download' 'w-4 h-4 mr-2'}}Export CSV</button>
          </div>
        </div>
        <div class="columns columns-right btn-group pull-right">
          <button class="btn btn-default" type="button" name="refresh" aria-label="Refresh" title="Refresh" onclick="location.reload()">
            {{lucide 'RefreshCw' 'w-4 h-4'}}
          </button>
          <div class="keep-open btn-group">
            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-label="Columns" title="Columns" aria-expanded="false">
              {{lucide 'Columns' 'w-4 h-4'}}
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu">
              <li class="dropdown-item-marker" role="menuitem">
                <label><input type="checkbox" data-field="select" value="0" checked="checked"> <span>Select</span></label>
              </li>
              <li class="dropdown-item-marker" role="menuitem">
                <label><input type="checkbox" data-field="user" value="1" checked="checked"> <span>User</span></label>
              </li>
              <li class="dropdown-item-marker" role="menuitem">
                <label><input type="checkbox" data-field="role" value="2" checked="checked"> <span>Role</span></label>
              </li>
              <li class="dropdown-item-marker" role="menuitem">
                <label><input type="checkbox" data-field="status" value="3" checked="checked"> <span>Status</span></label>
              </li>
              <li class="dropdown-item-marker" role="menuitem">
                <label><input type="checkbox" data-field="credits" value="4" checked="checked"> <span>Credits</span></label>
              </li>
              <li class="dropdown-item-marker" role="menuitem">
                <label><input type="checkbox" data-field="created" value="5" checked="checked"> <span>Created</span></label>
              </li>
              <li class="dropdown-item-marker" role="menuitem">
                <label><input type="checkbox" data-field="actions" value="6" checked="checked"> <span>Actions</span></label>
              </li>
            </ul>
          </div>
        </div>
        <div class="pull-right search input-group">
          <input class="form-control search-input" type="search" id="searchInput" aria-label="Search" placeholder="Search users..." autocomplete="off">
        </div>
      </div>

      <div class="fixed-table-container" style="padding-bottom: 0px;">
        <div class="fixed-table-header" style="display: none;"><table></table></div>
        <div class="fixed-table-body">
          <table id="users-table" class="table table-hover table-striped">
            <thead style="">
              <tr>
                <th data-field="select"><div class="th-inner">Select</div></th>
                <th data-field="user"><div class="th-inner sortable both">User</div></th>
                <th data-field="role"><div class="th-inner sortable both">Role</div></th>
                <th data-field="status"><div class="th-inner">Status</div></th>
                <th data-field="credits"><div class="th-inner sortable both">Credits</div></th>
                <th data-field="created"><div class="th-inner sortable both">Created</div></th>
                <th data-field="actions"><div class="th-inner">Actions</div></th>
              </tr>
            </thead>
            <tbody>
            {{#each users}}
            <tr data-index="{{@index}}">
              <td class="">
                <input type="checkbox" class="userCheckbox" value="{{id}}" data-user-id="{{id}}">
              </td>
              <td class="">
                <div class="text-sm font-medium">{{fullName}}</div>
                <div class="text-sm text-muted-foreground">{{email}}</div>
              </td>
              <td class="">{{role}}</td>
              <td class="">
                <span class="label {{#if (eq status 'active')}}label-success{{else}}label-danger{{/if}}">{{status}}</span>
                {{#if banned}}
                <span class="label label-danger">BANNED</span>
                {{/if}}
              </td>
              <td class="">{{credits}}</td>
              <td class="">{{formatDate createdAt}}</td>
              <td class="">
                <a rel="tooltip" title="View" class="table-action view" href="/admin/users/{{id}}">
                  <i class="fa fa-eye"></i>
                </a>
                <a rel="tooltip" title="Edit" class="table-action edit" href="javascript:void(0)" onclick="editUser({{id}})">
                  <i class="fa fa-edit"></i>
                </a>
                <a rel="tooltip" title="Manage Credits" class="table-action" href="javascript:void(0)" onclick="manageCredits({{id}}, '{{fullName}}', {{credits}})">
                  <i class="fa fa-dollar-sign"></i>
                </a>
                <a rel="tooltip" title="{{#if (eq status 'active')}}Deactivate{{else}}Activate{{/if}}" class="table-action {{#if (eq status 'active')}}remove{{else}}like{{/if}}" href="javascript:void(0)" onclick="toggleStatus({{id}}, '{{status}}')">
                  {{#if (eq status 'active')}}
                  <i class="fa fa-times-circle"></i>
                  {{else}}
                  <i class="fa fa-check-circle"></i>
                  {{/if}}
                </a>
                {{#unless (eq role 'admin')}}
                <a rel="tooltip" title="{{#if banned}}Unban{{else}}Ban{{/if}}" class="table-action {{#if banned}}like{{else}}remove{{/if}}" href="javascript:void(0)" onclick="toggleBan({{id}}, {{banned}}, '{{fullName}}')">
                  {{#if banned}}
                  <i class="fa fa-check-circle"></i>
                  {{else}}
                  <i class="fa fa-ban"></i>
                  {{/if}}
                </a>
                <a rel="tooltip" title="Delete" class="table-action remove" href="javascript:void(0)" onclick="deleteUser({{id}}, '{{fullName}}')">
                  <i class="fa fa-trash"></i>
                </a>
                {{/unless}}
              </td>
          </tr>
          {{/each}}
        </tbody>
          </table>
        </div>
        <div class="fixed-table-footer"></div>
      </div>

      <!-- Bulk Actions -->
      <div id="bulkActions" class="alert alert-info" style="margin-bottom: 0; display: none;">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span id="selectedCount">0 users selected</span>
            <span class="text-sm text-muted">Select users above to perform bulk actions</span>
          </div>
          <div class="flex gap-2">
            <button onclick="openBulkRoleModal()" id="bulkRoleBtn" class="btn btn-primary" disabled>
              {{lucide 'Edit' 'w-4 h-4 mr-2'}}
              Update Role
            </button>
            <button onclick="openBulkCreditsModal()" id="bulkCreditsBtn" class="btn btn-success" disabled>
              {{lucide 'DollarSign' 'w-4 h-4 mr-2'}}
              Update Credits
            </button>
            <button onclick="bulkDelete()" id="bulkDeleteBtn" class="btn btn-danger" disabled>
              {{lucide 'Trash2' 'w-4 h-4 mr-2'}}
              Delete Selected
            </button>
          </div>
        </div>
      </div>

      <div class="fixed-table-pagination">
        <div class="pull-left pagination-detail">
          <span class="pagination-info">Showing {{pagination.limit}} of {{pagination.total}} users</span>
          <div class="page-list">
            <div class="btn-group dropdown dropup">
              <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                <span class="page-size">{{pagination.limit}}</span>
                <span class="caret"></span>
              </button>
              <ul class="dropdown-menu" role="menu">
                <li role="menuitem" class="{{#if (eq pagination.limit 10)}}active{{/if}}"><a href="?limit=10&page=1">10</a></li>
                <li role="menuitem" class="{{#if (eq pagination.limit 20)}}active{{/if}}"><a href="?limit=20&page=1">20</a></li>
                <li role="menuitem" class="{{#if (eq pagination.limit 50)}}active{{/if}}"><a href="?limit=50&page=1">50</a></li>
                <li role="menuitem" class="{{#if (eq pagination.limit 100)}}active{{/if}}"><a href="?limit=100&page=1">100</a></li>
              </ul>
            </div>
            rows visible
          </div>
        </div>
        <div class="pull-right pagination">
          <ul class="pagination">
            {{#if (gt pagination.page 1)}}
            <li class="page-item page-pre">
              <a class="page-link" aria-label="previous page" href="?page={{subtract pagination.page 1}}&limit={{pagination.limit}}&role={{filters.role}}&search={{filters.search}}">‹</a>
            </li>
            {{/if}}

            {{#each (range 1 pagination.pages)}}
            <li class="page-item {{#if (eq this ../pagination.page)}}active{{/if}}">
              <a class="page-link" aria-label="to page {{this}}" href="?page={{this}}&limit={{pagination.limit}}&role={{filters.role}}&search={{filters.search}}">{{this}}</a>
            </li>
            {{/each}}

            {{#if (lt pagination.page pagination.pages)}}
            <li class="page-item page-next">
              <a class="page-link" aria-label="next page" href="?page={{add pagination.page 1}}&limit={{pagination.limit}}&role={{filters.role}}&search={{filters.search}}">›</a>
            </li>
            {{/if}}
          </ul>
        </div>
      </div>
    </div>

<!-- Edit User Modal -->
<div id="editUserModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Edit User</h3>
      <form id="editUserForm">
        <input type="hidden" id="editUserId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Role</label>
          <select id="editUserRole" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Manage Credits Modal -->
<div id="creditsModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Manage Credits</h3>
      <p id="creditsUserName" class="text-sm text-muted-foreground mb-4"></p>
      <form id="creditsForm">
        <input type="hidden" id="creditsUserId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Current Credits</label>
          <p id="currentCredits" class="text-lg font-semibold text-foreground"></p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">New Credits Amount</label>
          <input type="number" id="newCredits" min="0" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeCreditsModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update Credits</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Ban User Modal -->
<div id="banModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4" id="banModalTitle">Ban User</h3>
      <p id="banUserName" class="text-sm text-muted-foreground mb-4"></p>
      <form id="banForm">
        <input type="hidden" id="banUserId">
        <input type="hidden" id="banAction">
        <div class="mb-4" id="banReasonDiv">
          <label class="block text-sm font-medium text-foreground mb-2">Reason for ban</label>
          <textarea id="banReason" rows="3" class="flex min-h-[80px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="Enter reason for banning this user..."></textarea>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBanModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" id="banSubmitBtn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground shadow hover:bg-destructive/90 h-9 px-4 py-2">Ban User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div id="createUserModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Create New User</h3>
      <form id="createUserForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Email</label>
          <input type="email" id="createUserEmail" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">First Name</label>
          <input type="text" id="createUserFirstName" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Last Name</label>
          <input type="text" id="createUserLastName" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Password</label>
          <input type="password" id="createUserPassword" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Role</label>
          <select id="createUserRole" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Initial Credits</label>
          <input type="number" id="createUserCredits" min="0" value="0" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeCreateUserModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Create User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Role Update Modal -->
<div id="bulkRoleModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Bulk Update Role</h3>
      <p class="text-sm text-muted-foreground mb-4" id="bulkRoleCount"></p>
      <form id="bulkRoleForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">New Role</label>
          <select id="bulkRoleSelect" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBulkRoleModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update Roles</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Credits Update Modal -->
<div id="bulkCreditsModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Bulk Update Credits</h3>
      <p class="text-sm text-muted-foreground mb-4" id="bulkCreditsCount"></p>
      <form id="bulkCreditsForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Credits Operation</label>
          <select id="bulkCreditsOperation" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
            <option value="set">Set to</option>
            <option value="add">Add</option>
            <option value="subtract">Subtract</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Credits Amount</label>
          <input type="number" id="bulkCreditsAmount" min="0" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBulkCreditsModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update Credits</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Helper functions for date formatting
function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString();
}

function range(start, end) {
  const result = [];
  for (let i = start; i <= end; i++) {
    result.push(i);
  }
  return result;
}

// Modal functions
function editUser(userId) {
  // Fetch user data and populate modal
  fetch(`/admin/api/users/${userId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('editUserId').value = data.user.id;
        document.getElementById('editUserRole').value = data.user.role;
        document.getElementById('editUserModal').classList.remove('hidden');
      }
    });
}

function closeEditModal() {
  document.getElementById('editUserModal').classList.add('hidden');
}

function manageCredits(userId, userName, currentCredits) {
  document.getElementById('creditsUserId').value = userId;
  document.getElementById('creditsUserName').textContent = `User: ${userName}`;
  document.getElementById('currentCredits').textContent = currentCredits;
  document.getElementById('newCredits').value = currentCredits;
  document.getElementById('creditsModal').classList.remove('hidden');
}

function closeCreditsModal() {
  document.getElementById('creditsModal').classList.add('hidden');
}

 function toggleStatus(userId, currentStatus) {
   const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
   const action = newStatus === 'active' ? 'activate' : 'deactivate';

   Toast.warning(`Are you sure you want to ${action} this user?`);
   fetch(`/admin/api/users/${userId}/status`, {
     method: 'PUT',
     headers: {
       'Content-Type': 'application/json',
     },
     body: JSON.stringify({ status: newStatus }),
   })
   .then(response => response.json())
   .then(data => {
     if (data.success) {
       location.reload();
     } else {
       Toast.error('Error updating user status: ' + data.error);
     }
   });
 }

function toggleBan(userId, currentlyBanned, userName) {
  document.getElementById('banUserId').value = userId;
  document.getElementById('banUserName').textContent = `User: ${userName}`;
  document.getElementById('banAction').value = currentlyBanned ? 'unban' : 'ban';

  if (currentlyBanned) {
    document.getElementById('banModalTitle').textContent = 'Unban User';
    document.getElementById('banReasonDiv').style.display = 'none';
    document.getElementById('banSubmitBtn').textContent = 'Unban User';
    document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-destructive', 'bg-green-600').replace('hover:bg-destructive/90', 'hover:bg-green-700');
  } else {
    document.getElementById('banModalTitle').textContent = 'Ban User';
    document.getElementById('banReasonDiv').style.display = 'block';
    document.getElementById('banSubmitBtn').textContent = 'Ban User';
    document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-green-600', 'bg-destructive').replace('hover:bg-green-700', 'hover:bg-destructive/90');
  }

  document.getElementById('banModal').classList.remove('hidden');
}

function closeBanModal() {
  document.getElementById('banModal').classList.add('hidden');
}

function openCreateUserModal() {
  document.getElementById('createUserModal').classList.remove('hidden');
}

function closeCreateUserModal() {
  document.getElementById('createUserModal').classList.add('hidden');
  document.getElementById('createUserForm').reset();
}

// Bulk actions functions
function updateBulkActions() {
  const checkboxes = document.querySelectorAll('.userCheckbox:checked');
  const count = checkboxes.length;
  const bulkActions = document.getElementById('bulkActions');
  const selectedCount = document.getElementById('selectedCount');

  if (count > 0) {
    bulkActions.style.display = 'block';
    selectedCount.textContent = `${count} user${count > 1 ? 's' : ''} selected`;
    document.getElementById('bulkRoleBtn').disabled = false;
    document.getElementById('bulkCreditsBtn').disabled = false;
    document.getElementById('bulkDeleteBtn').disabled = false;
  } else {
    bulkActions.style.display = 'none';
    document.getElementById('bulkRoleBtn').disabled = true;
    document.getElementById('bulkCreditsBtn').disabled = true;
    document.getElementById('bulkDeleteBtn').disabled = true;
  }
}

function openBulkRoleModal() {
  const checkboxes = document.querySelectorAll('.userCheckbox:checked');
  const count = checkboxes.length;
  document.getElementById('bulkRoleCount').textContent = `Update role for ${count} user${count > 1 ? 's' : ''}`;
  document.getElementById('bulkRoleModal').classList.remove('hidden');
}

function closeBulkRoleModal() {
  document.getElementById('bulkRoleModal').classList.add('hidden');
  document.getElementById('bulkRoleForm').reset();
}

function openBulkCreditsModal() {
  const checkboxes = document.querySelectorAll('.userCheckbox:checked');
  const count = checkboxes.length;
  document.getElementById('bulkCreditsCount').textContent = `Update credits for ${count} user${count > 1 ? 's' : ''}`;
  document.getElementById('bulkCreditsModal').classList.remove('hidden');
}

function closeBulkCreditsModal() {
  document.getElementById('bulkCreditsModal').classList.add('hidden');
  document.getElementById('bulkCreditsForm').reset();
}

 function bulkDelete() {
   const checkboxes = document.querySelectorAll('.userCheckbox:checked');
   const count = checkboxes.length;

   Toast.warning(`Are you sure you want to delete ${count} user${count > 1 ? 's' : ''}? This action cannot be undone.`);
   const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

   // Delete users one by one
   Promise.all(userIds.map(userId =>
     fetch(`/admin/api/users/${userId}`, {
       method: 'DELETE',
       headers: {
         'Content-Type': 'application/json',
       },
     }).then(response => response.json())
   )).then(results => {
     const successCount = results.filter(r => r.success).length;
     Toast.success(`Successfully deleted ${successCount} out of ${count} users`);
     location.reload();
   });
 }

 function deleteUser(userId, userName) {
   Toast.warning(`Are you sure you want to delete user ${userName}? This action cannot be undone.`);
   fetch(`/admin/api/users/${userId}`, {
     method: 'DELETE',
     headers: {
       'Content-Type': 'application/json',
     },
   })
   .then(response => response.json())
   .then(data => {
     if (data.success) {
       location.reload();
     } else {
       Toast.error('Error deleting user: ' + data.error);
     }
   });
 }

// Form handlers
document.getElementById('editUserForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const userId = document.getElementById('editUserId').value;
  const role = document.getElementById('editUserRole').value;

  fetch(`/admin/api/users/${userId}/role`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ role }),
  })
  .then(response => response.json())
   .then(data => {
     if (data.success) {
       closeEditModal();
       location.reload();
     } else {
       Toast.error('Error updating user: ' + data.error);
     }
   });
});

document.getElementById('creditsForm').addEventListener('submit', function(e) {
  e.preventDefault();

  clearFormErrors('creditsForm');

  const userId = document.getElementById('creditsUserId').value;
  const credits = parseInt(document.getElementById('newCredits').value);

  // Validation
  if (isNaN(credits) || credits < 0) {
    showFormErrors('creditsForm', { newCredits: 'Please enter a valid number of credits (0 or more)' });
    return;
  }

  fetch(`/admin/api/users/${userId}/credits`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ credits }),
  })
  .then(response => response.json())
   .then(data => {
     if (data.success) {
       closeCreditsModal();
       location.reload();
     } else {
       Toast.error('Error updating credits: ' + data.error);
     }
   })
   .catch(error => {
     Toast.error('Network error occurred. Please try again.');
   });
});

document.getElementById('banForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const userId = document.getElementById('banUserId').value;
  const action = document.getElementById('banAction').value;
  const reason = document.getElementById('banReason').value;

  const banned = action === 'ban';

  fetch(`/admin/api/users/${userId}/banned`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ banned, reason }),
  })
  .then(response => response.json())
   .then(data => {
     if (data.success) {
       closeBanModal();
       location.reload();
     } else {
       Toast.error('Error updating ban status: ' + data.error);
     }
   });
});

document.getElementById('createUserForm').addEventListener('submit', function(e) {
  e.preventDefault();

  // Clear previous errors
  clearFormErrors('createUserForm');

  const email = document.getElementById('createUserEmail').value.trim();
  const firstName = document.getElementById('createUserFirstName').value.trim();
  const lastName = document.getElementById('createUserLastName').value.trim();
  const password = document.getElementById('createUserPassword').value;
  const role = document.getElementById('createUserRole').value;
  const credits = parseInt(document.getElementById('createUserCredits').value) || 0;

  // Client-side validation
  let isValid = true;
  const errors = {};

  if (!email || !email.includes('@')) {
    errors.email = 'Please enter a valid email address';
    isValid = false;
  }

  if (!firstName || firstName.length < 2) {
    errors.firstName = 'First name must be at least 2 characters';
    isValid = false;
  }

  if (!lastName || lastName.length < 2) {
    errors.lastName = 'Last name must be at least 2 characters';
    isValid = false;
  }

  if (!password || password.length < 6) {
    errors.password = 'Password must be at least 6 characters';
    isValid = false;
  }

  if (credits < 0) {
    errors.credits = 'Credits cannot be negative';
    isValid = false;
  }

  if (!isValid) {
    showFormErrors('createUserForm', errors);
    return;
  }

  fetch('/admin/api/users', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ email, firstName, lastName, password, role, credits }),
  })
  .then(response => response.json())
   .then(data => {
     if (data.success) {
       closeCreateUserModal();
       location.reload();
     } else {
       Toast.error('Error creating user: ' + data.error);
     }
   })
   .catch(error => {
     Toast.error('Network error occurred. Please try again.');
  });
});

// Initialize controls from URL params
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const limit = urlParams.get('limit') || '20';
  const role = urlParams.get('role') || '';
  const search = urlParams.get('search') || '';

  // Note: rowsPerPage select removed, using pagination dropdown instead
  document.getElementById('roleFilter').value = role;
  document.getElementById('searchInput').value = search;
});

// Handle page size changes from pagination dropdown
document.addEventListener('click', function(e) {
  if (e.target.closest('.page-list .dropdown-menu a')) {
    e.preventDefault();
    const limit = e.target.textContent.trim();
    const url = new URL(window.location);
    url.searchParams.set('limit', limit);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
  }
});
</script>
    </div>
  </div>