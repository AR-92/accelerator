

<!-- Glass card container -->
<div
  class="w-full max-w-5xl rounded-xl shadow-2xl overflow-hidden bg-white/85 backdrop-blur-sm ring-1 ring-gray-200 flex flex-col min-h-[600px]">

  <!-- Sticky header (toolbar) -->
   <header class="sticky top-0 z-20 bg-purple-800 text-white p-5">
    <!-- Page Title and Description -->
    <div class="mb-6 flex justify-between">

    <div class="text-left">
      <h1 class="text-3xl font-bold text-white mb-2">Users</h1>
      <p class=" text-gray-200">Manage and oversee all user accounts in the system</p>
    </div>
        <div class="">
          <button onclick="openCreateUserModal()"
          class="flex items-center gap-2 bg-white/10 hover:bg-white/20 border border-white/30 rounded-full px-4 py-2 text-sm">
          {{lucide 'UserPlus' 'w-4 h-4'}}
          <span class="text-sm font-medium">Create User</span>
        </button>
    </div>
     </div>
     <div class="max-w-7xl mx-auto flex items-center gap-4">
      <!-- center: search -->
      <div class="flex-1 flex justify-left">
        <div class="w-full max-w-lg">
          <label class="relative block">
            <span class="sr-only">Search</span>
            <span class="absolute inset-y-0 left-3 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white/80" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
              </svg>
            </span>
            <span class="absolute inset-y-0 left-3 flex items-center">
              {{lucide 'Search' 'w-5 h-5 text-white/80'}}
            </span>
            <input
              class="w-full pl-12 pr-4 py-1.5 rounded-full bg-white/10 hover:bg-white/20 border border-white/30 placeholder-white/75 text-white focus:outline-none focus:ring-2 focus:ring-white/30"
              placeholder="Search users..." aria-label="Search" id="searchInput" />
          </label>
        </div>
      </div>

      <!-- right: small action icons -->
      <div class="flex items-center gap-3">

        <button onclick="exportToCSV()" class="p-2 rounded-full bg-white/10 border border-white/25 hover:bg-white/20"
          title="Export CSV">
          {{lucide 'Download' 'w-5 h-5'}}
        </button>
        <button onclick="location.reload()"
          class="p-2 rounded-full bg-white/10 border border-white/25 hover:bg-white/20" title="Refresh">
          {{lucide 'RefreshCw' 'w-5 h-5'}}
        </button>
        <button class="p-2 rounded-full bg-white/10 border border-white/25 hover:bg-white/20" title="View Options">
          {{lucide 'List' 'w-5 h-5'}}
        </button>
      </div>
    </div>
   </header>

   <!-- Sub Navigation -->
   <div class="border-b border-gray-200 dark:border-gray-700 bg-white">
     <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
       <div class="flex w-full items-center gap-8 overflow-x-auto">
         <a href="/admin/users" class="p-3 text-base font-medium {{#unless filters.role}}border-b-2 border-primary text-black dark:text-white dark:text-white dark:border-white{{else}}text-gray-500 dark:text-gray-400 hover:text-black dark:text-white dark:hover:text-gray-300{{/unless}} transition-colors">
           All Users
         </a>
         <a href="/admin/users?role=startup" class="p-3 text-base font-medium {{#if (eq filters.role 'startup')}}border-b-2 border-primary text-black dark:text-white dark:text-white dark:border-white{{else}}text-gray-500 dark:text-gray-400 hover:text-black dark:text-white dark:hover:text-gray-300{{/if}} transition-colors">
           Startups
         </a>
         <a href="/admin/users?role=corporate" class="p-3 text-base font-medium {{#if (eq filters.role 'corporate')}}border-b-2 border-primary text-black dark:text-white dark:text-white dark:border-white{{else}}text-gray-500 dark:text-gray-400 hover:text-black dark:text-white dark:hover:text-gray-300{{/if}} transition-colors">
           Corporate
         </a>
         <a href="/admin/users?role=enterprise" class="p-3 text-base font-medium {{#if (eq filters.role 'enterprise')}}border-b-2 border-primary text-black dark:text-white dark:text-white dark:border-white{{else}}text-gray-500 dark:text-gray-400 hover:text-black dark:text-white dark:hover:text-gray-300{{/if}} transition-colors">
           Enterprise
         </a>
         <a href="/admin/users?role=admin" class="p-3 text-base font-medium {{#if (eq filters.role 'admin')}}border-b-2 border-primary text-black dark:text-white dark:text-white dark:border-white{{else}}text-gray-500 dark:text-gray-400 hover:text-black dark:text-white dark:hover:text-gray-300{{/if}} transition-colors">
           Admins
         </a>
       </div>
     </div>
   </div>

   <!-- Table area (scrolls if wide) -->
  <div class="overflow-auto flex-1">
    <table class="min-w-full table-auto bg-purple-50 dark:bg-purple-900">
      <thead class='bg-purple-200 dark:bg-purple-800'>
        <tr>
           <th class="px-6 py-4 text-left font-semibold text-black dark:text-white uppercase text-xs tracking-wider">
             <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-primary focus:ring-primary"
               aria-label="Select all users">
           </th>
           <th class="px-6 py-4 text-left font-semibold text-black dark:text-white uppercase text-xs tracking-wider">User</th>
           <th class="px-6 py-4 text-left font-semibold text-black dark:text-white uppercase text-xs tracking-wider">Role</th>
           <th class="px-6 py-4 text-left font-semibold text-black dark:text-white uppercase text-xs tracking-wider">Status</th>
           <th class="px-6 py-4 text-left font-semibold text-black dark:text-white uppercase text-xs tracking-wider hidden md:table-cell">Credits</th>
           <th class="px-6 py-4 text-left font-semibold text-black dark:text-white uppercase text-xs tracking-wider hidden lg:table-cell">Created</th>
           <th class="px-6 py-4 text-left font-semibold text-black dark:text-white uppercase text-xs tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="text-sm text-black dark:text-white">
        {{#each users}}
        <tr class="border-b border-gray-100/40 hover:bg-purple-100 dark:hover:bg-purple-800 transition-colors duration-150 even:bg-purple-100 dark:even:bg-purple-800">
          <td class="px-6 py-4">
            <input type="checkbox" class="userCheckbox rounded border-gray-300 text-primary focus:ring-primary"
              value="{{id}}" data-user-id="{{id}}" aria-label="Select user {{fullName}}">
          </td>
          <td class="px-6 py-4">
            <div>
              <div class="text-sm font-medium text-gray-900">{{fullName}}</div>
              <div class="text-sm text-gray-500">{{email}}</div>
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-gray-900 capitalize">{{role}}</div>
          </td>
          <td class="px-6 py-4">
            <span
              class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {{#if (eq status 'active')}}bg-green-100 text-green-800{{else}}bg-red-100 text-red-800{{/if}}">{{status}}</span>
            {{#if banned}}
            <span
              class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 ml-2">BANNED</span>
            {{/if}}
          </td>
          <td class="px-6 py-4 hidden md:table-cell">
            <div class="text-sm text-gray-900 font-medium">{{credits}}</div>
          </td>
          <td class="px-6 py-4 hidden lg:table-cell">
            <div class="text-sm text-gray-900">{{formatDate createdAt}}</div>
          </td>
          <td class="px-6 py-4">
            <div class="relative">
              <button onclick="toggleActionMenu({{id}})"
                class="p-2 rounded-full hover:bg-gray-100 text-gray-500 hover:text-black dark:text-white transition-colors"
                aria-label="Actions menu">
                {{lucide 'MoreVertical' 'w-4 h-4'}}
              </button>
              <div id="actionMenu-{{id}}"
                class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200">
                <div class="py-1">
                  <a href="/admin/users/{{id}}"
                    class="flex items-center px-4 py-2 text-sm text-black dark:text-white hover:bg-gray-100 transition-colors">
                    {{lucide 'Eye' 'w-4 h-4 mr-3'}}
                    View Details
                  </a>
                  <button onclick="editUser({{id}})"
                    class="flex items-center w-full px-4 py-2 text-sm text-black dark:text-white hover:bg-gray-100 transition-colors">
                    {{lucide 'Edit' 'w-4 h-4 mr-3'}}
                    Edit User
                  </button>
                  <button onclick="manageCredits({{id}}, '{{fullName}}', {{credits}})"
                    class="flex items-center w-full px-4 py-2 text-sm text-black dark:text-white hover:bg-gray-100 transition-colors">
                    {{lucide 'CreditCard' 'w-4 h-4 mr-3'}}
                    Manage Credits
                  </button>
                  <button onclick="toggleStatus({{id}}, '{{status}}')"
                    class="flex items-center w-full px-4 py-2 text-sm text-black dark:text-white hover:bg-gray-100 transition-colors">
                    {{#if (eq status 'active')}}
                    {{lucide 'XCircle' 'w-4 h-4 mr-3'}}
                    Deactivate
                    {{else}}
                    {{lucide 'CheckCircle' 'w-4 h-4 mr-3'}}
                    Activate
                    {{/if}}
                  </button>
                  {{#unless (eq role 'admin')}}
                  <button onclick="toggleBan({{id}}, {{banned}}, '{{fullName}}')"
                    class="flex items-center w-full px-4 py-2 text-sm text-black dark:text-white hover:bg-gray-100 transition-colors">
                    {{#if banned}}
                    {{lucide 'CheckCircle' 'w-4 h-4 mr-3'}}
                    Unban
                    {{else}}
                    {{lucide 'XCircle' 'w-4 h-4 mr-3'}}
                    Ban
                    {{/if}}
                  </button>
                  <button onclick="deleteUser({{id}}, '{{fullName}}')"
                    class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                    {{lucide 'Trash2' 'w-4 h-4 mr-3'}}
                    Delete
                  </button>
                  {{/unless}}
                </div>
              </div>
            </div>
          </td>
        </tr>
        {{else}}
        <tr>
          <td colspan="7" class='px-6 py-8 text-center text-gray-500'>
            <div class="text-gray-500">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">No users found</h3>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Users will appear here once they register.</p>
            </div>
          </td>
        </tr>
        {{/each}}
        </tbody>
       <tfoot>
         <tr>
           <td colspan="7" class="bg-white/85 backdrop-blur-sm border-t border-gray-200 p-4">
             <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
               <div class="text-sm text-gray-600">
                 Showing {{#if users.length}}{{add (multiply (subtract pagination.page 1) pagination.limit) 1}}{{else}}0{{/if}}-{{add (multiply (subtract pagination.page 1) pagination.limit) users.length}} of {{pagination.total}} users
               </div>

               <div class="flex items-center gap-3">
                 <span class="text-sm text-gray-600 font-medium">Rows per page:</span>
                 <select id="rowsPerPage"
                   class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                   <option value="10" {{#if (eq pagination.limit 10)}}selected{{/if}}>10</option>
                   <option value="20" {{#if (eq pagination.limit 20)}}selected{{/if}}>20</option>
                   <option value="50" {{#if (eq pagination.limit 50)}}selected{{/if}}>50</option>
                   <option value="100" {{#if (eq pagination.limit 100)}}selected{{/if}}>100</option>
                 </select>
               </div>

               <div class="flex items-center gap-2">
                 <nav class="flex items-center gap-1 text-sm">
                   {{#if (gt pagination.page 1)}}
                   <a href="?page={{subtract pagination.page 1}}&limit={{pagination.limit}}&role={{filters.role}}&search={{filters.search}}"
                     class="inline-flex items-center justify-center w-10 h-10 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 shadow-sm hover:shadow-md"
                     title="Previous page">
                     {{lucide 'ChevronLeft' 'w-4 h-4'}}
                   </a>
                   {{/if}}

                   {{#each (range 1 pagination.pages)}}
                   <a href="?page={{this}}&limit={{pagination.limit}}&role={{filters.role}}&search={{filters.search}}"
                     class="inline-flex items-center justify-center w-10 h-10 rounded-lg {{#if (eq this ../pagination.page)}}bg-primary text-primary-foreground shadow-lg scale-105{{else}}border border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400{{/if}} transition-all duration-200 shadow-sm hover:shadow-md font-medium">{{this}}</a>
                   {{/each}}

                   {{#if (lt pagination.page pagination.pages)}}
                   <a href="?page={{add pagination.page 1}}&limit={{pagination.limit}}&role={{filters.role}}&search={{filters.search}}"
                     class="inline-flex items-center justify-center w-10 h-10 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 shadow-sm hover:shadow-md"
                     title="Next page">
                     {{lucide 'ChevronRight' 'w-4 h-4'}}
                   </a>
                   {{/if}}
                 </nav>
               </div>
             </div>
           </td>
         </tr>
       </tfoot>
     </table>
  </div>

  <!-- Bulk Actions (floating) -->
  <div id="bulkActions"
    class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-primary text-primary-foreground px-6 py-3 rounded-full shadow-lg z-30"
    style="display: none;">
    <div class="flex items-center gap-4">
      <span id="selectedCount">0 users selected</span>
      <div class="flex gap-2">
        <button onclick="openBulkRoleModal()" id="bulkRoleBtn"
          class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm" disabled>
          Update Role
        </button>
        <button onclick="openBulkCreditsModal()" id="bulkCreditsBtn"
          class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm" disabled>
          Update Credits
        </button>
        <button onclick="bulkDelete()" id="bulkDeleteBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm"
          disabled>
          Delete Selected
        </button>
      </div>
    </div>
  </div>


</div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Edit User</h3>
      <form id="editUserForm">
        <input type="hidden" id="editUserId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Role</label>
          <select id="editUserRole"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditModal()"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Manage Credits Modal -->
<div id="creditsModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Manage Credits</h3>
      <p id="creditsUserName" class="text-sm text-muted-foreground mb-4"></p>
      <form id="creditsForm">
        <input type="hidden" id="creditsUserId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Current Credits</label>
          <p id="currentCredits" class="text-lg font-semibold text-foreground"></p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">New Credits Amount</label>
          <input type="number" id="newCredits" min="0"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeCreditsModal()"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update
            Credits</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Ban User Modal -->
<div id="banModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4" id="banModalTitle">Ban User</h3>
      <p id="banUserName" class="text-sm text-muted-foreground mb-4"></p>
      <form id="banForm">
        <input type="hidden" id="banUserId">
        <input type="hidden" id="banAction">
        <div class="mb-4" id="banReasonDiv">
          <label class="block text-sm font-medium text-foreground mb-2">Reason for ban</label>
          <textarea id="banReason" rows="3"
            class="flex min-h-[80px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            placeholder="Enter reason for banning this user..."></textarea>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBanModal()"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" id="banSubmitBtn"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground shadow hover:bg-destructive/90 h-9 px-4 py-2">Ban
            User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div id="createUserModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Create New User</h3>
      <form id="createUserForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Email</label>
          <input type="email" id="createUserEmail"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">First Name</label>
          <input type="text" id="createUserFirstName"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Last Name</label>
          <input type="text" id="createUserLastName"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Password</label>
          <input type="password" id="createUserPassword"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Role</label>
          <select id="createUserRole"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Initial Credits</label>
          <input type="number" id="createUserCredits" min="0" value="0"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeCreateUserModal()"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Create
            User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Role Update Modal -->
<div id="bulkRoleModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Bulk Update Role</h3>
      <p class="text-sm text-muted-foreground mb-4" id="bulkRoleCount"></p>
      <form id="bulkRoleForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">New Role</label>
          <select id="bulkRoleSelect"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            required>
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBulkRoleModal()"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update
            Roles</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Credits Update Modal -->
<div id="bulkCreditsModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Bulk Update Credits</h3>
      <p class="text-sm text-muted-foreground mb-4" id="bulkCreditsCount"></p>
      <form id="bulkCreditsForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Credits Operation</label>
          <select id="bulkCreditsOperation"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            required>
            <option value="set">Set to</option>
            <option value="add">Add</option>
            <option value="subtract">Subtract</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Credits Amount</label>
          <input type="number" id="bulkCreditsAmount" min="0"
            class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBulkCreditsModal()"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update
            Credits</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Helper functions for date formatting
  function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
  }

  function range(start, end) {
    const result = [];
    for (let i = start; i <= end; i++) {
      result.push(i);
    }
    return result;
  }

  // Modal functions
  function editUser(userId) {
    // Fetch user data and populate modal
    fetch(`/admin/api/users/${userId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('editUserId').value = data.user.id;
          document.getElementById('editUserRole').value = data.user.role;
          document.getElementById('editUserModal').classList.remove('hidden');
        }
      });
  }

  function closeEditModal() {
    document.getElementById('editUserModal').classList.add('hidden');
  }

  function manageCredits(userId, userName, currentCredits) {
    document.getElementById('creditsUserId').value = userId;
    document.getElementById('creditsUserName').textContent = `User: ${userName}`;
    document.getElementById('currentCredits').textContent = currentCredits;
    document.getElementById('newCredits').value = currentCredits;
    document.getElementById('creditsModal').classList.remove('hidden');
  }

  function closeCreditsModal() {
    document.getElementById('creditsModal').classList.add('hidden');
  }

  function toggleStatus(userId, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    const action = newStatus === 'active' ? 'activate' : 'deactivate';

    Toast.warning(`Are you sure you want to ${action} this user?`);
    fetch(`/admin/api/users/${userId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ status: newStatus }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          Toast.error('Error updating user status: ' + data.error);
        }
      });
  }

  function toggleBan(userId, currentlyBanned, userName) {
    document.getElementById('banUserId').value = userId;
    document.getElementById('banUserName').textContent = `User: ${userName}`;
    document.getElementById('banAction').value = currentlyBanned ? 'unban' : 'ban';

    if (currentlyBanned) {
      document.getElementById('banModalTitle').textContent = 'Unban User';
      document.getElementById('banReasonDiv').style.display = 'none';
      document.getElementById('banSubmitBtn').textContent = 'Unban User';
      document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-destructive', 'bg-green-600').replace('hover:bg-destructive/90', 'hover:bg-green-700');
    } else {
      document.getElementById('banModalTitle').textContent = 'Ban User';
      document.getElementById('banReasonDiv').style.display = 'block';
      document.getElementById('banSubmitBtn').textContent = 'Ban User';
      document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-green-600', 'bg-destructive').replace('hover:bg-green-700', 'hover:bg-destructive/90');
    }

    document.getElementById('banModal').classList.remove('hidden');
  }

  function closeBanModal() {
    document.getElementById('banModal').classList.add('hidden');
  }

  function openCreateUserModal() {
    document.getElementById('createUserModal').classList.remove('hidden');
  }

  function closeCreateUserModal() {
    document.getElementById('createUserModal').classList.add('hidden');
    document.getElementById('createUserForm').reset();
  }

  // Bulk actions functions
  function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.userCheckbox:checked');
    const count = checkboxes.length;
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');

    if (count > 0) {
      bulkActions.style.display = 'block';
      selectedCount.textContent = `${count} user${count > 1 ? 's' : ''} selected`;
      document.getElementById('bulkRoleBtn').disabled = false;
      document.getElementById('bulkCreditsBtn').disabled = false;
      document.getElementById('bulkDeleteBtn').disabled = false;
    } else {
      bulkActions.style.display = 'none';
      document.getElementById('bulkRoleBtn').disabled = true;
      document.getElementById('bulkCreditsBtn').disabled = true;
      document.getElementById('bulkDeleteBtn').disabled = true;
    }
  }

  function openBulkRoleModal() {
    const checkboxes = document.querySelectorAll('.userCheckbox:checked');
    const count = checkboxes.length;
    document.getElementById('bulkRoleCount').textContent = `Update role for ${count} user${count > 1 ? 's' : ''}`;
    document.getElementById('bulkRoleModal').classList.remove('hidden');
  }

  function closeBulkRoleModal() {
    document.getElementById('bulkRoleModal').classList.add('hidden');
    document.getElementById('bulkRoleForm').reset();
  }

  function openBulkCreditsModal() {
    const checkboxes = document.querySelectorAll('.userCheckbox:checked');
    const count = checkboxes.length;
    document.getElementById('bulkCreditsCount').textContent = `Update credits for ${count} user${count > 1 ? 's' : ''}`;
    document.getElementById('bulkCreditsModal').classList.remove('hidden');
  }

  function closeBulkCreditsModal() {
    document.getElementById('bulkCreditsModal').classList.add('hidden');
    document.getElementById('bulkCreditsForm').reset();
  }

  function bulkDelete() {
    const checkboxes = document.querySelectorAll('.userCheckbox:checked');
    const count = checkboxes.length;

    Toast.warning(`Are you sure you want to delete ${count} user${count > 1 ? 's' : ''}? This action cannot be undone.`);
    const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

    // Delete users one by one
    Promise.all(userIds.map(userId =>
      fetch(`/admin/api/users/${userId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(response => response.json())
    )).then(results => {
      const successCount = results.filter(r => r.success).length;
      Toast.success(`Successfully deleted ${successCount} out of ${count} users`);
      location.reload();
    });
  }

  function deleteUser(userId, userName) {
    Toast.warning(`Are you sure you want to delete user ${userName}? This action cannot be undone.`);
    fetch(`/admin/api/users/${userId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          Toast.error('Error deleting user: ' + data.error);
        }
      });
  }

  // Form handlers
  document.getElementById('editUserForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const userId = document.getElementById('editUserId').value;
    const role = document.getElementById('editUserRole').value;

    fetch(`/admin/api/users/${userId}/role`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ role }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeEditModal();
          location.reload();
        } else {
          Toast.error('Error updating user: ' + data.error);
        }
      });
  });

  document.getElementById('creditsForm').addEventListener('submit', function (e) {
    e.preventDefault();

    clearFormErrors('creditsForm');

    const userId = document.getElementById('creditsUserId').value;
    const credits = parseInt(document.getElementById('newCredits').value);

    // Validation
    if (isNaN(credits) || credits < 0) {
      showFormErrors('creditsForm', { newCredits: 'Please enter a valid number of credits (0 or more)' });
      return;
    }

    fetch(`/admin/api/users/${userId}/credits`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ credits }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeCreditsModal();
          location.reload();
        } else {
          Toast.error('Error updating credits: ' + data.error);
        }
      })
      .catch(error => {
        Toast.error('Network error occurred. Please try again.');
      });
  });

  document.getElementById('banForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const userId = document.getElementById('banUserId').value;
    const action = document.getElementById('banAction').value;
    const reason = document.getElementById('banReason').value;

    const banned = action === 'ban';

    fetch(`/admin/api/users/${userId}/banned`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ banned, reason }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeBanModal();
          location.reload();
        } else {
          Toast.error('Error updating ban status: ' + data.error);
        }
      });
  });

  document.getElementById('createUserForm').addEventListener('submit', function (e) {
    e.preventDefault();

    // Clear previous errors
    clearFormErrors('createUserForm');

    const email = document.getElementById('createUserEmail').value.trim();
    const firstName = document.getElementById('createUserFirstName').value.trim();
    const lastName = document.getElementById('createUserLastName').value.trim();
    const password = document.getElementById('createUserPassword').value;
    const role = document.getElementById('createUserRole').value;
    const credits = parseInt(document.getElementById('createUserCredits').value) || 0;

    // Client-side validation
    let isValid = true;
    const errors = {};

    if (!email || !email.includes('@')) {
      errors.email = 'Please enter a valid email address';
      isValid = false;
    }

    if (!firstName || firstName.length < 2) {
      errors.firstName = 'First name must be at least 2 characters';
      isValid = false;
    }

    if (!lastName || lastName.length < 2) {
      errors.lastName = 'Last name must be at least 2 characters';
      isValid = false;
    }

    if (!password || password.length < 6) {
      errors.password = 'Password must be at least 6 characters';
      isValid = false;
    }

    if (credits < 0) {
      errors.credits = 'Credits cannot be negative';
      isValid = false;
    }

    if (!isValid) {
      showFormErrors('createUserForm', errors);
      return;
    }

    fetch('/admin/api/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email, firstName, lastName, password, role, credits }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeCreateUserModal();
          location.reload();
        } else {
          Toast.error('Error creating user: ' + data.error);
        }
      })
      .catch(error => {
        Toast.error('Network error occurred. Please try again.');
      });
  });

  // Initialize controls from URL params
  document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const limit = urlParams.get('limit') || '20';
    const role = urlParams.get('role') || '';
    const search = urlParams.get('search') || '';

    document.getElementById('rowsPerPage').value = limit;
    document.getElementById('searchInput').value = search;
  });

  // Handle rows per page changes
  document.getElementById('rowsPerPage').addEventListener('change', function () {
    const limit = this.value;
    const url = new URL(window.location);
    url.searchParams.set('limit', limit);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
  });

  // Handle search input
  document.getElementById('searchInput').addEventListener('keyup', function (e) {
    if (e.key === 'Enter') {
      const search = this.value;
      const url = new URL(window.location);
      url.searchParams.set('search', search);
      url.searchParams.set('page', '1');
      window.location.href = url.toString();
    }
  });

// Action menu functions
function toggleActionMenu(userId) {
  const menu = document.getElementById(`actionMenu-${userId}`);
  // Hide other menus
  document.querySelectorAll('.dropdown-menu').forEach(m => {
    if (m !== menu) m.classList.add('hidden');
  });
  menu.classList.toggle('hidden');
}

// Close menus when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.relative')) {
    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));
  }
});
</script>
</div>
</div>