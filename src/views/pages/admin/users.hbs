  <style>
    /* Custom styles for glass effect and design */
    .glass {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(6px);
    }
    .muted {
      color: #6b7280;
    }
    /* Subtle table row divider */
    .row-divider { box-shadow: inset 0 -1px 0 0 rgba(0,0,0,0.04); }
  </style>

  <!-- Main container with gradient background -->
  <div class="min-h-screen bg-gradient-to-br from-gray-300 via-gray-200 to-gray-400 flex items-center justify-center p-6">
    <!-- Glass card container -->
    <div class="w-full max-w-5xl rounded-xl shadow-2xl overflow-hidden bg-white/60 glass ring-1 ring-gray-200">

      <!-- Sticky header (toolbar) -->
      <header class="sticky top-0 z-20 bg-gradient-to-r from-sky-500 to-indigo-600 text-white p-5">
        <div class="max-w-7xl mx-auto flex items-center gap-4">
          <!-- Left: Alert button -->
          <button onclick="openCreateUserModal()" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 border border-white/30 rounded-full px-4 py-2 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 opacity-90" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M13.73 21a2 2 0 01-3.46 0" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/>
              <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/>
            </svg>
            <span class="text-sm font-medium">Create User</span>
          </button>

          <!-- center: search -->
          <div class="flex-1 flex justify-center">
            <div class="w-full max-w-lg">
              <label class="relative block">
                <span class="sr-only">Search</span>
                <span class="absolute inset-y-0 left-3 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white/80" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="11" cy="11" r="6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21 21l-4.35-4.35" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                <input
                  class="w-full pl-12 pr-4 py-3 rounded-full bg-white/20 placeholder-white/75 text-white focus:outline-none focus:ring-2 focus:ring-white/30"
                  placeholder="Search users..." aria-label="Search" id="searchInput" />
              </label>
            </div>
          </div>

          <!-- right: small action icons -->
          <div class="flex items-center gap-3">
            <button onclick="exportToCSV()" class="p-2 rounded-full bg-white/10 border border-white/25 hover:bg-white/20" title="Export CSV">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="7,10 12,15 17,10" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="15" x2="12" y2="3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button onclick="location.reload()" class="p-2 rounded-full bg-white/10 border border-white/25 hover:bg-white/20" title="Refresh">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M20 8v6h-6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 16a8 8 0 0112-6.32L20 11" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button class="p-2 rounded-full bg-white/10 border border-white/25 hover:bg-white/20" title="View Options">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- Table area (scrolls if wide) -->
      <div class="overflow-auto">
        <table class="min-w-full table-fixed bg-white">
          <thead class="text-xs uppercase text-muted">
            <tr class="bg-white">
              <th class="w-12 px-6 py-4 text-left border-b border-gray-100 muted">
                <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              </th>
              <th class="px-6 py-4 text-left border-b border-gray-100">User</th>
              <th class="px-6 py-4 text-left border-b border-gray-100">Role</th>
              <th class="px-6 py-4 text-left border-b border-gray-100">Status</th>
              <th class="px-6 py-4 text-left border-b border-gray-100">Credits</th>
              <th class="px-6 py-4 text-left border-b border-gray-100">Created</th>
              <th class="w-36 px-6 py-4 text-left border-b border-gray-100">Actions</th>
            </tr>
          </thead>
          <tbody class="text-sm text-gray-700">
            {{#each users}}
            <tr class="row-divider {{#if (eq @index 1)}}bg-white/50{{/if}}{{#if (eq @index 3)}}bg-white/50{{/if}}{{#if (eq @index 5)}}bg-white/50{{/if}}{{#if (eq @index 7)}}bg-white/50{{/if}}">
              <td class="px-6 py-4">
                <input type="checkbox" class="userCheckbox" value="{{id}}" data-user-id="{{id}}" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              </td>
              <td class="px-6 py-4">
                <div class="text-sm font-medium">{{fullName}}</div>
                <div class="text-sm text-gray-500">{{email}}</div>
              </td>
              <td class="px-6 py-4">{{role}}</td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{#if (eq status 'active')}}bg-green-100 text-green-800{{else}}bg-red-100 text-red-800{{/if}}">{{status}}</span>
                {{#if banned}}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 ml-1">BANNED</span>
                {{/if}}
              </td>
              <td class="px-6 py-4">{{credits}}</td>
              <td class="px-6 py-4">{{formatDate createdAt}}</td>
              <td class="px-6 py-4">
                <div class="flex items-center justify-end gap-3 text-gray-400">
                  <button onclick="window.location.href='/admin/users/{{id}}'" class="hover:text-gray-600" title="View">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <button onclick="editUser({{id}})" class="hover:text-gray-600" title="Edit">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M3 21v-3l11-11 3 3L6 21H3z" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M14 7l3 3" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <button onclick="manageCredits({{id}}, '{{fullName}}', {{credits}})" class="hover:text-gray-600" title="Manage Credits">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <button onclick="toggleStatus({{id}}, '{{status}}')" class="hover:text-gray-600" title="{{#if (eq status 'active')}}Deactivate{{else}}Activate{{/if}}">
                    {{#if (eq status 'active')}}
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <circle cx="12" cy="12" r="10" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                      <line x1="15" y1="9" x2="9" y2="15" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                      <line x1="9" y1="9" x2="15" y2="15" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {{else}}
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {{/if}}
                  </button>
                  {{#unless (eq role 'admin')}}
                  <button onclick="toggleBan({{id}}, {{banned}}, '{{fullName}}')" class="hover:text-gray-600" title="{{#if banned}}Unban{{else}}Ban{{/if}}">
                    {{#if banned}}
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {{else}}
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <circle cx="12" cy="12" r="10" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                      <line x1="15" y1="9" x2="9" y2="15" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                      <line x1="9" y1="9" x2="15" y2="15" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {{/if}}
                  </button>
                  <button onclick="deleteUser({{id}}, '{{fullName}}')" class="hover:text-red-600" title="Delete">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  {{/unless}}
                </div>
              </td>
          </tr>
          {{/each}}
        </tbody>
          </table>
        </div>

        <!-- Bulk Actions (floating) -->
        <div id="bulkActions" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg z-30" style="display: none;">
          <div class="flex items-center gap-4">
            <span id="selectedCount">0 users selected</span>
            <div class="flex gap-2">
              <button onclick="openBulkRoleModal()" id="bulkRoleBtn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm" disabled>
                Update Role
              </button>
              <button onclick="openBulkCreditsModal()" id="bulkCreditsBtn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm" disabled>
                Update Credits
              </button>
              <button onclick="bulkDelete()" id="bulkDeleteBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm" disabled>
                Delete Selected
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer / pagination -->
      <footer class="bg-white/70 glass border-t border-gray-200 p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="rounded-full border px-4 py-2 text-sm font-medium">{{pagination.limit}}</div>
            <div class="text-sm muted">rows visible</div>
          </div>

          <div class="flex items-center gap-3">
            <nav class="flex items-center gap-3 text-sm">
              {{#if (gt pagination.page 1)}}
              <a href="?page={{subtract pagination.page 1}}&limit={{pagination.limit}}&role={{filters.role}}&search={{filters.search}}" class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-50">‹</a>
              {{/if}}

              {{#each (range 1 pagination.pages)}}
              <a href="?page={{this}}&limit={{pagination.limit}}&role={{filters.role}}&search={{filters.search}}" class="inline-flex items-center justify-center w-10 h-10 rounded-full {{#if (eq this ../pagination.page)}}bg-blue-600 text-white{{else}}border border-gray-300 text-gray-600 hover:bg-gray-50{{/if}}">{{this}}</a>
              {{/each}}

              {{#if (lt pagination.page pagination.pages)}}
              <a href="?page={{add pagination.page 1}}&limit={{pagination.limit}}&role={{filters.role}}&search={{filters.search}}" class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-50">›</a>
              {{/if}}
            </nav>
          </div>
        </div>
      </footer>
    </div>
  </div>

<!-- Edit User Modal -->
<div id="editUserModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Edit User</h3>
      <form id="editUserForm">
        <input type="hidden" id="editUserId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Role</label>
          <select id="editUserRole" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Manage Credits Modal -->
<div id="creditsModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Manage Credits</h3>
      <p id="creditsUserName" class="text-sm text-muted-foreground mb-4"></p>
      <form id="creditsForm">
        <input type="hidden" id="creditsUserId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Current Credits</label>
          <p id="currentCredits" class="text-lg font-semibold text-foreground"></p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">New Credits Amount</label>
          <input type="number" id="newCredits" min="0" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeCreditsModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update Credits</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Ban User Modal -->
<div id="banModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4" id="banModalTitle">Ban User</h3>
      <p id="banUserName" class="text-sm text-muted-foreground mb-4"></p>
      <form id="banForm">
        <input type="hidden" id="banUserId">
        <input type="hidden" id="banAction">
        <div class="mb-4" id="banReasonDiv">
          <label class="block text-sm font-medium text-foreground mb-2">Reason for ban</label>
          <textarea id="banReason" rows="3" class="flex min-h-[80px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="Enter reason for banning this user..."></textarea>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBanModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" id="banSubmitBtn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground shadow hover:bg-destructive/90 h-9 px-4 py-2">Ban User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div id="createUserModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Create New User</h3>
      <form id="createUserForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Email</label>
          <input type="email" id="createUserEmail" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">First Name</label>
          <input type="text" id="createUserFirstName" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Last Name</label>
          <input type="text" id="createUserLastName" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Password</label>
          <input type="password" id="createUserPassword" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Role</label>
          <select id="createUserRole" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Initial Credits</label>
          <input type="number" id="createUserCredits" min="0" value="0" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeCreateUserModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Create User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Role Update Modal -->
<div id="bulkRoleModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Bulk Update Role</h3>
      <p class="text-sm text-muted-foreground mb-4" id="bulkRoleCount"></p>
      <form id="bulkRoleForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">New Role</label>
          <select id="bulkRoleSelect" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
            <option value="startup">Startup</option>
            <option value="corporate">Corporate</option>
            <option value="enterprise">Enterprise</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBulkRoleModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update Roles</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Credits Update Modal -->
<div id="bulkCreditsModal" class="fixed inset-0 bg-background/80 backdrop-blur-sm overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border border-border w-96 shadow-lg rounded-md bg-card">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-foreground mb-4">Bulk Update Credits</h3>
      <p class="text-sm text-muted-foreground mb-4" id="bulkCreditsCount"></p>
      <form id="bulkCreditsForm">
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Credits Operation</label>
          <select id="bulkCreditsOperation" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
            <option value="set">Set to</option>
            <option value="add">Add</option>
            <option value="subtract">Subtract</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-2">Credits Amount</label>
          <input type="number" id="bulkCreditsAmount" min="0" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeBulkCreditsModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Update Credits</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Helper functions for date formatting
function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString();
}

function range(start, end) {
  const result = [];
  for (let i = start; i <= end; i++) {
    result.push(i);
  }
  return result;
}

// Modal functions
function editUser(userId) {
  // Fetch user data and populate modal
  fetch(`/admin/api/users/${userId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('editUserId').value = data.user.id;
        document.getElementById('editUserRole').value = data.user.role;
        document.getElementById('editUserModal').classList.remove('hidden');
      }
    });
}

function closeEditModal() {
  document.getElementById('editUserModal').classList.add('hidden');
}

function manageCredits(userId, userName, currentCredits) {
  document.getElementById('creditsUserId').value = userId;
  document.getElementById('creditsUserName').textContent = `User: ${userName}`;
  document.getElementById('currentCredits').textContent = currentCredits;
  document.getElementById('newCredits').value = currentCredits;
  document.getElementById('creditsModal').classList.remove('hidden');
}

function closeCreditsModal() {
  document.getElementById('creditsModal').classList.add('hidden');
}

 function toggleStatus(userId, currentStatus) {
   const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
   const action = newStatus === 'active' ? 'activate' : 'deactivate';

   Toast.warning(`Are you sure you want to ${action} this user?`);
   fetch(`/admin/api/users/${userId}/status`, {
     method: 'PUT',
     headers: {
       'Content-Type': 'application/json',
     },
     body: JSON.stringify({ status: newStatus }),
   })
   .then(response => response.json())
   .then(data => {
     if (data.success) {
       location.reload();
     } else {
       Toast.error('Error updating user status: ' + data.error);
     }
   });
 }

function toggleBan(userId, currentlyBanned, userName) {
  document.getElementById('banUserId').value = userId;
  document.getElementById('banUserName').textContent = `User: ${userName}`;
  document.getElementById('banAction').value = currentlyBanned ? 'unban' : 'ban';

  if (currentlyBanned) {
    document.getElementById('banModalTitle').textContent = 'Unban User';
    document.getElementById('banReasonDiv').style.display = 'none';
    document.getElementById('banSubmitBtn').textContent = 'Unban User';
    document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-destructive', 'bg-green-600').replace('hover:bg-destructive/90', 'hover:bg-green-700');
  } else {
    document.getElementById('banModalTitle').textContent = 'Ban User';
    document.getElementById('banReasonDiv').style.display = 'block';
    document.getElementById('banSubmitBtn').textContent = 'Ban User';
    document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-green-600', 'bg-destructive').replace('hover:bg-green-700', 'hover:bg-destructive/90');
  }

  document.getElementById('banModal').classList.remove('hidden');
}

function closeBanModal() {
  document.getElementById('banModal').classList.add('hidden');
}

function openCreateUserModal() {
  document.getElementById('createUserModal').classList.remove('hidden');
}

function closeCreateUserModal() {
  document.getElementById('createUserModal').classList.add('hidden');
  document.getElementById('createUserForm').reset();
}

// Bulk actions functions
function updateBulkActions() {
  const checkboxes = document.querySelectorAll('.userCheckbox:checked');
  const count = checkboxes.length;
  const bulkActions = document.getElementById('bulkActions');
  const selectedCount = document.getElementById('selectedCount');

  if (count > 0) {
    bulkActions.style.display = 'block';
    selectedCount.textContent = `${count} user${count > 1 ? 's' : ''} selected`;
    document.getElementById('bulkRoleBtn').disabled = false;
    document.getElementById('bulkCreditsBtn').disabled = false;
    document.getElementById('bulkDeleteBtn').disabled = false;
  } else {
    bulkActions.style.display = 'none';
    document.getElementById('bulkRoleBtn').disabled = true;
    document.getElementById('bulkCreditsBtn').disabled = true;
    document.getElementById('bulkDeleteBtn').disabled = true;
  }
}

function openBulkRoleModal() {
  const checkboxes = document.querySelectorAll('.userCheckbox:checked');
  const count = checkboxes.length;
  document.getElementById('bulkRoleCount').textContent = `Update role for ${count} user${count > 1 ? 's' : ''}`;
  document.getElementById('bulkRoleModal').classList.remove('hidden');
}

function closeBulkRoleModal() {
  document.getElementById('bulkRoleModal').classList.add('hidden');
  document.getElementById('bulkRoleForm').reset();
}

function openBulkCreditsModal() {
  const checkboxes = document.querySelectorAll('.userCheckbox:checked');
  const count = checkboxes.length;
  document.getElementById('bulkCreditsCount').textContent = `Update credits for ${count} user${count > 1 ? 's' : ''}`;
  document.getElementById('bulkCreditsModal').classList.remove('hidden');
}

function closeBulkCreditsModal() {
  document.getElementById('bulkCreditsModal').classList.add('hidden');
  document.getElementById('bulkCreditsForm').reset();
}

 function bulkDelete() {
   const checkboxes = document.querySelectorAll('.userCheckbox:checked');
   const count = checkboxes.length;

   Toast.warning(`Are you sure you want to delete ${count} user${count > 1 ? 's' : ''}? This action cannot be undone.`);
   const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

   // Delete users one by one
   Promise.all(userIds.map(userId =>
     fetch(`/admin/api/users/${userId}`, {
       method: 'DELETE',
       headers: {
         'Content-Type': 'application/json',
       },
     }).then(response => response.json())
   )).then(results => {
     const successCount = results.filter(r => r.success).length;
     Toast.success(`Successfully deleted ${successCount} out of ${count} users`);
     location.reload();
   });
 }

 function deleteUser(userId, userName) {
   Toast.warning(`Are you sure you want to delete user ${userName}? This action cannot be undone.`);
   fetch(`/admin/api/users/${userId}`, {
     method: 'DELETE',
     headers: {
       'Content-Type': 'application/json',
     },
   })
   .then(response => response.json())
   .then(data => {
     if (data.success) {
       location.reload();
     } else {
       Toast.error('Error deleting user: ' + data.error);
     }
   });
 }

// Form handlers
document.getElementById('editUserForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const userId = document.getElementById('editUserId').value;
  const role = document.getElementById('editUserRole').value;

  fetch(`/admin/api/users/${userId}/role`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ role }),
  })
  .then(response => response.json())
   .then(data => {
     if (data.success) {
       closeEditModal();
       location.reload();
     } else {
       Toast.error('Error updating user: ' + data.error);
     }
   });
});

document.getElementById('creditsForm').addEventListener('submit', function(e) {
  e.preventDefault();

  clearFormErrors('creditsForm');

  const userId = document.getElementById('creditsUserId').value;
  const credits = parseInt(document.getElementById('newCredits').value);

  // Validation
  if (isNaN(credits) || credits < 0) {
    showFormErrors('creditsForm', { newCredits: 'Please enter a valid number of credits (0 or more)' });
    return;
  }

  fetch(`/admin/api/users/${userId}/credits`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ credits }),
  })
  .then(response => response.json())
   .then(data => {
     if (data.success) {
       closeCreditsModal();
       location.reload();
     } else {
       Toast.error('Error updating credits: ' + data.error);
     }
   })
   .catch(error => {
     Toast.error('Network error occurred. Please try again.');
   });
});

document.getElementById('banForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const userId = document.getElementById('banUserId').value;
  const action = document.getElementById('banAction').value;
  const reason = document.getElementById('banReason').value;

  const banned = action === 'ban';

  fetch(`/admin/api/users/${userId}/banned`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ banned, reason }),
  })
  .then(response => response.json())
   .then(data => {
     if (data.success) {
       closeBanModal();
       location.reload();
     } else {
       Toast.error('Error updating ban status: ' + data.error);
     }
   });
});

document.getElementById('createUserForm').addEventListener('submit', function(e) {
  e.preventDefault();

  // Clear previous errors
  clearFormErrors('createUserForm');

  const email = document.getElementById('createUserEmail').value.trim();
  const firstName = document.getElementById('createUserFirstName').value.trim();
  const lastName = document.getElementById('createUserLastName').value.trim();
  const password = document.getElementById('createUserPassword').value;
  const role = document.getElementById('createUserRole').value;
  const credits = parseInt(document.getElementById('createUserCredits').value) || 0;

  // Client-side validation
  let isValid = true;
  const errors = {};

  if (!email || !email.includes('@')) {
    errors.email = 'Please enter a valid email address';
    isValid = false;
  }

  if (!firstName || firstName.length < 2) {
    errors.firstName = 'First name must be at least 2 characters';
    isValid = false;
  }

  if (!lastName || lastName.length < 2) {
    errors.lastName = 'Last name must be at least 2 characters';
    isValid = false;
  }

  if (!password || password.length < 6) {
    errors.password = 'Password must be at least 6 characters';
    isValid = false;
  }

  if (credits < 0) {
    errors.credits = 'Credits cannot be negative';
    isValid = false;
  }

  if (!isValid) {
    showFormErrors('createUserForm', errors);
    return;
  }

  fetch('/admin/api/users', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ email, firstName, lastName, password, role, credits }),
  })
  .then(response => response.json())
   .then(data => {
     if (data.success) {
       closeCreateUserModal();
       location.reload();
     } else {
       Toast.error('Error creating user: ' + data.error);
     }
   })
   .catch(error => {
     Toast.error('Network error occurred. Please try again.');
  });
});

// Initialize controls from URL params
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const limit = urlParams.get('limit') || '20';
  const role = urlParams.get('role') || '';
  const search = urlParams.get('search') || '';

  // Note: rowsPerPage select removed, using pagination dropdown instead
  document.getElementById('roleFilter').value = role;
  document.getElementById('searchInput').value = search;
});

// Handle page size changes from pagination dropdown
document.addEventListener('click', function(e) {
  if (e.target.closest('.page-list .dropdown-menu a')) {
    e.preventDefault();
    const limit = e.target.textContent.trim();
    const url = new URL(window.location);
    url.searchParams.set('limit', limit);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
  }
});
</script>
    </div>
  </div>