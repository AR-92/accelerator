{{> ui/_data-table
  title="Users"
  description="Manage and oversee all user accounts in the system"
  headers=(array
    (hash key="user" label="User")
    (hash key="role" label="Role")
    (hash key="status" label="Status")
    (hash key="credits" label="Credits" class="hidden md:table-cell")
    (hash key="createdAt" label="Created" class="hidden lg:table-cell")
  )
  rows=users
  showCheckbox=true
  showActions=true
  actions=userActions
  filterBar=(hash
    searchPlaceholder="Search users..."
    searchValue=filters.search
    actions=(array
      (hash onclick="exportToCSV()" icon="Download" title="Export CSV")
      (hash onclick="location.reload()" icon="RefreshCw" title="Refresh")
      (hash icon="List" title="View Options")
    )
  )
  navTabs=(hash
    tabs=(array
      (hash text="All Users" value="" param="?")
      (hash text="Startups" value="startup" param="?role=")
      (hash text="Corporate" value="corporate" param="?role=")
      (hash text="Enterprise" value="enterprise" param="?role=")
      (hash text="Admins" value="admin" param="?role=")
    )
    activeTab=filters.role
    baseUrl="/admin/users"
  )
  bulkActions=(array
    (hash text="Update Role" onclick="openBulkRoleModal()" buttonId="bulkRoleBtn")
    (hash text="Update Credits" onclick="openBulkCreditsModal()" buttonId="bulkCreditsBtn")
    (hash text="Delete Selected" onclick="bulkDelete()" buttonId="bulkDeleteBtn")
  )
  pagination=pagination
  headerActions=(array
    (hash text="Create User" icon="UserPlus" onclick="openCreateUserModal()")
  )
  queryParams=(concat "?role=" filters.role "&search=" filters.search)
}}

<!-- Include modal templates -->
{{> modals/_edit-user-modal}}
{{> modals/_create-user-modal}}
{{> modals/_credits-modal}}
{{> modals/_ban-modal}}
{{> modals/_bulk-role-modal}}
{{> modals/_bulk-credits-modal}}

<script>
  // Helper functions for date formatting
  function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
  }

  function range(start, end) {
    const result = [];
    for (let i = start; i <= end; i++) {
      result.push(i);
    }
    return result;
  }

  // Modal functions
  function editUser(userId) {
    // Fetch user data and populate modal
    fetch(`/admin/api/users/${userId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('editUserId').value = data.user.id;
          document.getElementById('editUserRole').value = data.user.role;
          document.getElementById('editUserModal').classList.remove('hidden');
        }
      });
  }

  function closeEditModal() {
    document.getElementById('editUserModal').classList.add('hidden');
  }

  function manageCredits(userId, userName, currentCredits) {
    document.getElementById('creditsUserId').value = userId;
    document.getElementById('creditsUserName').textContent = `User: ${userName}`;
    document.getElementById('currentCredits').textContent = currentCredits;
    document.getElementById('newCredits').value = currentCredits;
    document.getElementById('creditsModal').classList.remove('hidden');
  }

  function closeCreditsModal() {
    document.getElementById('creditsModal').classList.add('hidden');
  }

  function toggleStatus(userId, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    const action = newStatus === 'active' ? 'activate' : 'deactivate';

    Toast.warning(`Are you sure you want to ${action} this user?`);
    fetch(`/admin/api/users/${userId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ status: newStatus }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          Toast.error('Error updating user status: ' + data.error);
        }
      });
  }

  function toggleBan(userId, currentlyBanned, userName) {
    document.getElementById('banUserId').value = userId;
    document.getElementById('banUserName').textContent = `User: ${userName}`;
    document.getElementById('banAction').value = currentlyBanned ? 'unban' : 'ban';

    if (currentlyBanned) {
      document.getElementById('banModalTitle').textContent = 'Unban User';
      document.getElementById('banReasonDiv').style.display = 'none';
      document.getElementById('banSubmitBtn').textContent = 'Unban User';
      document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-destructive', 'bg-green-600').replace('hover:bg-destructive/90', 'hover:bg-green-700');
    } else {
      document.getElementById('banModalTitle').textContent = 'Ban User';
      document.getElementById('banReasonDiv').style.display = 'block';
      document.getElementById('banSubmitBtn').textContent = 'Ban User';
      document.getElementById('banSubmitBtn').className = document.getElementById('banSubmitBtn').className.replace('bg-green-600', 'bg-destructive').replace('hover:bg-green-700', 'hover:bg-destructive/90');
    }

    document.getElementById('banModal').classList.remove('hidden');
  }

  function closeBanModal() {
    document.getElementById('banModal').classList.add('hidden');
  }

  function openCreateUserModal() {
    document.getElementById('createUserModal').classList.remove('hidden');
  }

  function closeCreateUserModal() {
    document.getElementById('createUserModal').classList.add('hidden');
    document.getElementById('createUserForm').reset();
  }

  // Bulk actions functions
  function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.userCheckbox:checked');
    const count = checkboxes.length;
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');

    if (count > 0) {
      bulkActions.style.display = 'block';
      selectedCount.textContent = `${count} user${count > 1 ? 's' : ''} selected`;
      document.getElementById('bulkRoleBtn').disabled = false;
      document.getElementById('bulkCreditsBtn').disabled = false;
      document.getElementById('bulkDeleteBtn').disabled = false;
    } else {
      bulkActions.style.display = 'none';
      document.getElementById('bulkRoleBtn').disabled = true;
      document.getElementById('bulkCreditsBtn').disabled = true;
      document.getElementById('bulkDeleteBtn').disabled = true;
    }
  }

  function openBulkRoleModal() {
    const checkboxes = document.querySelectorAll('.userCheckbox:checked');
    const count = checkboxes.length;
    document.getElementById('bulkRoleCount').textContent = `Update role for ${count} user${count > 1 ? 's' : ''}`;
    document.getElementById('bulkRoleModal').classList.remove('hidden');
  }

  function closeBulkRoleModal() {
    document.getElementById('bulkRoleModal').classList.add('hidden');
    document.getElementById('bulkRoleForm').reset();
  }

  function openBulkCreditsModal() {
    const checkboxes = document.querySelectorAll('.userCheckbox:checked');
    const count = checkboxes.length;
    document.getElementById('bulkCreditsCount').textContent = `Update credits for ${count} user${count > 1 ? 's' : ''}`;
    document.getElementById('bulkCreditsModal').classList.remove('hidden');
  }

  function closeBulkCreditsModal() {
    document.getElementById('bulkCreditsModal').classList.add('hidden');
    document.getElementById('bulkCreditsForm').reset();
  }

  function bulkDelete() {
    const checkboxes = document.querySelectorAll('.userCheckbox:checked');
    const count = checkboxes.length;

    Toast.warning(`Are you sure you want to delete ${count} user${count > 1 ? 's' : ''}? This action cannot be undone.`);
    const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

    // Delete users one by one
    Promise.all(userIds.map(userId =>
      fetch(`/admin/api/users/${userId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(response => response.json())
    )).then(results => {
      const successCount = results.filter(r => r.success).length;
      Toast.success(`Successfully deleted ${successCount} out of ${count} users`);
      location.reload();
    });
  }

  function deleteUser(userId, userName) {
    Toast.warning(`Are you sure you want to delete user ${userName}? This action cannot be undone.`);
    fetch(`/admin/api/users/${userId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          Toast.error('Error deleting user: ' + data.error);
        }
      });
  }

  // Form handlers
  document.getElementById('editUserForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const userId = document.getElementById('editUserId').value;
    const role = document.getElementById('editUserRole').value;

    fetch(`/admin/api/users/${userId}/role`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ role }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeEditModal();
          location.reload();
        } else {
          Toast.error('Error updating user: ' + data.error);
        }
      });
  });

  document.getElementById('creditsForm').addEventListener('submit', function (e) {
    e.preventDefault();

    clearFormErrors('creditsForm');

    const userId = document.getElementById('creditsUserId').value;
    const credits = parseInt(document.getElementById('newCredits').value);

    // Validation
    if (isNaN(credits) || credits < 0) {
      showFormErrors('creditsForm', { newCredits: 'Please enter a valid number of credits (0 or more)' });
      return;
    }

    fetch(`/admin/api/users/${userId}/credits`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ credits }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeCreditsModal();
          location.reload();
        } else {
          Toast.error('Error updating credits: ' + data.error);
        }
      })
      .catch(error => {
        Toast.error('Network error occurred. Please try again.');
      });
  });

  document.getElementById('banForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const userId = document.getElementById('banUserId').value;
    const action = document.getElementById('banAction').value;
    const reason = document.getElementById('banReason').value;

    const banned = action === 'ban';

    fetch(`/admin/api/users/${userId}/banned`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ banned, reason }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeBanModal();
          location.reload();
        } else {
          Toast.error('Error updating ban status: ' + data.error);
        }
      });
  });

  document.getElementById('createUserForm').addEventListener('submit', function (e) {
    e.preventDefault();

    // Clear previous errors
    clearFormErrors('createUserForm');

    const email = document.getElementById('createUserEmail').value.trim();
    const firstName = document.getElementById('createUserFirstName').value.trim();
    const lastName = document.getElementById('createUserLastName').value.trim();
    const password = document.getElementById('createUserPassword').value;
    const role = document.getElementById('createUserRole').value;
    const credits = parseInt(document.getElementById('createUserCredits').value) || 0;

    // Client-side validation
    let isValid = true;
    const errors = {};

    if (!email || !email.includes('@')) {
      errors.email = 'Please enter a valid email address';
      isValid = false;
    }

    if (!firstName || firstName.length < 2) {
      errors.firstName = 'First name must be at least 2 characters';
      isValid = false;
    }

    if (!lastName || lastName.length < 2) {
      errors.lastName = 'Last name must be at least 2 characters';
      isValid = false;
    }

    if (!password || password.length < 6) {
      errors.password = 'Password must be at least 6 characters';
      isValid = false;
    }

    if (credits < 0) {
      errors.credits = 'Credits cannot be negative';
      isValid = false;
    }

    if (!isValid) {
      showFormErrors('createUserForm', errors);
      return;
    }

    fetch('/admin/api/users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email, firstName, lastName, password, role, credits }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeCreateUserModal();
          location.reload();
        } else {
          Toast.error('Error creating user: ' + data.error);
        }
      })
      .catch(error => {
        Toast.error('Network error occurred. Please try again.');
      });
  });

  // Initialize controls from URL params
  document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const limit = urlParams.get('limit') || '20';
    const role = urlParams.get('role') || '';
    const search = urlParams.get('search') || '';

    document.getElementById('rowsPerPage').value = limit;
    document.getElementById('searchInput').value = search;
  });

  // Handle rows per page changes
  document.getElementById('rowsPerPage').addEventListener('change', function () {
    const limit = this.value;
    const url = new URL(window.location);
    url.searchParams.set('limit', limit);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
  });

  // Handle search input
  document.getElementById('searchInput').addEventListener('keyup', function (e) {
    if (e.key === 'Enter') {
      const search = this.value;
      const url = new URL(window.location);
      url.searchParams.set('search', search);
      url.searchParams.set('page', '1');
      window.location.href = url.toString();
    }
  });

// Action menu functions
function toggleActionMenu(userId) {
  const menu = document.getElementById(`actionMenu-${userId}`);
  // Hide other menus
  document.querySelectorAll('.dropdown-menu').forEach(m => {
    if (m !== menu) m.classList.add('hidden');
  });
  menu.classList.toggle('hidden');
}

// Close menus when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.relative')) {
    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));
  }
});
</script>
</div>
</div>