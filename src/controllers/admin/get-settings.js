import logger from '../../utils/logger.js';
import config from '../../config/index.js';

// Admin Settings
export const getSettings = async (req, res) => {
  try {
    logger.info('Admin settings page accessed');

    // Load settings from config with fallbacks
    const settings = {
      general: {
        siteName: process.env.SITE_NAME || 'Accelerator',
        siteDescription:
          process.env.SITE_DESCRIPTION || 'Project Management Platform',
        defaultLanguage: process.env.DEFAULT_LANGUAGE || 'en',
        timezone: process.env.TIMEZONE || 'UTC',
      },
      server: {
        clusterMode: config.clusterMode,
        maxWorkers: config.maxWorkers,
        healthCheckInterval: config.healthCheckInterval,
        gracefulShutdownTimeout: config.gracefulShutdownTimeout,
        requestTimeoutGlobal: config.requestTimeoutGlobal,
        compressionLevel: config.compressionLevel,
        staticCacheMaxAge: config.staticCacheMaxAge,
        trustProxy: config.trustProxy,
      },
      database: {
        connectionRetryAttempts: config.database.connectionRetryAttempts,
        connectionRetryDelay: config.database.connectionRetryDelay,
        sslMode: config.database.sslMode,
        schemaVersion: config.database.schemaVersion,
        migrationPath: config.database.migrationPath,
        backupRetentionDays: config.database.backupRetentionDays,
        backupSchedule: config.database.backupSchedule,
        readReplicaUrls: config.database.readReplicaUrls,
        connectionPoolMin: config.database.connectionPoolMin,
        connectionPoolMax: config.database.connectionPoolMax,
        statementTimeout: config.database.statementTimeout,
        idleTimeout: config.database.idleTimeout,
      },
      security: {
        twoFactorAuth: process.env.TWO_FACTOR_AUTH === 'true',
        sessionTimeout: parseInt(process.env.SESSION_TIMEOUT) || 60,
        passwordPolicy: process.env.PASSWORD_POLICY !== 'false',
        minPasswordLength: parseInt(process.env.MIN_PASSWORD_LENGTH) || 8,
        authProviders: config.auth.providers,
        passwordResetTokenExpires: config.auth.passwordResetTokenExpires,
        accountLockoutDuration: config.auth.accountLockoutDuration,
        bruteForceProtectionThreshold:
          config.auth.bruteForceProtectionThreshold,
        ipWhitelist: config.auth.ipWhitelist,
        ipBlacklist: config.auth.ipBlacklist,
        sessionCookieSecure: config.auth.sessionCookieSecure,
        sessionCookieHttpOnly: config.auth.sessionCookieHttpOnly,
        csrfProtectionEnabled: config.auth.csrfProtectionEnabled,
        apiKeyRotationPeriod: config.auth.apiKeyRotationPeriod,
        mfaBackupCodesCount: config.auth.mfaBackupCodesCount,
        passwordHistoryCount: config.auth.passwordHistoryCount,
        accountDeactivationGracePeriod:
          config.auth.accountDeactivationGracePeriod,
      },
      email: {
        provider: config.email.provider,
        smtpHost: process.env.SMTP_HOST || 'smtp.gmail.com',
        smtpPort: parseInt(process.env.SMTP_PORT) || 587,
        smtpUsername: process.env.SMTP_USERNAME || 'noreply@accelerator.com',
        smtpPassword: '••••••••', // Never expose actual password
        emailNotifications: process.env.EMAIL_NOTIFICATIONS !== 'false',
        fromName: config.email.fromName,
        fromAddress: config.email.fromAddress,
        templatesPath: config.email.templatesPath,
        queueSize: config.email.queueSize,
        retryAttempts: config.email.retryAttempts,
        webhookSecret: config.email.webhookSecret ? '••••••••' : '',
        notificationChannels: config.email.notificationChannels,
        slackWebhookUrl: config.email.slackWebhookUrl ? '••••••••' : '',
        discordWebhookUrl: config.email.discordWebhookUrl ? '••••••••' : '',
        pushNotificationKeys: config.email.pushNotificationKeys
          ? '••••••••'
          : '',
        batchSize: config.email.batchSize,
        rateLimitPerHour: config.email.rateLimitPerHour,
      },
      ui: {
        customCssUrl: config.ui.customCssUrl,
        logoUrl: config.ui.logoUrl,
        faviconUrl: config.ui.faviconUrl,
        primaryColor: config.ui.primaryColor,
        accentColor: config.ui.accentColor,
        fontFamily: config.ui.fontFamily,
        sidebarCollapsedDefault: config.ui.sidebarCollapsedDefault,
        itemsPerPageDefault: config.ui.itemsPerPageDefault,
        timezoneDisplayFormat: config.ui.timezoneDisplayFormat,
        numberFormatLocale: config.ui.numberFormatLocale,
        currencySymbol: config.ui.currencySymbol,
        dateTimeFormatPreferences: config.ui.dateTimeFormatPreferences,
      },
      performance: {
        redisUrl: config.performance.redisUrl ? '••••••••' : '',
        cacheStrategy: config.performance.cacheStrategy,
        cacheCompressionEnabled: config.performance.cacheCompressionEnabled,
        cdnUrl: config.performance.cdnUrl,
        staticAssetsVersion: config.performance.staticAssetsVersion,
        apiResponseCacheTtl: config.performance.apiResponseCacheTtl,
        databaseQueryCacheTtl: config.performance.databaseQueryCacheTtl,
        sessionStoreType: config.performance.sessionStoreType,
        rateLimitStoreType: config.performance.rateLimitStoreType,
        fileUploadMaxSize: config.performance.fileUploadMaxSize,
        imageOptimizationQuality: config.performance.imageOptimizationQuality,
      },
      logging: {
        format: config.logging.format,
        maxSize: config.logging.maxSize,
        maxFiles: config.logging.maxFiles,
        transports: config.logging.transports,
        sentryDsn: config.logging.sentryDsn ? '••••••••' : '',
        newRelicLicenseKey: config.logging.newRelicLicenseKey ? '••••••••' : '',
        datadogApiKey: config.logging.datadogApiKey ? '••••••••' : '',
        prometheusMetricsEnabled: config.logging.prometheusMetricsEnabled,
        healthCheckEndpoints: config.logging.healthCheckEndpoints,
        errorReportingLevel: config.logging.errorReportingLevel,
        auditLogRetentionDays: config.logging.auditLogRetentionDays,
      },
      api: {
        versioningStrategy: config.api.versioningStrategy,
        webhookSecret: config.api.webhookSecret ? '••••••••' : '',
        thirdPartyApiKeys:
          Object.keys(config.api.thirdPartyApiKeys).length > 0
            ? 'Configured'
            : 'Not configured',
        integrationEndpoints:
          Object.keys(config.api.integrationEndpoints).length > 0
            ? 'Configured'
            : 'Not configured',
        documentationEnabled: config.api.documentationEnabled,
        graphqlEnabled: config.api.graphqlEnabled,
        restApiEnabled: config.api.restApiEnabled,
        websocketEnabled: config.api.websocketEnabled,
        fileStorageProvider: config.api.fileStorageProvider,
        smsProvider: config.api.smsProvider,
      },
      business: {
        projectStatusWorkflow: config.business.projectStatusWorkflow,
        businessModelTemplates: config.business.businessModelTemplates,
        financialCurrencyDefault: config.business.financialCurrencyDefault,
        learningModuleSequence: config.business.learningModuleSequence,
        contentApprovalWorkflow: config.business.contentApprovalWorkflow,
        collaborationToolsEnabled: config.business.collaborationToolsEnabled,
        billingCycleDefault: config.business.billingCycleDefault,
        enterpriseFeaturesEnabled: config.business.enterpriseFeaturesEnabled,
        customWorkflowEngines: config.business.customWorkflowEngines,
        automationRules: config.business.automationRules,
        kpiDashboardConfig: config.business.kpiDashboardConfig,
        reportGenerationSchedule: config.business.reportGenerationSchedule,
      },
      userManagement: {
        rolesDefinitions: config.userManagement.rolesDefinitions,
        permissionMatrix: config.userManagement.permissionMatrix,
        onboardingFlow: config.userManagement.onboardingFlow,
        profileCompletionRequirements:
          config.userManagement.profileCompletionRequirements,
        teamHierarchyEnabled: config.userManagement.teamHierarchyEnabled,
        invitationExpiry: config.userManagement.invitationExpiry,
        bulkImportEnabled: config.userManagement.bulkImportEnabled,
        deactivationPolicy: config.userManagement.deactivationPolicy,
        profilePictureMaxSize: config.userManagement.profilePictureMaxSize,
        bioCharacterLimit: config.userManagement.bioCharacterLimit,
      },
      backup: {
        storageLocation: config.backup.storageLocation,
        encryptionKey: config.backup.encryptionKey ? '••••••••' : '',
        maintenanceWindowSchedule: config.backup.maintenanceWindowSchedule,
        autoUpdateEnabled: config.backup.autoUpdateEnabled,
        dependencyUpdateSchedule: config.backup.dependencyUpdateSchedule,
        databaseMaintenanceScripts: config.backup.databaseMaintenanceScripts,
        logRotationPolicy: config.backup.logRotationPolicy,
        tempFileCleanupInterval: config.backup.tempFileCleanupInterval,
        cacheInvalidationSchedule: config.backup.cacheInvalidationSchedule,
      },
      compliance: {
        gdprComplianceEnabled: config.compliance.gdprComplianceEnabled,
        dataRetentionPolicies: config.compliance.dataRetentionPolicies,
        cookieConsentRequired: config.compliance.cookieConsentRequired,
        privacyPolicyUrl: config.compliance.privacyPolicyUrl,
        termsOfServiceUrl: config.compliance.termsOfServiceUrl,
        dataExportEnabled: config.compliance.dataExportEnabled,
        rightToForgetImplemented: config.compliance.rightToForgetImplemented,
        auditTrailEnabled: config.compliance.auditTrailEnabled,
        complianceReportingSchedule:
          config.compliance.complianceReportingSchedule,
        legalHoldEnabled: config.compliance.legalHoldEnabled,
      },
      ai: {
        provider: config.ai.provider,
        modelDefault: config.ai.modelDefault,
        apiKey: config.ai.apiKey ? '••••••••' : '',
        apiBaseUrl: config.ai.apiBaseUrl,
        temperature: config.ai.temperature,
        maxTokens: config.ai.maxTokens,
        timeout: config.ai.timeout,
        retryAttempts: config.ai.retryAttempts,
        rateLimitRequests: config.ai.rateLimitRequests,
        rateLimitTokens: config.ai.rateLimitTokens,
        agentTypesEnabled: config.ai.agentTypesEnabled,
        agentPersonality: config.ai.agentPersonality,
        agentLanguage: config.ai.agentLanguage,
        agentMemorySize: config.ai.agentMemorySize,
        agentToolsEnabled: config.ai.agentToolsEnabled,
        agentAutonomyLevel: config.ai.agentAutonomyLevel,
        agentResponseFormat: config.ai.agentResponseFormat,
        contentGenerationEnabled: config.ai.contentGenerationEnabled,
        contentModerationLevel: config.ai.contentModerationLevel,
        contentSafetyFilters: config.ai.contentSafetyFilters,
        contentBrandingVoice: config.ai.contentBrandingVoice,
        contentLengthPreferences: config.ai.contentLengthPreferences,
        contentTemplates: config.ai.contentTemplates,
        contentReviewRequired: config.ai.contentReviewRequired,
        biAnalyticsEnabled: config.ai.biAnalyticsEnabled,
        biDataSources: config.ai.biDataSources,
        biReportFrequency: config.ai.biReportFrequency,
        biInsightThreshold: config.ai.biInsightThreshold,
        biPredictionHorizon: config.ai.biPredictionHorizon,
        biMetricsTracking: config.ai.biMetricsTracking,
        biAlertThresholds: config.ai.biAlertThresholds,
        learningAdaptationEnabled: config.ai.learningAdaptationEnabled,
        userFeedbackCollection: config.ai.userFeedbackCollection,
        modelFineTuningSchedule: config.ai.modelFineTuningSchedule,
        personalizationLevel: config.ai.personalizationLevel,
        contextAwareness: config.ai.contextAwareness,
        multiModalEnabled: config.ai.multiModalEnabled,
        dataRetention: config.ai.dataRetention,
        dataAnonymization: config.ai.dataAnonymization,
        usageAuditLog: config.ai.usageAuditLog,
        contentWatermarking: config.ai.contentWatermarking,
        biasMonitoring: config.ai.biasMonitoring,
        complianceMode: config.ai.complianceMode,
        fallbackMode: config.ai.fallbackMode,
        costTrackingEnabled: config.ai.costTrackingEnabled,
        costBudgetMonthly: config.ai.costBudgetMonthly,
        performanceMetrics: config.ai.performanceMetrics,
        cacheAiResponses: config.ai.cacheAiResponses,
        loadBalancing: config.ai.loadBalancing,
        fallbackProvider: config.ai.fallbackProvider,
        workflowAutomationEnabled: config.ai.workflowAutomationEnabled,
        triggerConditions: config.ai.triggerConditions,
        integrationWebhooks: config.ai.integrationWebhooks,
        apiRateLimitAi: config.ai.apiRateLimitAi,
        schedulerEnabled: config.ai.schedulerEnabled,
        notificationAiEvents: config.ai.notificationAiEvents,
      },
    };

    // Settings categories for filter navigation
    const settingsCategories = [
      { value: 'all', label: 'All Settings', icon: 'settings' },
      { value: 'general', label: 'General', icon: 'settings' },
      { value: 'server', label: 'Server', icon: 'server' },
      { value: 'database', label: 'Database', icon: 'database' },
      { value: 'security', label: 'Security', icon: 'shield' },
      { value: 'email', label: 'Email', icon: 'mail' },
      { value: 'ui', label: 'UI & Appearance', icon: 'palette' },
      { value: 'performance', label: 'Performance', icon: 'zap' },
      { value: 'logging', label: 'Logging', icon: 'file-text' },
      { value: 'business', label: 'Business Logic', icon: 'building' },
      { value: 'userManagement', label: 'User Management', icon: 'users' },
      { value: 'backup', label: 'Backup', icon: 'hard-drive' },
      { value: 'compliance', label: 'Compliance', icon: 'check-circle' },
      { value: 'ai', label: 'AI & LLM', icon: 'brain' },
      { value: 'api', label: 'API', icon: 'code' },
    ];

    // Get active category from query param or default to 'all'
    const activeCategory = req.query.category || 'all';

    res.render('admin/other-pages/settings', {
      title: 'Admin Settings',
      currentPage: 'settings',
      currentSection: 'system',
      settings,
      settingsCategories,
      activeCategory,
    });
  } catch (error) {
    logger.error('Error loading admin settings:', error);
    res.render('admin/other-pages/settings', {
      title: 'Admin Settings',
      currentPage: 'settings',
      currentSection: 'system',
      settings: {},
    });
  }
};
